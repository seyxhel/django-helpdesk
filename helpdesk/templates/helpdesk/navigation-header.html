{% load i18n helpdesk_staff %}

    {% include 'helpdesk/custom_navigation_header.html' %}

  <nav class="navbar navbar-expand static-top" style="background-color: #000C7D;">

  <div class="d-flex align-items-center">
      <button class="btn btn-link btn-sm text-white order-1 order-sm-0 sidebar-toggle-btn" id="sidebarToggle" href="#" aria-controls="helpdesk-sidebar" aria-expanded="false" aria-label="Toggle sidebar">
        <i class="fas fa-bars" aria-hidden="true"></i>
      </button>
  <a class="navbar-brand" href="{% url 'helpdesk:dashboard' %}" style="color: white; text-decoration: none; font-size: 16px; font-weight: 700; font-family: 'Montserrat', sans-serif; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: none; margin-left: 5px;">{% trans 'PrimeDesk Technologies' %}</a>
  </div>
  <div class="ml-auto d-flex align-items-center">
      {% if helpdesk_settings.HELPDESK_NAVIGATION_ENABLED and user.is_authenticated or user|is_helpdesk_staff %}
  <!-- Navbar Search (professional) -->
  <form class="d-none d-md-inline-block form-inline ml-2 my-2 my-md-0" id="searchform" method="get" action="{% url 'helpdesk:list' %}" role="search" aria-label="{% trans 'Search tickets' %}">
        <label for="search_query" class="sr-only">{% trans "Search tickets" %}</label>
        <div class="input-group search-pill align-items-center">
          <div class="search-input-wrap" style="width:360px;">
            <span class="input-group-text search-icon bg-transparent border-0 text-white">
              <i class="fas fa-search" aria-hidden="true"></i>
            </span>
            <input type="search" id="search_query" name="q" class="form-control rounded-pill search-input" placeholder="{% trans "Search tickets or #12345..." %}" title="{% trans "Enter a keyword, or a ticket number to jump straight to that ticket." %}" aria-label="{% trans 'Search tickets' %}">
            <input type='hidden' name='status' value='1' />
            <input type='hidden' name='status' value='2' />
            <input type='hidden' name='status' value='3' />
            <input type='hidden' name='search_type' value='header' />

            <!-- Buttons moved inside the input (visually) -->
            <button class="btn btn-link text-white clear-btn" type="button" id="search_clear" title="{% trans 'Clear search' %}" onclick="document.getElementById('search_query').value='';document.getElementById('search_query').focus();">
              <i class="fas fa-times"></i>
            </button>
            <button class="btn btn-primary submit-btn" type="submit" title="{% trans 'Search' %}">
              <span class="d-none d-sm-inline">{% trans 'Go' %}</span>
            </button>
          </div>
        </div>
        {% csrf_token %}
      </form>
      {% endif %}

      
      <!-- Navbar -->
      <ul class="navbar-nav mr-md-0">
      {% if helpdesk_settings.HELPDESK_NAVIGATION_ENABLED and user.is_authenticated or user|is_helpdesk_staff %}
        {% if user_saved_queries_ %}
        <li class="nav-item dropdown no-arrow mx-1">
          <!-- Toggle for saved queries dropdown (was missing, making the menu non-interactive) -->
          <a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
            <span class="sr-only">{% trans "Saved Queries" %}</span>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="alertsDropdown">
            {% for q in user_saved_queries_ %}
                <a class="dropdown-item" href="{% url 'helpdesk:list' %}?saved_query={{ q.id }}">{{ q.title }}
                    {% if q.shared %}
                    (Shared{% if user != q.user %} by {{ q.user.get_username }}{% endif %})
                    {% endif %}
                </a>
            {% endfor %}
          </div>
        </li>
        {% endif %}
        <li class="nav-item dropdown no-arrow">
          <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-user-circle fa-fw"></i>
            <span class="nav-username">{{ user.get_full_name|default:user.get_username }}</span>
            <i class="fas fa-caret-down fa-fw nav-caret"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
            <!-- Profile header -->
            <div class="dropdown-profile-header px-3 py-2 d-flex align-items-center">
              <div class="avatar-circle mr-2" aria-hidden="true">{{ user.get_full_name|default:user.get_username|slice:":1"|upper }}</div>
              <div class="profile-meta">
                <div class="profile-name">{{ user.get_full_name|default:user.get_username }}</div>
                {% if user.email %}<div class="profile-email text-muted small">{{ user.email }}</div>{% endif %}
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="{% url 'helpdesk:user_settings' %}"><i class="fas fa-fw fa-user-cog"></i> {% trans "User Settings" %}</a>
            <a class="dropdown-item" href='{% url 'helpdesk:rss_index' %}'><i class="fas fa-fw fa-rss-square"></i> {% trans "RSS Feeds" %}</a>
            {% if helpdesk_settings.HELPDESK_SHOW_CHANGE_PASSWORD and user.has_usable_password %}
            <a class="dropdown-item" href="{% url 'helpdesk:password_change' %}"><i class="fas fa-fw fa-user-secret"></i> {% trans "Change password" %}</a>
            {% endif %}
            <div class="dropdown-divider"></div>
            {% if user.is_superuser %}
            <a class="dropdown-item" href='{% url 'helpdesk:system_settings' %}'><i class="fas fa-fw fa-cogs"></i> {% trans "System Settings" %}</a>
            <div class="dropdown-divider"></div>
            {% endif %}
            <form action="{% url 'helpdesk:logout' %}" method="post">{% csrf_token %}
                <button type="submit" class="dropdown-item">
                  <i class="fas fa-fw fa-sign-out-alt"></i> {% trans "Logout" %}
                </button>
            </form>
          </div>
        </li>
      {% else %}
        {% if helpdesk_settings.HELPDESK_ALLOW_NON_STAFF_TICKET_UPDATE %}
            <li class="nav-item dropdown no-arrow">
                <a class="nav-link dropdown-toggle" href="{% url 'helpdesk:dashboard' %}" id="userDropdown" role="button" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-user-circle fa-fw"></i> {% trans "Dashboard" %}
                </a>
            </li>
            <li class="nav-item dropdown no-arrow">
                <a class="nav-link dropdown-toggle" href="{% url 'helpdesk:submit' %}" id="userDropdown" role="button" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-user-circle fa-fw"></i> {% trans "Submit a Ticket" %}
                </a>
            </li>
        {% endif %}
        {% if not request.path == '/helpdesk/login/' or user.is_authenticated %}
      <div class="nav-item">
         <div class="nav-link">
           <span class="nav-username">{{user.username}}</span>
         </div>
      </div>
            <li class="nav-item">
              {% if user.is_authenticated %}
                <form action="{% url 'helpdesk:logout' %}" method="post">{% csrf_token %}
                    <button type="submit" class="btn btn-outline-secondary">
                      <i class="fas fa-fw fa-sign-out-alt"></i> {% trans "Logout" %}
                    </button>
                </form>
              {% else %}
                <a class="btn btn-outline-secondary" href="{% url 'helpdesk:login' %}?next={% if next %}{{ next|escape }}{% else %}{% url 'helpdesk:home' %}{% endif %}">
                  <i class="fas fa-fw fa-sign-in-alt"></i> {% trans "Log In" %}
                </a>
              {% endif %}
            </li>
        {% endif %}
      {% endif %}
      </ul>
  </div>

    </nav>
      <script>
      (function(){
        var btn = document.getElementById('sidebarToggle');
        if(!btn) return;
        btn.setAttribute('aria-expanded', 'true');
        btn.addEventListener('click', function(e){
          e.preventDefault();
          var sidebar = document.getElementById('helpdesk-sidebar');
          if(!sidebar) return;
          // toggle collapsed state (keeps icons visible)
          var collapsed = sidebar.classList.toggle('collapsed');
          // reflect state on body for layout tweaks
          document.body.classList.toggle('sidebar-collapsed', collapsed);
          btn.setAttribute('aria-expanded', String(!collapsed));
          // keep the icon static (do not swap to 'x')
        });
      })();
    </script>
      <script>
        (function(){
          // Lightweight dropdown polyfill for the user menu (works without relying on Bootstrap JS)
          var toggle = document.getElementById('userDropdown');
          if(!toggle) return;
          var parent = toggle.closest('.nav-item.dropdown');
          var menu = parent && parent.querySelector('.dropdown-menu');
          if(!menu) return;

          function open(){
            parent.classList.add('show');
            menu.classList.add('show');
            toggle.setAttribute('aria-expanded','true');
            // focus first actionable item in the menu
            var first = menu.querySelector('a, button, [tabindex]');
            if(first) first.focus();
          }
          function close(){
            parent.classList.remove('show');
            menu.classList.remove('show');
            toggle.setAttribute('aria-expanded','false');
            toggle.focus();
          }

          toggle.addEventListener('click', function(e){
            e.preventDefault();
            if(parent.classList.contains('show')) close(); else open();
          });

          // Close when clicking outside
          document.addEventListener('click', function(e){
            if(!parent.contains(e.target)){
              if(parent.classList.contains('show')) close();
            }
          });

          // Close on Escape
          document.addEventListener('keydown', function(e){
            if(e.key === 'Escape' && parent.classList.contains('show')) close();
          });
        })();
      </script>
