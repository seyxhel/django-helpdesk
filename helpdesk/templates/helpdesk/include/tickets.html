{% load i18n humanize ticket_extras query_filters %}

<style>
/* -------- General card / compact styles (existing) -------- */
.tickets-card-compact {
  margin: 8px auto 12px;           /* less top/bottom and side margin */
  max-width: 1100px;               /* keep a comfortable max width */
}
.tickets-card-compact .card-body {
  padding: 12px 14px;              /* tighter padding inside card */
}
.tickets-card-compact .tickets-filters {
  margin-bottom: 8px;
}
.tickets-card-compact .table-responsive-professional {
  margin: 0;
}
.tickets-card-compact .professional-table th,
.tickets-card-compact .professional-table td {
  padding: .45rem .6rem;           /* reduce cell padding for denser table */
  vertical-align: middle;
}
.tickets-card-compact .card-header { padding: .75rem 14px; }
.tickets-card-compact .card-footer { padding: .5rem 14px; font-size: .85rem; }

/* Reduce vertical gap between header text and the table */
.card-header {
  padding-bottom: 6px; /* tighten space under header */
}
.card-header .small.text-muted {
  margin-bottom: 0;
  line-height: 1.1;
  font-size: .85rem;
}
.card-body {
  padding-top: 8px; /* reduce space above card body */
}
.tickets-filters {
  margin: 0 0 6px 0 !important; /* remove large bottom margin from empty/compact filters */
}

/* -------- Professional table container & look -------- */
.table-responsive-professional {
  margin-top: 0;
  border: 1px solid rgba(15,23,42,0.06);   /* subtle outer border */
  border-radius: 10px;                      /* rounded container */
  overflow: hidden;
  background: #fff;
}

/* Base table behavior */
.professional-table {
  width: 100%;
  margin-bottom: 0;
  border-collapse: collapse; /* keep cells tight inside wrapper */
  background: transparent;
  font-size: 0.95rem;
}

/* Header style */
.professional-table thead th {
  background: linear-gradient(180deg, #f8f9fb 0%, #f4f6f8 100%);
  color: #0f1724;
  font-weight: 600;
  padding: 0.65rem 0.9rem;
  text-align: left;
  border-bottom: 1px solid rgba(15,23,42,0.06);
  vertical-align: middle;
}

/* Table cells */
.professional-table tbody td {
  padding: 0.55rem 0.9rem;
  vertical-align: middle;
  border-bottom: 1px solid rgba(15,23,42,0.04);
  color: #111827;
}

/* Remove final row divider for a cleaner bottom edge */
.professional-table tbody tr:last-child td {
  border-bottom: none;
}

/* Row hover and stripe */
.professional-table tbody tr:hover {
  background: rgba(11,94,215,0.03);
}
.professional-table.table-striped tbody tr:nth-of-type(odd) {
  background: rgba(0,0,0,0.02);
}

/* Ticket title link */
.tickettitle a { color: #0b5ed7; text-decoration: none; }
.tickettitle a:hover { text-decoration: underline; }

/* Compact table adjustments (used when compact_layout=True) */
.tickets-card-compact .professional-table thead th {
  padding: .45rem .6rem;
}
.tickets-card-compact .professional-table tbody td {
  padding: .45rem .6rem;
}

/* Small screens */
@media (max-width: 576px) {
  .professional-table thead th,
  .professional-table tbody td { padding: .5rem .6rem; }
}
/* ensure number input spinner arrows are visible */
input[type=number].helpdesk-show-spinner::-webkit-inner-spin-button,
input[type=number].helpdesk-show-spinner::-webkit-outer-spin-button { -webkit-appearance: auto; display: inline-block; }
input[type=number].helpdesk-show-spinner { appearance: auto; -webkit-appearance: auto; -moz-appearance: textfield; }
</style>

{# allow callers to request a rounded card for staff assigned tickets #}
{# add an optional compact layout by passing compact_layout=True #}
{% if assigned_card %}
  {% if compact_layout %}
    <div class="card mb-3 card-assigned-rounded tickets-card-compact">
  {% else %}
    <div class="card mb-3 card-assigned-rounded">
  {% endif %}
{% else %}
  {% if compact_layout %}
    <div class="card mb-3 tickets-card-compact">
  {% else %}
    <div class="card mb-3">
  {% endif %}
{% endif %}
  
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <i class="fas fa-table"></i>
      <strong>
        {% if ticket_list_caption %}{{ ticket_list_caption }}{% else %}{% trans "Your Tickets" %}{% endif %}
      </strong>
      <div class="small text-muted">{% trans "Use the controls to narrow results. Filters are applied when you submit." %}</div>
    </div>
  </div>
 
  <div class="card-body">
    <!-- Consolidated filter bar: appears before the table for clarity -->
    {% with page_size|default:ut_shown|default:utcr_shown|default:5 as page_size %}
    <div class="tickets-filters mb-3">
      {% if show_filters %}
        {# filter_namespace defaults to 'atrbcu' if not provided #}
        {% with filter_namespace|default:'atrbcu' as filter_namespace %}
  <form method="get" class="form-inline" aria-label="Ticket filters">
          <div class="form-row w-100">
            <div class="col-auto pr-2">
                <select name="{{ filter_namespace }}_queue" class="form-control form-control-sm">
                <option value="">All queues</option>
                {% if queues %}
                  {% for q in queues %}
                      {% with key=filter_namespace|stringformat:"s"|add:'_queue' %}
                        <option value="{{ q.id }}"{% if request.GET|get_param:key == q.id|stringformat:"s" %} selected{% endif %}>{{ q.title }}</option>
                      {% endwith %}
                  {% endfor %}
                {% endif %}
              </select>
            </div>
            <div class="col-auto pr-2">
                <select name="{{ filter_namespace }}_status" class="form-control form-control-sm">
                <option value="">All statuses</option>
                  {% for code,label in status_choices %}
                    {# for assigned (ut) exclude closed/resolved, for closed-resolved (utcr) show only closed/resolved if closed_status_only provided #}
                    {% if filter_namespace == 'ut' %}
                      {% if not assigned_status_exclude or not code in assigned_status_exclude %}
                        {% with key=filter_namespace|stringformat:"s"|add:'_status' %}
                          <option value="{{ code }}"{% if request.GET|get_param:key == code|stringformat:"s" %} selected{% endif %}>{{ label }}</option>
                        {% endwith %}
                      {% endif %}
                    {% elif filter_namespace == 'utcr' and closed_status_only %}
                      {% if code in closed_status_only %}
                        {% with key=filter_namespace|stringformat:"s"|add:'_status' %}
                          <option value="{{ code }}"{% if request.GET|get_param:key == code|stringformat:"s" %} selected{% endif %}>{{ label }}</option>
                        {% endwith %}
                      {% endif %}
                    {% elif filter_namespace == 'ut_open' and open_status_only %}
                      {% if code in open_status_only %}
                        {% with key=filter_namespace|stringformat:"s"|add:'_status' %}
                          <option value="{{ code }}"{% if request.GET|get_param:key == code|stringformat:"s" %} selected{% endif %}>{{ label }}</option>
                        {% endwith %}
                      {% endif %}
                    {% else %}
                      {% with key=filter_namespace|stringformat:"s"|add:'_status' %}
                        <option value="{{ code }}"{% if request.GET|get_param:key == code|stringformat:"s" %} selected{% endif %}>{{ label }}</option>
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
              </select>
            </div>
            <div class="col-auto pr-2">
                {% with key=filter_namespace|stringformat:"s"|add:'_order' %}
                <select name="{{ filter_namespace }}_order" class="form-control form-control-sm">
                  <option value="desc"{% if request.GET|get_param:key != 'asc' %} selected{% endif %}>{% trans "Newest" %}</option>
                  <option value="asc"{% if request.GET|get_param:key == 'asc' %} selected{% endif %}>{% trans "Oldest" %}</option>
                </select>
                {% endwith %}
            </div>
            {# numeric control to choose how many tickets to show (will auto-submit) #}
            {# hidden 'shown' control: visible control is rendered beneath the table for better UX #}
            <div class="col-auto sr-only">
              <input id="{{ filter_namespace }}_shown" name="{{ filter_namespace }}_shown" type="hidden" value="{{ page_size }}" />
            </div>
            <div class="col-auto sr-only">
              <button type="submit" class="btn btn-sm btn-primary visually-hidden">{% trans "Apply" %}</button>
            </div>
          </div>
        </form>
        {% endwith %}
      {% endif %}
    </div>
    {% endwith %}
 
    {# Auto-submit filters when changed for a smoother experience. Keep a hidden submit for accessibility. #}
    <script>
    (function(){
      if(window.__helpdesk_filters_attached) return; window.__helpdesk_filters_attached = true;
      document.addEventListener('change', function(e){
        try{
          var f = e.target.closest('form.form-inline');
          if(!f) return;
          // ensure this is a ticket filters form by checking container
          if(!f.closest('.tickets-filters')) return;
          // submit the form (GET) to apply filters immediately
          f.submit();
        }catch(err){ /* fail silently */ }
      });
    })();
    </script>
    <div class="table-responsive-professional">
      <table class="professional-table table-sm table-striped" id="dataTable" width="100%" cellspacing="0" role="table" aria-label="{% trans 'Tickets table' %}">
        <thead>
          <tr>
            <th>{% trans "Ticket" %}</th>
            <th>{% trans "Priority" %}</th>
            <th>{% trans "Queue" %}</th>
            <th>{% trans "Status" %}</th>
            <th>{% trans "Last Update" %}</th>
          </tr>
        </thead>
  <tbody data-pagesize="{{ page_size|default:5 }}">
          {% for ticket in ticket_list %}
          <tr class="{{ ticket.get_priority_css_class }}">
            <td class="tickettitle">
              <a href="{{ ticket.get_absolute_url }}">{{ ticket.id }}. {{ ticket.title }}</a>
            </td>
            <td>{{ ticket.priority }}</td>
            <td>{{ ticket.queue }}</td>
            <td>{{ ticket.get_status }}</td>
            <td>
              <span title="{{ ticket.modified|date:'DATETIME_FORMAT' }}">{{ ticket.modified|naturaltime }}</span>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-muted small">
              {% if ticket_list_empty_message %}{{ ticket_list_empty_message }}{% else %}{% trans "No tickets found for the selected filters." %}{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <script>
      (function(){
        try{
          var tb = document.querySelector('.professional-table tbody[data-pagesize]');
          if(tb){
            var ps = parseInt(tb.getAttribute('data-pagesize')||5,10)||5;
            var h = (ps * 48) + 'px';
            tb.style.minHeight = h;
            var container = tb.closest('.table-responsive-professional');
            if(container) container.style.minHeight = h;
          }
        }catch(e){/*silent*/}
      })();
    </script>
    <script>
    (function(){
  })();
    </script>

    <!-- /.table-responsive -->
    {% with filter_namespace|default:'atrbcu' as filter_namespace %}
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="text-left">
        <label class="small text-muted mr-2" for="{{ filter_namespace }}_shown_bottom">{% trans "Show" %}</label>
  <input id="{{ filter_namespace }}_shown_bottom" type="number" min="1" max="100" value="{{ page_size }}" data-default="{{ page_size }}" data-ls-key="helpdesk_{{ filter_namespace }}_shown" data-ls-saved-key="helpdesk_{{ filter_namespace }}_shown_saved" class="form-control form-control-sm d-inline-block helpdesk-show-spinner" style="width:6rem;" />
      </div>
      <div class="text-right">
      {% if ticket_list.has_other_pages %}
        <nav aria-label="{% trans 'Ticket pagination' %}" class="mt-0">
          <ul class="pagination mb-0">
            {% if ticket_list.has_previous %}
              <li class="page-item"><a class="page-link" href="?{% qs_with page_var=1 %}">&laquo;&laquo;</a></li>
              <li class="page-item"><a class="page-link" href="?{% qs_with_var page_var ticket_list.previous_page_number %}">&laquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;&laquo;</span></li>
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            {% with 5 as thresh %}
            {% for i in ticket_list.paginator.page_range %}
                {% if ticket_list.number == i %}
                <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
              {% elif i <= ticket_list.number|add:5 and i >= ticket_list.number|add:-5 %}
                <li class="page-item"><a class="page-link" href="?{% qs_with_var page_var i %}">{{ i }}</a></li>
              {% endif %}
            {% endfor %}
            {% endwith %}

            {% if ticket_list.has_next %}
              <li class="page-item"><a class="page-link" href="?{% qs_with_var page_var ticket_list.next_page_number %}">&raquo;</a></li>
              <li class="page-item"><a class="page-link" href="?{% qs_with_var page_var ticket_list.paginator.num_pages %}">&raquo;&raquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
              <li class="page-item disabled"><span class="page-link">&raquo;&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
      </div>
    </div>
    <script>
      (function(){
        try{
          var bottom = document.getElementById('{{ filter_namespace }}_shown_bottom');
          if(!bottom) return;
          var topHidden = document.getElementById('{{ filter_namespace }}_shown');
          var filtersForm = document.querySelector('.tickets-filters form.form-inline');
          (function(){
            var lsKey = bottom.getAttribute('data-ls-key');
            var paramName = '{{ filter_namespace }}_shown';
            try{
              // If URL param is absent but we have a saved value and a saved-flag, populate the bottom input and top hidden input
              var urlParams = new URLSearchParams(window.location.search);
              var savedFlagKey = bottom.getAttribute('data-ls-saved-key');
              if(!urlParams.has(paramName) && lsKey && savedFlagKey){
                var savedFlag = localStorage.getItem(savedFlagKey);
                if(savedFlag){
                  var saved = localStorage.getItem(lsKey);
                  if(saved){
                    bottom.value = saved;
                    if(topHidden){ topHidden.value = saved; }
                  }
                }
              }
            }catch(e){/*silent*/}

            bottom.addEventListener('change', function(){
              try{
                var defaultVal = parseInt(bottom.getAttribute('data-default')||5,10) || 5;
                var v = parseInt(this.value,10) || defaultVal;
                if(lsKey){ localStorage.setItem(lsKey, String(v)); }
                if(bottom.getAttribute('data-ls-saved-key')){
                  localStorage.setItem(bottom.getAttribute('data-ls-saved-key'),'1');
                }
                if(topHidden){ topHidden.value = v; }

                // Prefer submitting the specific filters form that contains the
                // hidden top input for this namespace. This ensures the correct
                // table is updated when multiple ticket tables exist on the page.
                var targetForm = null;
                try{
                  if(topHidden && typeof topHidden.closest === 'function'){
                    targetForm = topHidden.closest('form');
                  }
                }catch(_){}
                if(!targetForm){
                  // fallback to the first filters form on the page
                  targetForm = document.querySelector('.tickets-filters form.form-inline');
                }
                if(targetForm){
                  targetForm.submit();
                }else{
                  // final fallback: reload current URL while setting the shown param
                  try{
                    var url = new URL(window.location.href);
                    url.searchParams.set(paramName, String(v));
                    window.location.href = url.toString();
                  }catch(e){ /* silent */ }
                }
              }catch(e){/*silent*/}
            });
            // also handle Enter key so the value persists when user presses Enter
            bottom.addEventListener('keydown', function(e){
              try{
                if(e.key === 'Enter' || e.keyCode === 13){
                  e.preventDefault();
                  // mark saved flag and trigger change handler logic
                  if(bottom.getAttribute('data-ls-saved-key')){
                    localStorage.setItem(bottom.getAttribute('data-ls-saved-key'),'1');
                  }
                  // If topHidden exists, focus it first so its form can be found
                  // consistently, then dispatch change on bottom to reuse handler.
                  if(topHidden){ try{ topHidden.focus(); }catch(_){ } }
                  var ev = new Event('change', { bubbles: true });
                  bottom.dispatchEvent(ev);
                }
              }catch(err){/*silent*/}
            });
          })();
        }catch(e){/*silent*/}
      })();
    </script>
    {% endwith %}
  </div>

  <div class="card-footer small text-muted">
    {% blocktrans count count=ticket_list|length %}
      Listing {{ count }} ticket.
    {% plural %}
      Listing {{ count }} tickets.
    {% endblocktrans %}
  </div>
  </div>


