{% load i18n humanize %}

<style>
  /* Keep large rounded card corners for this partial */
  .card.mb-3 {
    border-radius: 16px !important;
    overflow: hidden;
  }
  .card.mb-3 .card-header { border-top-left-radius: 16px; border-top-right-radius: 16px; }
  .card.mb-3 .card-footer { border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; }

  /* Reuse the professional table wrapper used elsewhere */
  .table-responsive-professional {
    margin-top: 0;
    border: 1px solid rgba(15,23,42,0.06);
    border-radius: 10px;
    overflow: hidden;
    background: #fff;
  }

  /* Professional table styles (consistent with tickets include) */
  .professional-table {
    width: 100%;
    margin-bottom: 0;
    border-collapse: collapse;
    background: transparent;
    font-size: 0.95rem;
  }
  .professional-table thead th {
    background: linear-gradient(180deg, #f8f9fb 0%, #f4f6f8 100%);
    color: #0f1724;
    font-weight: 600;
    padding: 0.65rem 0.9rem;
    text-align: left;
    border-bottom: 1px solid rgba(15,23,42,0.06);
    vertical-align: middle;
  }
  .professional-table tbody td {
    padding: 0.55rem 0.9rem;
    vertical-align: middle;
    border-bottom: 1px solid rgba(15,23,42,0.04);
    color: #111827;
  }
  .professional-table tbody tr:last-child td { border-bottom: none; }
  .professional-table tbody tr:hover { background: rgba(11,94,215,0.03); }
  .professional-table.table-striped tbody tr:nth-of-type(odd) { background: rgba(0,0,0,0.02); }

  /* Ticket title link */
  .tickettitle a { color: #0b5ed7; text-decoration: none; font-weight: 500; }
  .tickettitle a:hover { text-decoration: underline; }

  /* Buttons inside cards follow the theme */
  .card.mb-3 .btn-primary {
    background-color: #0b57d0;
    border-color: #0847b0;
    color: #fff;
  }
  .card.mb-3 .btn-primary:hover { background-color: #0847b0; border-color: #053a8a; }
  .card.mb-3 .btn-danger {
    background-color: #ef4444;
    border-color: #d13b3b;
    color: #fff;
  }
  .card.mb-3 .btn-danger:hover { background-color: #d83636; border-color: #c02f2f; }

  .card.mb-3 .card-footer { background: transparent; color: #6b7280; font-size: .85rem; padding: .5rem 1rem; }
</style>

<div class="card mb-3">
    <div class="card-header">
        <i class="fas fa-table"></i>
        {% trans "Unassigned Tickets" %}
    </div>
    <div class="card-body">
    <div class="tickets-filters mb-3">
      <form method="get" class="form-inline" aria-label="Unassigned filters">
        <div class="form-row w-100">
          <div class="col-auto pr-2">
            <select name="unq_queue" class="form-control form-control-sm">
              <option value="">All queues</option>
              {% if queues %}
                {% for q in queues %}
                <option value="{{ q.id }}"{% if request.GET.unq_queue == q.id|stringformat:"s" %} selected{% endif %}>{{ q.title }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
          <div class="col-auto pr-2">
            <select name="unq_order" class="form-control form-control-sm">
              <option value="desc"{% if request.GET.unq_order != 'asc' %} selected{% endif %}>{% trans "Newest" %}</option>
              <option value="asc"{% if request.GET.unq_order == 'asc' %} selected{% endif %}>{% trans "Oldest" %}</option>
            </select>
          </div>
                    <div class="col-auto sr-only">
                      <input id="un_shown" name="un_shown" type="hidden" value="{{ un_shown|default:5 }}" />
                    </div>
          <div class="col-auto sr-only">
            <button type="submit" class="btn btn-sm btn-primary visually-hidden">{% trans "Apply" %}</button>
          </div>
        </div>
      </form>
    </div>
    <div class="table-responsive-professional">
            <table class="professional-table table-sm table-striped" id="dataTable" width="100%" cellspacing="0" role="table" aria-label="{% trans 'Unassigned tickets' %}">
                <thead>
                    <tr>
                      <th>{% trans "Ticket" %}</th>
                      <th>{% trans "Priority" %}</th>
                      <th>{% trans "Queue" %}</th>
                      <th>{% trans "Created" %}</th>
                    </tr>
                </thead>
                <tbody>
                {% for ticket in unassigned_tickets %}
                    <tr class="{{ ticket.get_priority_css_class }}">
                        <td class="tickettitle"><a href="{{ ticket.get_absolute_url }}">{{ ticket.id }}. {{ ticket.title }}</a></td>
                        <td>{{ ticket.priority }}</td>
                        <td>{{ ticket.queue }}</td>
                        <td><span title="{{ ticket.created|date:'DATETIME_FORMAT' }}">{{ ticket.created|naturaltime }}</span></td>
                    </tr>
                {% empty %}
                    <tr><td colspan="4" class="text-muted small">{% trans "There are no unassigned tickets." %}</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="text-left">
        <label class="small text-muted mr-2" for="un_shown_bottom">{% trans "Show" %}</label>
        <input id="un_shown_bottom" type="number" min="1" max="100" value="{{ un_shown|default:5 }}" class="form-control form-control-sm d-inline-block helpdesk-show-spinner" style="width:6rem;" />
      </div>
      <div class="text-right">
      {% if unassigned_tickets.has_other_pages %}
        <nav aria-label="{% trans 'Unassigned ticket pagination' %}" class="mt-0">
          <ul class="pagination mb-0">
            {% if unassigned_tickets.has_previous %}
              <li class="page-item"><a class="page-link" href="?un_page=1{% if request.GET.unq_queue %}&unq_queue={{ request.GET.unq_queue }}{% endif %}{% if request.GET.unq_order %}&unq_order={{ request.GET.unq_order }}{% endif %}">&laquo;&laquo;</a></li>
              <li class="page-item"><a class="page-link" href="?un_page={{ unassigned_tickets.previous_page_number }}{% if request.GET.unq_queue %}&unq_queue={{ request.GET.unq_queue }}{% endif %}{% if request.GET.unq_order %}&unq_order={{ request.GET.unq_order }}{% endif %}">&laquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;&laquo;</span></li>
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            {% with 5 as thresh %}
            {% for i in unassigned_tickets.paginator.page_range %}
                {% if unassigned_tickets.number == i %}
                <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
              {% elif i <= unassigned_tickets.number|add:5 and i >= unassigned_tickets.number|add:-5 %}
                <li class="page-item"><a class="page-link" href="?un_page={{ i }}{% if request.GET.unq_queue %}&unq_queue={{ request.GET.unq_queue }}{% endif %}{% if request.GET.unq_order %}&unq_order={{ request.GET.unq_order }}{% endif %}">{{ i }}</a></li>
              {% endif %}
            {% endfor %}
            {% endwith %}

            {% if unassigned_tickets.has_next %}
              <li class="page-item"><a class="page-link" href="?un_page={{ unassigned_tickets.next_page_number }}{% if request.GET.unq_queue %}&unq_queue={{ request.GET.unq_queue }}{% endif %}{% if request.GET.unq_order %}&unq_order={{ request.GET.unq_order }}{% endif %}">&raquo;</a></li>
              <li class="page-item"><a class="page-link" href="?un_page={{ unassigned_tickets.paginator.num_pages }}{% if request.GET.unq_queue %}&unq_queue={{ request.GET.unq_queue }}{% endif %}{% if request.GET.unq_order %}&unq_order={{ request.GET.unq_order }}{% endif %}">&raquo;&raquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
              <li class="page-item disabled"><span class="page-link">&raquo;&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
      </div>
    </div>
    <script>
      (function(){
        try{
          var bottom = document.getElementById('un_shown_bottom');
          if(!bottom) return;
          var topHidden = document.getElementById('un_shown');
          bottom.addEventListener('change', function(){
            try{
              var v = parseInt(this.value,10) || parseInt('{{ un_shown|default:5 }}',10) || 5;
              if(topHidden){ topHidden.value = v; var form = topHidden.closest('form'); if(form){ form.submit(); return; } }
              var url = new URL(window.location.href);
              url.searchParams.set('un_shown', String(v));
              window.location.href = url.toString();
            }catch(e){}
          });
        }catch(e){}
      })();
    </script>
  <div class="card-footer small text-muted">Listing {% if unassigned_tickets.paginator %}{{ unassigned_tickets.paginator.count }}{% else %}{{ unassigned_tickets|length }}{% endif %} ticket(s).</div>
</div>

{% for kbitem in kbitems %}
{% if kbitem.unassigned_tickets %}
<div class="card mb-3">
    <div class="card-header">
        <i class="fas fa-table"></i>
        {% trans "KBItem:" %} {{kbitem.title}} {% trans "Team:" %} {{kbitem.get_team.name}} {% trans "(pick up a ticket if you start to work on it)" %}
    </div>
    <div class="card-body">
        <div class="table-responsive-professional">
            <table class="professional-table table-sm table-striped" id="dataTable" width="100%" cellspacing="0" role="table" aria-label="{% trans 'KB unassigned tickets' %}">
                <thead>
                    <tr>
                      <th>{% trans "Ticket" %}</th>
                      <th>{% trans "Priority" %}</th>
                      <th>{% trans "Queue" %}</th>
                      <th>{% trans "Created" %}</th>
                      <th class="text-center">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                {% for ticket in kbitem.unassigned_tickets %}
                    <tr class="{{ ticket.get_priority_css_class }}">
                        <td class="tickettitle"><a href="{{ ticket.get_absolute_url }}">{{ ticket.id }}. {{ ticket.title }}</a></td>
                        <td>{{ ticket.priority }}</td>
                        <td>{{ ticket.queue }}</td>
                        <td><span title="{{ ticket.created|date:'DATETIME_FORMAT' }}">{{ ticket.created|naturaltime }}</span></td>
                        <td class="text-center">
                          <a href="{{ ticket.get_absolute_url }}?take" class="d-inline-block"><button class="btn btn-primary btn-sm" type="button"><i class="fas fa-hand-paper"></i>&nbsp;{% trans "Take" %}</button></a>
                          <a href="{% url 'helpdesk:delete' ticket.id %}?next=dashboard" class="d-inline-block"><button class="btn btn-danger btn-sm" type="button"><i class="fas fa-trash"></i>&nbsp;{% trans "Delete" %}</button></a>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5" class="text-muted small">{% trans "There are no unassigned tickets." %}</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer small text-muted">Listing {{ kbitem.unassigned_tickets|length }} ticket(s).</div>
</div>
{% endif %}
{% endfor %}
