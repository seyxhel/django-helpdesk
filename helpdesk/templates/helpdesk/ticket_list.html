{% extends "helpdesk/base.html" %}

{% load i18n humanize static in_list %}

{% block helpdesk_title %}{% trans "Tickets" %}{% endblock %}

{% block helpdesk_head %}
    <!-- Timeline 3 CSS -->
    {% if helpdesk_settings.HELPDESK_USE_CDN %}
    <link title="timeline-styles" rel="stylesheet" href="https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css">
    {% else %}
    <link title="timeline-styles" rel="stylesheet" href="{% static 'helpdesk/vendor/timeline3/css/timeline.css' %}">
    {% endif %}
{% endblock %}

{% block h1_title %}Tickets
    {% if from_saved_query %} [{{ saved_query.title }}]{% endif %}
{% endblock %}


{% block helpdesk_breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{% url 'helpdesk:list' %}">{% trans "Tickets" %}</a>
    </li>
    {% if from_saved_query and saved_query.user == user %}
        <li class="breadcrumb-item">{% trans "Saved Query" %}</li>
        <li class="breadcrumb-item active">{{ saved_query.title }}</li>
    {% else %}
        <li class="breadcrumb-item active">{% trans "Overview" %}</li>
    {% endif %}
{% endblock %}


{% block helpdesk_body %}
<!-- Corporate UI: clean, neutral palette, clear hierarchy -->
<style>
  /* Aesthetic minimal / balanced filter row */
  :root{
    --bg: #ffffff;
    --muted: #6c7783;
    --ink: #0f2b44;
    --accent: #0b57d0;
    --soft: #f5f8fb;
    --border: #e6eef6;
    --radius: 8px;
    --height: 44px;
    --gap: 14px;
  }

  /* container */
  .card.mb-3 { border-radius: var(--radius); border: 1px solid var(--border); background: linear-gradient(180deg,#fff,#fbfeff); box-shadow:0 6px 20px rgba(15,23,42,0.04); }

  /* Filters bar: equal horizontal rhythm */
  .filters-bar {
    display: flex;
    gap: var(--gap);
    align-items: center;
    width: 100%;
    padding: 12px;
    box-sizing: border-box;
    background: transparent;
    white-space: nowrap;
    overflow-x: auto;
  }

  /* equal-aligned layout:
     - search is slightly larger
     - every other control shares same visual width rhythm
  */
  .filters-bar > * { box-sizing: border-box; flex: 1 1 0; min-width: 120px; }
  .filters-bar .f-search { flex: 2 1 360px; min-width: 240px; }
  .filters-bar .f-control { flex: 1 1 160px; min-width: 140px; }
  .filters-bar .f-actions { flex: 1 1 160px; min-width: 140px; display: flex; gap: 10px; justify-content: flex-start; align-items: center; }
  .filters-bar .add-filter { flex: 0 0 140px; min-width: 120px; display: flex; justify-content: flex-end; align-items: center; }

  /* Overrides: filters font 12px, top/bottom padding 10px, center-aligned text */
  .filters-bar {
    padding-top: 10px;
    padding-bottom: 10px;
  }

  /* Ensure all children share the same small font and vertical centering */
  .filters-bar,
  .filters-bar > * {
    font-size: 12px;
    align-items: center;
    text-align: left; /* left-align text for all filter controls */
  }

  /* Controls: 10px vertical padding, left-aligned text, flexible height */
  .form-control,
  .custom-select {
    font-size: 12px;
    padding: 10px 12px;        /* top/bottom = 10px, left/right = 12px */
    height: auto;              /* allow padding to control height */
    line-height: 1;            /* prevent extra line-height spacing */
    text-align: left;         /* left align text */
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    border-radius: var(--radius);
  }
  /* Force selects to left-align the selected option in most browsers */
  .custom-select { text-align-last: left; }

  /* Buttons match control sizing and left-align their labels */
  .filters-bar .btn,
  .filters-bar .btn.btn-primary,
  .filters-bar .btn-outline-secondary {
    font-size: 12px;
    padding: 7px 14px;
    height: auto;
    display: inline-flex;
    align-items: center;
    justify-content: flex-start;
    border-radius: var(--radius); /* make buttons match inputs/cards */
    cursor: pointer;
  }
  
  /* Add-filter: compact, icon-like select */
  .add-filter select.custom-select {
    background: linear-gradient(180deg,#fff,#fbfdff);
    padding-right: 28px;
    text-align-last: center;
  }
  /* Add small chevron using pseudo element on container (works for modern browsers) */
  .add-filter { position: relative; }
  .add-filter::after {
    content: 'â–¾';
    position: absolute;
    right: 12px;
    font-size: 14px;
    color: var(--muted);
    pointer-events: none;
    top: 50%;
    transform: translateY(-50%);
  }

  /* Advanced filter cards: minimal */
  .filter-grid .filter-card {
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: #fff;
    padding: 10px 12px;
    box-shadow: none;
  }
  /* hide by default, reveal when filterBoxShow applied */
  .filterBox { display: none; opacity: 0; transition: opacity .18s ease; }
  .filterBox.filterBoxShow { display: block; opacity: 1; }

  /* Sorting box micro-style */
  #filterBoxSort { display: flex; gap: 12px; align-items: center; }
  #filterBoxSort .sort-label { min-width: 82px; color: var(--ink); font-weight: 600; }
  #filterBoxSort .btn-delete {
    background: transparent;
    border: 1px solid rgba(15,43,68,0.06);
    color: #d44;
    width: 36px; height: 36px;
    border-radius: var(--radius);
    display: inline-flex; align-items: center; justify-content: center;
  }

  /* Responsiveness: keep single-row until narrow */
  @media (max-width: 900px) {
    .filters-bar { flex-wrap: wrap; gap: 10px; }
    .filters-bar > * { flex: 1 1 100%; min-width: 140px; }
    .filters-bar .f-search { order: -1; }
    .add-filter { justify-content: flex-start; }
  }
</style>

    {# --- Query selection & filters: placed before the table for better UX --- #}
    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-filter"></i>
            {% trans "Filters" %}
        </div>
        <div class="card-body">
            {# kept design centralized in the top styles; no duplicate rules here to avoid conflicts #}

            <form method="get" class="filters-bar" aria-label="{% trans 'Ticket filters' %}">
                <div class="f-search">
                    <label class="sr-only" for="q">{% trans "Search" %}</label>
                    <input id="q" name="q" type="search" class="form-control form-control-sm" placeholder="{% trans 'Search by ID, title or ticket ID' %}" value="{{ request.GET.q|default:'' }}">
                </div>

                <div class="f-control">
                    <label class="sr-only" for="status">{% trans "Status" %}</label>
                    <select id="status" name="status" class="custom-select custom-select-sm">
                        <option value="">{% trans "All statuses" %}</option>
                        <option value="open" {% if request.GET.status == 'open' %}selected{% endif %}>{% trans "Open" %}</option>
                        <option value="closed" {% if request.GET.status == 'closed' %}selected{% endif %}>{% trans "Closed" %}</option>
                    </select>
                </div>

                <div class="f-control">
                    <label class="sr-only" for="priority">{% trans "Priority" %}</label>
                    <select id="priority" name="priority" class="custom-select custom-select-sm">
                        <option value="">{% trans "All priorities" %}</option>
                        <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>{% trans "Low" %}</option>
                        <option value="medium" {% if request.GET.priority == 'medium' %}selected{% endif %}>{% trans "Medium" %}</option>
                        <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>{% trans "High" %}</option>
                    </select>
                </div>

                <div class="f-control">
                    <label class="sr-only" for="queue">{% trans "Queue" %}</label>
                    <select id="queue" name="queue" class="custom-select custom-select-sm">
                        <option value="">{% trans "All queues" %}</option>
                        {% if queues %}
                            {% for q in queues %}
                                <option value="{{ q.slug }}" {% if request.GET.queue == q.slug %}selected{% endif %}>{{ q.title }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="f-actions">
                    <button type="submit" class="btn btn-primary btn-sm" title="{% trans 'Apply filters' %}">{% trans "Apply" %}</button>
                    <a href="{% url 'helpdesk:list' %}" class="btn btn-outline-secondary btn-sm" title="{% trans 'Reset filters' %}">{% trans "Reset" %}</a>
                </div>

                <div class="add-filter">
                    <label class="sr-only" for="filterBuilderSelect">{% trans "Add filter" %}</label>
                    {# use IDs so the helper can reveal the right advanced control #}
                    <select class="custom-select custom-select-sm" name="select" id="filterBuilderSelect" onChange="onFilterChange(this.value)">
                        <option value="">{% trans "Add filter" %}</option>
                        <option value="filterBoxSort" {% if query_params.sorting %} disabled{% endif %}>{% trans "Sorting" %}</option>
                        <option value="filterBoxPriority" {% if query_params.filtering.priority__in %} disabled{% endif %}>{% trans "Priority" %}</option>
                        <option value="filterBoxOwner" {% if query_params.filtering.assigned_to__id__in or query_params.filtering_null.assigned_to__id__isnull %} disabled{% endif %}>{% trans "Owner" %}</option>
                        <option value="filterBoxQueue" {% if query_params.filtering.queue__id__in or query_params.filtering_null.queue__id__isnull %} disabled{% endif %}>{% trans "Queue" %}</option>
                        <option value="filterBoxStatus" {% if query_params.filtering.status__in %} disabled{% endif %}>{% trans "Status" %}</option>
                        <option value="filterBoxKeywords" {% if query_params.search_string %} disabled{% endif %}>{% trans "Keywords" %}</option>
                        <option value="filterBoxDates" {% if query_params.filtering.created__gte or query_params.filtering.created__lte %} disabled{% endif %}>{% trans "Date Range" %}</option>
                        <option value="filterBoxKBItems" {% if query_params.filtering.kbitem__in or query_params.filtering_null.kbitem__isnull %} disabled{% endif %}>{% trans "KB items" %}</option>
                    </select>
                </div>
            </form>

            <script>
              // small helper to reveal advanced filter cards by id
              function onFilterChange(value){
                if(!value) return;
                // mapping for legacy values if ever used
                const map = {
                  'Sort':'filterBoxSort','Priority':'filterBoxPriority','Owner':'filterBoxOwner',
                  'Queue':'filterBoxQueue','Status':'filterBoxStatus','Keywords':'filterBoxKeywords',
                  'Dates':'filterBoxDates','KBItems':'filterBoxKBItems'
                };
                const id = map[value] || value;
                const el = document.getElementById(id);
                if(!el) { document.getElementById('filterBuilderSelect').value=''; return; }
                el.classList.add('filterBoxShow');
                setTimeout(()=> el.scrollIntoView({behavior:'smooth', block:'center'}),100);
                document.getElementById('filterBuilderSelect').value='';
              }
            </script>

            {% comment %} include expanded filter boxes if user adds advanced filters (keeps existing includes) {% endcomment %}
            <div class="mt-3">
                <div class="row">
                    <div class="col-12">
                        <div class="filter-grid row">
                            {% comment %} keep advanced filter cards hidden/shown by JS (existing includes) {% endcomment %}
                            <div class="col-md-6 mb-3 filter-card filterBox{% if query_params.sorting %} filterBoxShow{% endif %}" id="filterBoxSort">
                                {% include 'helpdesk/filters/sorting.html' %}
                            </div>
                            <div class="col-md-6 mb-3 filter-card filterBox{% if query_params.filtering.priority__in %} filterBoxShow{% endif %}" id="filterBoxPriority">
                                {% include 'helpdesk/filters/priority.html' %}
                            </div>
                            <div class="col-md-6 mb-3 filter-card filterBox{% if query_params.filtering.assigned_to__id__in or query_params.filtering_null.assigned_to__id__isnull %} filterBoxShow{% endif %}" id="filterBoxOwner">
                                {% include 'helpdesk/filters/owner.html' %}
                            </div>
                            <div class="col-md-6 mb-3 filter-card filterBox{% if query_params.filtering.queue__id__in or query_params.filtering_null.queue__id__isnull %} filterBoxShow{% endif %}" id="filterBoxQueue">
                                {% include 'helpdesk/filters/queue.html' %}
                            </div>
                            <div class="col-md-6 mb-3 filter-card filterBox{% if query_params.filtering.status__in %} filterBoxShow{% endif %}" id="filterBoxStatus">
                                {% include 'helpdesk/filters/status.html' %}
                            </div>
                            <div class="col-md-6 mb-3 filter-card filterBox{% if query_params.filtering.created__gte or query_params.filtering.created__lte %} filterBoxShow{% endif %}" id="filterBoxDates">
                                {% include 'helpdesk/filters/date.html' %}
                            </div>
                            <div class="col-md-6 mb-3 filter-card filterBox{% if query_params.search_string %} filterBoxShow{% endif %}" id="filterBoxKeywords">
                                {% include 'helpdesk/filters/keywords.html' %}
                            </div>
                            <div class="col-md-6 mb-3 filter-card filterBox{% if query_params.filtering.kbitem__in or query_params.filtering_null.kbitem__isnull %} filterBoxShow{% endif %}" id="filterBoxKBItems">
                                {% include 'helpdesk/filters/kbitems.html' %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end top card -->

    {# --- Move mass-action & top controls here (below query selection, above the table) --- #}
    <form method='post' action='{% url 'helpdesk:mass_update' %}' id="ticket_mass_update">
        {% csrf_token %}
        <div id="topTableControls" class="d-flex justify-content-between align-items-center mb-3">
            <div class="dt-buttons-placeholder">
                {# DataTables will move its buttons (Column visibility etc.) here on init via JS. #}
            </div>

            <div class="d-flex align-items-center gap-2">
                <label class="mb-0 mr-2 small text-muted">{% trans "Select:" %}</label>
                <div class="btn-group btn-group-sm mr-2" role="group" aria-label="{% trans 'Select controls' %}">
                    <button id="select_all_btn" type="button" class="btn btn-outline-primary btn-sm">{% trans "All" %}</button>
                    <button id="select_none_btn" type="button" class="btn btn-outline-primary btn-sm">{% trans "None" %}</button>
                    <button id="select_inverse_btn" type="button" class="btn btn-outline-primary btn-sm">{% trans "Invert" %}</button>
                </div>

                <label for='id_mass_action' class="mb-0 small mr-2">{% trans "With Selected Tickets:" %}</label>
                <select name='action' id='id_mass_action' class="form-control form-control-sm">
                    <option value='take'>{% trans "Take (Assign to me)" %}</option>
                    <option value='delete'>{% trans "Delete" %}</option>
                    <option value='merge'>{% trans "Merge" %}</option>
                    <optgroup label='{% trans "Close" %}'>
                        <option value='close'>{% trans "Close (Don't Send E-Mail)" %}</option>
                        <option value='close_public'>{% trans "Close (Send E-Mail)" %}</option>
                    </optgroup>
                    <optgroup label='{% trans "Assign To" %}'>
                        <option value='unassign'>{% trans "Nobody (Unassign)" %}</option>
                        {% for u in assignable_users %}
                            <option value='assign_{{ u.id }}'>{{ u.get_username }}</option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label='{% trans "Set KB Item" %}'>
                        <option value='kbitem_none'>{% trans "No KB Item" %}</option>
                        {% for kbi in kb_items %}
                            <option value='kbitem_{{ kbi.id }}'>{{ kbi.category.title }}: {{ kbi.title }}</option>
                        {% endfor %}
                    </optgroup>
                </select>
                <button type="submit" class="btn btn-primary btn-sm ml-2">
                    <i class="fas fa-arrow-circle-right"></i> {% trans "Go" %}
                </button>
            </div>
        </div>
    {# form remains open and will wrap the table card below #}

    {# --- Table card: now after the filters --- #}
    <div class="card">
        {% if helpdesk_settings.HELPDESK_TICKETS_TIMELINE_ENABLED %}
        <div class="card-header">
            <ul class="nav nav-tabs">
                <li class="nav-item" style="width: 200px;">
                    {% trans "Query Results" %}:
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#datatabletabcontents" id="datatabletabcontents-tab"
                       data-toggle="tab" role="tab" aria-controls="datatabletabcontents" aria-selected=true>
                        <i class="fas fa-th-list"></i>
                        {% trans "Table" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#timelinetabcontents" id="timelinetabcontents-tab" data-toggle="tab"
                       role="tab" aria-controls="timelinetabcontents" aria-selected=false>
                        <i class="fas fa-history"></i>
                        {% trans "Timeline" %}
                    </a>
                </li>
            </ul>
        </div>
        {% endif %}
        <div class="card-body">
            {{ search_message|safe }}
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="datatabletabcontents" role="tabpanel"
                     aria-labelledby="datatabletabcontents-tab">
                        <table class="table table-sm table-striped table-bordered table-hover"
                               id="ticketTable" data-page-length='{{ default_tickets_per_page }}'>
                            <thead class="thead-light">
                            <tr>
                                <th></th>
                                <th>{% trans "Ticket" %}</th>
                                <th>{% trans "Priority" %}</th>
                                <th>{% trans "Queue" %}</th>
                                <th>{% trans "Status" %}</th>
                                <th>{% trans "Created" %}</th>
                                <th>{% trans "Due Date" %}</th>
                                <th>{% trans "Owner" %}</th>
                                <th>{% trans "Submitter" %}</th>
                                <th>{% trans "Last Followup" %}</th>
                                {% if helpdesk_settings.HELPDESK_ENABLE_TIME_SPENT_ON_TICKET %}<th>{% trans "Time Spent" %}</th>{% endif %}
                                {% if helpdesk_settings.HELPDESK_KB_ENABLED %}<th>{% trans "KB item" %}</th>{% endif %}
                            </tr>
                            </thead>
                        </table>
                    </form>
                </div>
                {% if helpdesk_settings.HELPDESK_TICKETS_TIMELINE_ENABLED %}
                <div class="tab-pane fade" id="timelinetabcontents" role="tabpanel" aria-labelledby="timelinetabcontents-tab">
                    <div id='timeline-embed' style="width: 100%; height: 80vh"></div>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- /.panel-body -->
    </div>
    <!-- /.panel -->

    <!-- Entries controls (DataTables length & pagination) will be moved here on init -->
    <div id="entriesControls" class="d-flex justify-content-between align-items-center mt-3"></div>

{% endblock %}


{% block helpdesk_js %}
    <script src='{% static "helpdesk/filter.js" %}'></script>
    <!-- Timeline 3 JavaScript -->
    {% if helpdesk_settings.HELPDESK_USE_CDN %}
    <script src="https://cdn.knightlab.com/libs/timeline3/latest/js/timeline.js"></script>
    {% else %}
    <script src="{% static 'helpdesk/vendor/timeline3/js/timeline.js' %}"></script>
    {% endif %}

    <script>
        window.helpdesk_settings = {
            LANGUAGE_CODE: "{{ helpdesk_settings.LANGUAGE_CODE|default:'en-US' }}",
            NO_FOLLOWUP_TEXT: "{% trans helpdesk_settings.ALTERNATIVE_UI_STRINGS.No_followup_found|default:'No followup found' %}"
        };

        function get_url(row) {
            return "{% url 'helpdesk:view' 1234 %}".replace(/1234/, row.id.toString());
        }
        
        function htmlEntities(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        $(document).ready(function () {
            // Ticket DataTable Initialization
        $.fn.dataTable.ext.errMode = function(settings, helpPage, message) {
        alert("{% trans 'Error fetching tickets occured, please contact the system administrators of this server providing the message below:\n    ' %}" + message)
        };
            $('#ticketTable').DataTable({
                language: {
                    "emptyTable": "{% trans 'No Tickets Match Your Selection' %}"
                },
                processing: true,
                serverSide: true,
                ajax: {
                    "url": "{% url 'helpdesk:datatables_ticket_list' urlsafe_query %}",
                    "type": "GET",
                },
                createdRow: function (row, data, dataIndex) {
                    $(row).addClass(data.row_class);
                },
                dom: 'ltBp',
                buttons: ["colvis"],
                columns: [
                    {
                        data: "id",
                        orderable: false,
                        render: function (data, type, row, meta) {
                            const pk = data;
                            if (type === 'display') {
                                data = "<input type='checkbox' name='ticket_id' value='" + pk + "' class='ticket_multi_select' />"
                            }
                            return data
                        }
                    },
                    {
                        data: "ticket",
                        render: function (data, type, row, meta) {
                            if (type === 'display') {
                                data = '<div class="tickettitle"><a href="' + get_url(row) + '" >' +
                                    row.id + '. ' +
                                    htmlEntities(row.title) + '</a></div>';
                            }
                            return data
                        }
                    },
                    {
                        data: "priority",
                        render: function (data, type, row, meta) {
                            let priorityClass = "text-secondary";
                            switch (data) {
                                case 1:
                                    priorityClass = "text-danger";
                                    break;
                                case 2:
                                    priorityClass = "text-warning";
                                    break;
                                case 3:
                                    priorityClass = "text-success";
                                    break;
                                case 4:
                                    priorityClass = "text-info";
                                    break;
                                case 5:
                                    priorityClass = "text-secondary";
                                    break;
                            }
                            return '<p class="' + priorityClass + '">' + data + '</p>';
                        },
                        visible: false,
                    },
                    {
                        data: "queue",
                        render: function (data, type, row, meta) {
                            return data.title;
                        },
                        visible: false,
                    },
                    {data: "status"},
                    {data: "created"},
                    {data: "due_date", "visible": false},
                    {
                        data: "assigned_to",
                        render: function (data, type, row, meta) {
                            if (data !== "None") {
                                return data;
                            }
                            return "";
                        }
                    },
                    {data: "submitter"},
                    {
                        data: "last_followup",
                        render: function (data, type, row) {
                            let locale = navigator.language || navigator.userLanguage || window.helpdesk_settings.LANGUAGE_CODE;
                            
                            if (isNaN(Date.parse(data))) {
                                return window.helpdesk_settings.NO_FOLLOWUP_TEXT;
                            }

                            let date = new Date(data);
                            return date.toLocaleString(locale, {
                                weekday: "short",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                                hour: "2-digit",
                                minute: "2-digit",
                                hour12: true
                            });
                        }
                    },
                    {% if helpdesk_settings.HELPDESK_ENABLE_TIME_SPENT_ON_TICKET %}
                    {data: "time_spent", "visible": false},
                    {% endif %}
                    {% if helpdesk_settings.HELPDESK_KB_ENABLED %}
                    {data: "kbitem"},
                    {% endif %}
                ],
                initComplete: function(settings, json) {
                    try {
                        var container = $('#entriesControls');
                        if(!container.length) return;
                        if(!container.find('.entries-left').length){
                            container.html('<div class="entries-left d-flex align-items-center"></div><div class="entries-right"></div>');
                        }
                        var left = container.find('.entries-left');
                        var right = container.find('.entries-right');
                        // Move length control and info to left, pagination to right
                        $('.dataTables_length').appendTo(left);
                        $('.dataTables_info').appendTo(left).addClass('ml-2 text-muted small');
                        $('.dataTables_paginate').appendTo(right);
                        // move DataTables buttons (colvis) into the top placeholder (below filters)
                        $('.dt-buttons').appendTo($('.dt-buttons-placeholder'));
                    } catch (e) {
                        console.warn('Could not relocate DataTables controls', e);
                    }
                },
                drawCallback: function(settings) {
                    // Ensure controls stay in place after draw (pagination redraws)
                    var container = $('#entriesControls');
                    if(!container.length) return;
                    var left = container.find('.entries-left');
                    var right = container.find('.entries-right');
                    $('.dataTables_length').appendTo(left);
                    $('.dataTables_info').appendTo(left);
                    $('.dataTables_paginate').appendTo(right);
                    // ensure buttons stay in the top placeholder after redraws
                    $('.dt-buttons').appendTo($('.dt-buttons-placeholder'));
                },
                order: []
            });

            {# Timeline initialization when tab is displayed #}
            // The TL.Timeline constructor takes at least two arguments:
            // the id of the Timeline container (no '#'), and
            // the URL to your JSON data file or Google spreadsheet.
            // the id must refer to an element "above" this code,
            // and the element must have CSS styling to give it width and height
            // optionally, a third argument with configuration options can be passed.
            // See below for more about options.
            let timeline_loaded = false;
            $('#timelinetabcontents-tab').on('shown.bs.tab', function (e) {
                if (!timeline_loaded) {
                    new TL.Timeline(
                        'timeline-embed',
                        '{% url 'helpdesk:timeline_ticket_list' urlsafe_query %}'
                    );
                    timeline_loaded = true;
                }
            });

            {# Shortcuts to select/unselect multiple tickets #}
            $("#select_all_btn").click(function () {
                $(".ticket_multi_select").prop('checked', true);
            });
            $("#select_none_btn").click(function () {
                $(".ticket_multi_select").prop('checked', false);
            });
            $("#select_inverse_btn").click(function () {
                $(".ticket_multi_select").each(function () {
                    $(this).prop('checked', !$(this).prop('checked'));
                });
            });
        })
    </script>
{% endblock %}

