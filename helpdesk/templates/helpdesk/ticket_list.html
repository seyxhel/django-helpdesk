{% extends "helpdesk/base.html" %}

{% load i18n humanize static in_list %}

{% block helpdesk_title %}{% trans "Tickets" %}{% endblock %}

{% block helpdesk_head %}
    <!-- Timeline 3 CSS -->
    {% if helpdesk_settings.HELPDESK_USE_CDN %}
    <link title="timeline-styles" rel="stylesheet" href="https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css">
    {% else %}
    <link title="timeline-styles" rel="stylesheet" href="{% static 'helpdesk/vendor/timeline3/css/timeline.css' %}">
    {% endif %}
{% endblock %}

{% block h1_title %}Tickets
    {% if from_saved_query %} [{{ saved_query.title }}]{% endif %}
{% endblock %}


{% block helpdesk_breadcrumb %}
    {# If filtered by queue show Reports -> Queue Title (link Reports to reports index) #}
    {% if request.GET.queue %}
        <li class="breadcrumb-item">
            <a href="{% url 'helpdesk:report_index' %}">{% trans "Reports" %}</a>
        </li>
        <li class="breadcrumb-item active">
            {% for q in queue_choices %}
                {% if q.id|stringformat:"s" == request.GET.queue %}
                    {{ q.title }}
                {% endif %}
            {% endfor %}
        </li>
    {% else %}
        <li class="breadcrumb-item active">{% trans "Tickets" %}</li>
        {% if from_saved_query and saved_query.user == user %}
            <li class="breadcrumb-item">{% trans "Saved Query" %}</li>
            <li class="breadcrumb-item active">{{ saved_query.title }}</li>
        {% endif %}
    {% endif %}
{% endblock %}


{% block helpdesk_body %}
<!-- Corporate UI: clean, neutral palette, clear hierarchy -->
<style>
  :root{
    --bg: #ffffff;
    --muted: #6c7783;
    --ink: #0f2b44;
    --accent: #0b57d0;
    --soft: #f6f9fc;
    --border: #e6eef6;
    --radius: 8px;
    --control-height: 40px;
    --gap: 12px;
  }

  /* Card surface */
  .card.mb-3 {
    background: #ffffff;
  }

  /* Filters bar: compact, wraps on small screens (no horizontal scroll) */
  .filters-bar {
    display: flex;
    gap: var(--gap);
    align-items: center;
    width: 100%;
    padding: 10px;
    box-sizing: border-box;
    background: transparent;
    white-space: normal;    /* allow wrap */
    overflow-x: visible;
    flex-wrap: wrap;
  }

  /* Rhythm for children */
  .filters-bar > * { box-sizing: border-box; flex: 1 1 0; min-width: 140px; }
  .filters-bar .f-search { flex: 2 1 360px; min-width: 220px; }
  .filters-bar .f-control { flex: 1 1 160px; min-width: 140px; }
  .filters-bar .f-actions { flex: 0 0 auto; display:flex; gap:8px; align-items:center; justify-content:flex-start; }

  /* Inputs & selects (applies broadly on page controls) */
  .filters-bar .form-control,
  .filters-bar .custom-select,
  select,
  input[type="search"] {
    font-size: 13px;
    padding: 8px 12px;
    height: var(--control-height);
    min-height: var(--control-height);
    border-radius: 8px;
    border: 1px solid rgba(15,23,42,0.06);
    background: #fff;
    color: var(--ink);
    box-shadow: none;
    box-sizing: border-box;
    transition: border-color .12s ease, box-shadow .12s ease, transform .06s ease;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }

  .filters-bar .form-control:focus,
  .filters-bar .custom-select:focus,
  input[type="search"]:focus {
    outline: none;
    border-color: rgba(11,87,208,0.18);
    box-shadow: 0 6px 18px rgba(11,87,208,0.06);
    transform: translateY(-1px);
  }

  /* Buttons in the filters area */
  .filters-bar .btn {
    font-size: 13px;
    padding: 8px 12px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .filters-bar .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
    box-shadow: 0 6px 18px rgba(11,87,208,0.06);
  }
  .filters-bar .btn-outline-secondary {
    background: transparent;
    border: 1px solid rgba(15,23,42,0.06);
    color: var(--ink);
  }

  /* Top table controls wrapper (DataTables buttons + mass actions) */
  #topTableControls {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
  }

  /* DataTables buttons placeholder */
  .dt-buttons-placeholder {
    display:flex;
    align-items:center;
    gap:8px;
    flex: 0 1 auto;
  }
  .dt-buttons .dt-button {
    background: #fff;
    border: 1px solid rgba(15,23,42,0.06);
    color: var(--ink);
    padding: 8px 10px;
    border-radius: 8px;
    box-shadow: none;
    font-size: 13px;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  .dt-button:hover { border-color: rgba(11,87,208,0.12); color:var(--accent); }

  /* Mass-action group (right side) */
  #topTableControls .mass-action-group {
    display:flex;
    gap:8px;
    align-items:center;
    flex: 0 0 auto;
  }
  /* make the mass action select readable and fixed width */
  #topTableControls select.form-control.form-control-sm {
    min-width: 260px;
    max-width: 420px;
    padding: 8px 12px;
    height: var(--control-height);
  }
  #topTableControls .btn-sm { padding: 6px 12px; }

  /* Ensure check/select buttons are compact */
  #topTableControls .btn-group .btn { padding: 6px 10px; }

  /* responsive behavior */
  @media (max-width: 900px) {
    .filters-bar > * { flex: 1 1 100%; min-width: 120px; }
    #topTableControls { gap:10px; }
    .dt-buttons-placeholder { order: -1; width: 100%; justify-content: flex-start; }
    #topTableControls .mass-action-group { width: 100%; justify-content: flex-start; }
    #topTableControls select.form-control.form-control-sm { width: 100%; min-width: auto; max-width: none; }
  }

  /* Ensure the tickets table becomes horizontally scrollable instead of overlapping */
  #ticketTable_wrapper {
    overflow-x: auto;                      /* allow horizontal scroll when columns grow */
    -webkit-overflow-scrolling: touch;     /* smooth scrolling on touch devices */
    position: relative;                    /* avoid absolute overlap with siblings */
  }

  /* Let the table expand to fit its columns (don't force it to squeeze) */
  #ticketTable {
    width: auto !important;
    min-width: max-content; /* grow to content width so wrapper scrolls */
    table-layout: auto;     /* let cells size naturally */
    white-space: nowrap;    /* keep rows on a single line so horizontal scroll is used */
  }

  /* Prevent TH/TD contents from wrapping and breaking layout */
  #ticketTable th,
  #ticketTable td {
    white-space: nowrap;
    vertical-align: middle;
  }

  /* Make sure the DataTables generated controls / wrapper don't collapse on small screens */
  #ticketTable_wrapper .dataTables_length,
  #ticketTable_wrapper .dataTables_filter,
  #ticketTable_wrapper .dataTables_info,
  #ticketTable_wrapper .dataTables_paginate {
    flex-shrink: 0;
  }

  /* Optional: small padding so scrollbar doesn't touch content */
  #ticketTable_wrapper { padding-bottom: 6px; }

  /* Mobile: allow the collection to be full width, but still scroll horizontally if needed */
  @media (max-width: 640px) {
    #ticketTable_wrapper { width: 100%; overflow-x: auto; }
    #ticketTable { min-width: 800px; } /* fallback minimum for very small screens */
  }

  /* Mass-action group: pin to right and visually join select + button */
  .mass-action-group {
    margin-left: auto;             /* push group to the right of the flex row */
    display: inline-flex;
    gap: 0;                        /* no gap so controls sit flush */
    align-items: center;
  }
  .mass-action-group select.form-control {
    border-radius: 8px 0 0 8px;
    border-right: none;
    min-width: 220px;
  }
  .mass-action-group .btn-go {
    border-radius: 0 8px 8px 0;
    padding: 0 14px;
    height: var(--control-height);
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* Mass-action group: unified border so select + Go look like one control */
  .mass-action-group {
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    gap: 0;
    border: 1px solid rgba(15,23,42,0.08);   /* outer border */
    border-radius: 8px;
    overflow: hidden;
    background: #ffffff;
    box-shadow: none;
  }

  /* remove individual control borders so outer border is visible */
  .mass-action-group select.form-control {
    border: none;
    border-radius: 0;
    padding: 8px 12px;
    height: var(--control-height);
    min-width: 220px;
    box-shadow: none;
    background: transparent;
  }

  /* separator line between select and button */
  .mass-action-group .btn-go {
    border: none;
    border-left: 1px solid rgba(15,23,42,0.06);
    height: var(--control-height);
    padding: 0 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--accent);
    color: #fff;
  }

  /* keep the button look consistent when using btn-primary class */
  .mass-action-group .btn-go.btn-primary {
    background: var(--accent);
    border-color: transparent;
    color: #fff;
  }

  /* focus state for accessibility */
  .mass-action-group:focus-within {
    box-shadow: 0 0 0 3px rgba(11,87,208,0.08);
    border-color: rgba(11,87,208,0.18);
  }

  /* stacked (mobile) behavior: outer border remains and children full-width */
  @media (max-width: 640px) {
    .mass-action-group {
      margin-left: 0;
      width: 100%;
      gap: 8px;
      flex-direction: column;
      border-radius: 8px;
    }
    .mass-action-group select.form-control,
    .mass-action-group .btn-go {
      width: 100%;
      border-left: none;
      border-radius: 8px;
    }
  }

  /* Align entries controls horizontally */
  #entriesControls .entries-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: nowrap;
  }
  /* Ensure DataTables' length control lays out inline */
  #entriesControls .entries-left .dataTables_length,
  #entriesControls .entries-left .dataTables_info {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  /* Make the label/select inline and compact */
  .dataTables_length label,
  .dataTables_length .form-inline {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin: 0;
    white-space: nowrap;
  }
  .dataTables_length select,
  .dataTables_length .form-control {
    display: inline-block;
    vertical-align: middle;
    width: auto;
    min-width: 64px;
    padding: 6px 8px;
    height: calc(var(--control-height) - 8px);
  }
  /* Keep the info muted and aligned */
  .dataTables_info {
    margin: 0;
    color: rgba(15,23,42,0.6);
    font-size: 13px;
  }

  /* Pagination stays on the right (no change) */
  #entriesControls .entries-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Responsive: allow wrap when there isn't enough space */
  @media (max-width: 640px) {
    #entriesControls .entries-left { flex-wrap: wrap; gap: 8px; }
    .dataTables_length label { white-space: normal; }
  }
</style>

    {# --- Query selection & filters: placed before the table for better UX --- #}
    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-filter"></i>
            {% trans "Filters" %}
        </div>
        <div class="card-body">
            {# kept design centralized in the top styles; no duplicate rules here to avoid conflicts #}

            <form method="get" class="filters-bar" aria-label="{% trans 'Ticket filters' %}">
                <div class="f-search">
                    <label class="sr-only" for="q">{% trans "Search" %}</label>
                    <input id="q" name="q" type="search" class="form-control form-control-sm" placeholder="{% trans 'Search by ID, title or ticket ID' %}" value="{{ request.GET.q|default:'' }}">
                </div>

                <div class="f-control">
                    <label class="sr-only" for="status">{% trans "Status" %}</label>
                    <select id="status" name="status" class="custom-select custom-select-sm">
                        <option value="">{% trans "All statuses" %}</option>
                        {% if status_choices %}
                            {% for val, label in status_choices %}
                                <option value="{{ val }}" {% if request.GET.status == val|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="f-control">
                    <label class="sr-only" for="priority">{% trans "Priority" %}</label>
                    <select id="priority" name="priority" class="custom-select custom-select-sm">
                        <option value="">{% trans "All priorities" %}</option>
                        {% if priority_choices %}
                            {% for val, label in priority_choices %}
                                <option value="{{ val }}" {% if request.GET.priority == val|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="f-control">
                    <label class="sr-only" for="queue">{% trans "Queue" %}</label>
                    <select id="queue" name="queue" class="custom-select custom-select-sm">
                        <option value="">{% trans "All queues" %}</option>
                        {% if queue_choices %}
                            {% for q in queue_choices %}
                                <option value="{{ q.id }}" {% if request.GET.queue == q.id|stringformat:"s" or request.GET.queue == q.slug %}selected{% endif %}>{{ q.title }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="f-actions">
                    <button type="submit" class="btn btn-primary btn-sm" title="{% trans 'Apply filters' %}">{% trans "Apply" %}</button>
                    <a href="{% url 'helpdesk:list' %}" class="btn btn-outline-secondary btn-sm" title="{% trans 'Reset filters' %}">{% trans "Reset" %}</a>
                </div>

            </form>

            <script>
              // small helper to reveal advanced filter cards by id
              function onFilterChange(value){
                if(!value) return;
                // mapping for legacy values if ever used
                const map = {
                  'Sort':'filterBoxSort','Priority':'filterBoxPriority','Owner':'filterBoxOwner',
                  'Queue':'filterBoxQueue','Status':'filterBoxStatus','Keywords':'filterBoxKeywords',
                  'Dates':'filterBoxDates','KBItems':'filterBoxKBItems'
                };
                const id = map[value] || value;
                const el = document.getElementById(id);
                if(!el) { document.getElementById('filterBuilderSelect').value=''; return; }
                el.classList.add('filterBoxShow');
                setTimeout(()=> el.scrollIntoView({behavior:'smooth', block:'center'}),100);
                document.getElementById('filterBuilderSelect').value='';
              }
            </script>
        </div>
    </div>
    <!-- end top card -->

    {# --- Move mass-action & top controls here (below query selection, above the table) --- #}
    <form method='post' action='{% url 'helpdesk:mass_update' %}' id="ticket_mass_update">
        {% csrf_token %}
        <div id="topTableControls" class="d-flex align-items-center mb-3">
            <div class="dt-buttons-placeholder">
                {# DataTables will move its buttons (Column visibility etc.) here on init via JS. #}
            </div>

            <div class="mass-action-group">
                <select name='action' id='id_mass_action' class="form-control form-control-sm">
                    <option value='delete'>{% trans "Delete" %}</option>
                    <optgroup label='{% trans "Close" %}'>
                        <option value='close'>{% trans "Close (Don't Send E-Mail)" %}</option>
                        <option value='close_public'>{% trans "Close (Send E-Mail)" %}</option>
                    </optgroup>
                    <optgroup label='{% trans "Assign To" %}'>
                        <option value='unassign'>{% trans "Nobody (Unassign)" %}</option>
                        {% for u in assignable_users %}
                            {% if u.is_staff and not u.is_superuser %}
                                <option value='assign_{{ u.id }}'>{{ u.get_username }}</option>
                            {% endif %}
                        {% endfor %}
                    </optgroup>
                </select>

                <button type="submit" class="btn btn-primary btn-go" aria-label="{% trans 'Go' %}">
                    <i class="fas fa-arrow-circle-right"></i>
                </button>
            </div>
        </div>
    {# form remains open and will wrap the table card below #}

    {# --- Table card: now after the filters --- #}
    <div class="card">
        {% if helpdesk_settings.HELPDESK_TICKETS_TIMELINE_ENABLED %}
        <div class="card-header" style="background-color: #ffffffff;">
            <ul class="nav nav-tabs">
                <li class="nav-item" style="width: 200px;">
                    {% trans "Query Results" %}:
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#datatabletabcontents" id="datatabletabcontents-tab"
                       data-toggle="tab" role="tab" aria-controls="datatabletabcontents" aria-selected=true>
                        <i class="fas fa-th-list"></i>
                        {% trans "Table" %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#timelinetabcontents" id="timelinetabcontents-tab" data-toggle="tab"
                       role="tab" aria-controls="timelinetabcontents" aria-selected=false>
                        <i class="fas fa-history"></i>
                        {% trans "Timeline" %}
                    </a>
                </li>
            </ul>
        </div>
        {% endif %}
        <div class="card-body">
            {{ search_message|safe }}
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="datatabletabcontents" role="tabpanel"
                     aria-labelledby="datatabletabcontents-tab">
                        <table class="table table-sm table-striped table-bordered table-hover"
                               id="ticketTable" data-page-length='{{ default_tickets_per_page }}'>
                            <thead class="thead-light">
                            <tr>
                                <th></th>
                                <th>{% trans "Ticket" %}</th>
                                <th>{% trans "Priority" %}</th>
                                <th>{% trans "Queue" %}</th>
                                <th>{% trans "Status" %}</th>
                                <th>{% trans "Created" %}</th>
                                <th>{% trans "Due Date" %}</th>
                                <th>{% trans "Owner" %}</th>
                                <th>{% trans "Submitter" %}</th>
                                <th>{% trans "Last Followup" %}</th>
                                {% if helpdesk_settings.HELPDESK_ENABLE_TIME_SPENT_ON_TICKET %}<th>{% trans "Time Spent" %}</th>{% endif %}
                                {% if helpdesk_settings.HELPDESK_KB_ENABLED %}<th>{% trans "KB item" %}</th>{% endif %}
                            </tr>
                            </thead>
                        </table>
                    </form>
                </div>
                {% if helpdesk_settings.HELPDESK_TICKETS_TIMELINE_ENABLED %}
                <div class="tab-pane fade" id="timelinetabcontents" role="tabpanel" aria-labelledby="timelinetabcontents-tab">
                    <div id='timeline-embed' style="width: 100%; height: 80vh"></div>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- /.panel-body -->
    </div>
    <!-- /.panel -->

    <!-- Entries controls (DataTables length & pagination) will be moved here on init -->
    <div id="entriesControls" class="d-flex justify-content-between align-items-center mt-3"></div>

{% endblock %}


{% block helpdesk_js %}
    <script src='{% static "helpdesk/filter.js" %}'></script>
    <!-- Timeline 3 JavaScript -->
    {% if helpdesk_settings.HELPDESK_USE_CDN %}
    <script src="https://cdn.knightlab.com/libs/timeline3/latest/js/timeline.js"></script>
    {% else %}
    <script src="{% static 'helpdesk/vendor/timeline3/js/timeline.js' %}"></script>
    {% endif %}

    <script>
        window.helpdesk_settings = {
            LANGUAGE_CODE: "{{ helpdesk_settings.LANGUAGE_CODE|default:'en-US' }}",
            NO_FOLLOWUP_TEXT: "{% trans helpdesk_settings.ALTERNATIVE_UI_STRINGS.No_followup_found|default:'No followup found' %}"
        };

        function get_url(row) {
            return "{% url 'helpdesk:view' 1234 %}".replace(/1234/, row.id.toString());
        }
        
        function htmlEntities(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        $(document).ready(function () {
            // Ticket DataTable Initialization
        $.fn.dataTable.ext.errMode = function(settings, helpPage, message) {
        alert("{% trans 'Error fetching tickets occured, please contact the system administrators of this server providing the message below:\n    ' %}" + message)
        };
            var ticketTable = $('#ticketTable').DataTable({
                language: {
                    "emptyTable": "{% trans 'No Tickets Match Your Selection' %}"
                },
                processing: true,
                serverSide: true,
                ajax: {
                    "url": "{% url 'helpdesk:datatables_ticket_list' urlsafe_query %}",
                    "type": "GET",
                },
                createdRow: function (row, data, dataIndex) {
                    $(row).addClass(data.row_class);
                },
                dom: 'ltBp',
                buttons: [
                    {
                        extend: 'colvis',
                        columns: ':not(.no-colvis)'
                    }
                ],
                columns: [
                    {
                        data: "id",
                        className: 'no-colvis',
                        orderable: false,
                        render: function (data, type, row, meta) {
                            const pk = data;
                            if (type === 'display') {
                                data = "<input type='checkbox' name='ticket_id' value='" + pk + "' class='ticket_multi_select' />"
                            }
                            return data
                        }
                    },
                    {
                        data: "ticket",
                        render: function (data, type, row, meta) {
                            if (type === 'display') {
                                data = '<div class="tickettitle"><a href="' + get_url(row) + '" >' +
                                    row.id + '. ' +
                                    htmlEntities(row.title) + '</a></div>';
                            }
                            return data
                        }
                    },
                    {
                        data: "priority",
                        render: function (data, type, row, meta) {
                            let priorityClass = "text-secondary";
                            switch (data) {
                                case 1:
                                    priorityClass = "text-danger";
                                    break;
                                case 2:
                                    priorityClass = "text-warning";
                                    break;
                                case 3:
                                    priorityClass = "text-success";
                                    break;
                                case 4:
                                    priorityClass = "text-info";
                                    break;
                                case 5:
                                    priorityClass = "text-secondary";
                                    break;
                            }
                            return '<p class="' + priorityClass + '">' + data + '</p>';
                        },
                        visible: false,
                    },
                    {
                        data: "queue",
                        render: function (data, type, row, meta) {
                            return data.title;
                        },
                        visible: false,
                    },
                    {data: "status"},
                    {data: "created"},
                    {data: "due_date", "visible": false},
                    {
                        data: "assigned_to",
                        render: function (data, type, row, meta) {
                            if (data !== "None") {
                                return data;
                            }
                            return "";
                        }
                    },
                    {data: "submitter"},
                    {
                        data: "last_followup",
                        render: function (data, type, row) {
                            let locale = navigator.language || navigator.userLanguage || window.helpdesk_settings.LANGUAGE_CODE;
                            
                            if (isNaN(Date.parse(data))) {
                                return window.helpdesk_settings.NO_FOLLOWUP_TEXT;
                            }

                            let date = new Date(data);
                            return date.toLocaleString(locale, {
                                weekday: "short",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                                hour: "2-digit",
                                minute: "2-digit",
                                hour12: true
                            });
                        }
                    },
                    {% if helpdesk_settings.HELPDESK_ENABLE_TIME_SPENT_ON_TICKET %}
                    {data: "time_spent", "visible": false},
                    {% endif %}
                    {% if helpdesk_settings.HELPDESK_KB_ENABLED %}
                    {data: "kbitem", className: 'no-colvis', visible: false},
                    {% endif %}
                ],
                initComplete: function(settings, json) {
                    try {
                        var container = $('#entriesControls');
                        if(!container.length) return;
                        if(!container.find('.entries-left').length){
                            container.html('<div class="entries-left d-flex align-items-center"></div><div class="entries-right"></div>');
                        }
                        var left = container.find('.entries-left');
                        var right = container.find('.entries-right');
                        // Move length control and info to left, pagination to right
                        $('.dataTables_length').appendTo(left);
                        $('.dataTables_info').appendTo(left).addClass('ml-2 text-muted small');
                        $('.dataTables_paginate').appendTo(right);
                        // Replace the length <select> with a numeric input so users can type a custom page size
                        try {
                            var lengthSelect = left.find('.dataTables_length select');
                            if(lengthSelect.length) {
                                var current = parseInt(lengthSelect.val(), 10) || ticketTable.page.len();
                                var input = $('<input/>', {
                                    type: 'number',
                                    min: 1,
                                    step: 1,
                                    value: current,
                                    class: 'form-control form-control-sm d-inline-block',
                                    style: 'width:80px; margin-left:8px;'
                                });
                                lengthSelect.replaceWith(input);
                                input.on('change', function() {
                                    var v = parseInt($(this).val(), 10);
                                    if (isNaN(v) || v < 1) v = ticketTable.page.len();
                                    ticketTable.page.len(v).draw(false);
                                });
                            }
                        } catch (e) {
                            console.warn('Could not replace length select', e);
                        }
                        // move DataTables buttons (colvis) into the top placeholder (below filters)
                        $('.dt-buttons').appendTo($('.dt-buttons-placeholder'));
                    } catch (e) {
                        console.warn('Could not relocate DataTables controls', e);
                    }
                },
                drawCallback: function(settings) {
                    // Ensure controls stay in place after draw (pagination redraws)
                    var container = $('#entriesControls');
                    if(!container.length) return;
                    var left = container.find('.entries-left');
                    var right = container.find('.entries-right');
                    $('.dataTables_length').appendTo(left);
                    $('.dataTables_info').appendTo(left);
                    $('.dataTables_paginate').appendTo(right);
                    // ensure buttons stay in the top placeholder after redraws
                    $('.dt-buttons').appendTo($('.dt-buttons-placeholder'));
                    // Ensure the length select is replaced with the numeric input after redraws
                    try {
                        var lengthSelect = left.find('.dataTables_length select');
                        if(lengthSelect.length) {
                            // already a select, swap it out
                            var current = ticketTable.page.len();
                            var input = $('<input/>', {
                                type: 'number',
                                min: 1,
                                step: 1,
                                value: current,
                                class: 'form-control form-control-sm d-inline-block',
                                style: 'width:80px; margin-left:8px;'
                            });
                            lengthSelect.replaceWith(input);
                            input.on('change', function() {
                                var v = parseInt($(this).val(), 10);
                                if (isNaN(v) || v < 1) v = ticketTable.page.len();
                                ticketTable.page.len(v).draw(false);
                            });
                        }
                    } catch (e) {
                        console.warn('Could not replace length select on redraw', e);
                    }
                },
                order: []
            });

            {# Timeline initialization when tab is displayed #}
            // The TL.Timeline constructor takes at least two arguments:
            // the id of the Timeline container (no '#'), and
            // the URL to your JSON data file or Google spreadsheet.
            // the id must refer to an element "above" this code,
            // and the element must have CSS styling to give it width and height
            // optionally, a third argument with configuration options can be passed.
            // See below for more about options.
            let timeline_loaded = false;
            $('#timelinetabcontents-tab').on('shown.bs.tab', function (e) {
                if (!timeline_loaded) {
                    new TL.Timeline(
                        'timeline-embed',
                        '{% url 'helpdesk:timeline_ticket_list' urlsafe_query %}'
                    );
                    timeline_loaded = true;
                }
            });

            {# Shortcuts to select/unselect multiple tickets #}
            $("#select_all_btn").click(function () {
                $(".ticket_multi_select").prop('checked', true);
            });
            $("#select_none_btn").click(function () {
                $(".ticket_multi_select").prop('checked', false);
            });
            $("#select_inverse_btn").click(function () {
                $(".ticket_multi_select").each(function () {
                    $(this).prop('checked', !$(this).prop('checked'));
                });
            });
        })
    </script>
{% endblock %}

