{% extends "helpdesk/base.html" %}{% load i18n %}

{% block helpdesk_title %}{% trans "Initial setup" %}{% endblock %}

{% block header %}
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Poppins:wght@500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

<nav class="pd-header" aria-label="Primary" style="background:#071a6b;">
        <div class="pd-header-inner" style="width:100%;margin:0;display:flex;align-items:center;justify-content:flex-start;padding:10px 16px;">
        <div class="pd-left" style="display:flex;align-items:center;">
            <a class="pd-brand no-asterisk" href="/" style="margin-top:5px;margin-bottom:5px;color:#fff;text-decoration:none;font-weight:700;font-size:16px;line-height:1;user-select:none;font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial;">
                PrimeDesk Technologies
            </a>
        </div>
    </div>
</nav>

    <style>
    /* Hide browser default password eye icon (Chrome/Edge) */
    input[type="password"]::-ms-reveal,
    input[type="password"]::-webkit-credentials-auto-fill-button {
        display: none !important;
    }
        /* Hide the regular sidebar and hamburger for the initial setup page */
        #helpdesk-sidebar { display: none !important; }
        .sidebar-toggle-btn { display: none !important; }
        /* Ensure content fills available width */
        #content-wrapper { margin-left: 0 !important; }
        /* Hide breadcrumbs on this page (clean header) */
        ol.breadcrumb { display: none !important; }
        /* Tweak widths so single-field rows don't look too long, and two-field rows don't look too short */
        /* Two-column fields (col-md-6) should fill their column */
        .card .col-md-6 input,
        .card .col-md-6 select,
        .card .col-md-6 textarea,
        .card .col-md-6 .form-control {
            /* keep two-column fields visually consistent but bounded so they don't grow
               when container padding changes */
            width: min(80%, 320px);
            max-width: 320px;
        }

        /* Single-row fields (col-12) should be slightly narrower and centered */
            .card .col-12 input,
            .card .col-12 select,
            .card .col-12 textarea,
            .card .col-12 .form-control {
                /* single-row fields stay bounded to avoid growing when padding changes */
                max-width: 500px; /* slightly shorter single-row fields */
                width: min(90%, 580px);
                margin: 0; /* align to left */
                box-sizing: border-box;
                display: block;
            }

              /* Reduce inner right padding of the card body so the form's right gap is smaller
                  without changing input widths or field styles. Restore on very small screens. */
              .card .card-body { padding-right: 20px; }

        /* On very small screens, allow inputs to use full width */
        @media (max-width: 576px) {
            .card .col-12 .form-control,
            .card .col-12 input,
            .card .col-12 select,
            .card .col-12 textarea {
                max-width: 100%;
            }
            /* avoid squeezing inputs on very small screens */
            .card .card-body { padding-right: initial; }
        }

        /* Add this inside your <style> block */
.btn.btn-lg.btn-primary.login-submit {
    font-size: 1.25rem;         /* Large text */
    padding: 0.5rem 2rem;       /* More vertical and horizontal padding */
    border-radius: 15px;        /* Rounded corners */
    background-color: #000C7D;  /* PrimeDesk blue */
    color: #fff;                /* White text */
    border: none;               /* No border */
    font-weight: 600;           /* Semi-bold */
    box-shadow: 0 2px 8px rgba(0,12,125,0.08); /* Subtle shadow */
    transition: background 0.2s, box-shadow 0.2s;
}
.btn.btn-lg.btn-primary.login-submit:hover,
.btn.btn-lg.btn-primary.login-submit:focus {
    background-color: #0015c2;  /* Slightly lighter blue on hover/focus */
    color: #fff;
    box-shadow: 0 4px 16px rgba(0,12,125,0.15);
}

/* ====== FONT ASSIGNMENTS (requested) ======
   - Heading 1: Montserrat
   - Buttons: Poppins
   - Subtitle / secondary text: Roboto
*/
h1, .register-card h1 {
    font-family: 'Montserrat', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    font-weight: 700;
    letter-spacing: -0.2px;
}

/* Card header title (h5) should also use Montserrat for visual consistency */
.card-header h5 {
    font-family: 'Montserrat', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    font-weight: 700;
}

/* Buttons use Poppins */
.btn, .btn-primary, .btn-secondary, .pd-login-btn, .pd-hamburger, .pd-header .pd-login-btn, button[type="submit"] {
    font-family: 'Poppins', "Helvetica Neue", Arial, sans-serif;
    font-weight: 600;
}

/* Override: make the primary/create button not bold */
.btn.btn-primary.login-submit {
    font-weight: 400 !important;
}

/* Subtitle / lead / muted text use Roboto */
p.lead, .text-muted, .card .text-muted {
    font-family: 'Roboto', system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    font-weight: 400;
    color: #6b7280;
}

/* Ensure smaller headings that should read as subtitles also inherit Roboto */
.small-subtitle, .form-note {
    font-family: 'Roboto', system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
}

/* minor: ensure inputs keep system fallback for legibility */
.form-control, input, textarea, select {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
}

/* Button: match provided rounded dark "Create account" style */
.card .btn.btn-primary.login-submit,
.btn.btn-primary.login-submit {
  display: inline-block;
  min-width: 160px;
  padding: 10px 28px;
  border-radius: 22px;
  background: #000C7D; /* PrimeDesk blue */
  color: #ffffff;
  border: 1px solid rgba(255,255,255,0.06);
  font-family: 'Poppins', sans-serif;
  font-weight: 600;
  font-size: 14px;
  line-height: 1;
  text-align: center;
  transition: transform 120ms ease, box-shadow 120ms ease, background-color 120ms ease;
}

.card .btn.btn-primary.login-submit:hover,
.card .btn.btn-primary.login-submit:focus {
  background: #0013c2ff; /* PrimeDesk blue */;
  transform: translateY(-1px);
  outline: none;
}

.card .btn.btn-primary.login-submit:active {
  transform: translateY(0);
  box-shadow: 0 4px 8px rgba(2,6,23,0.22), inset 0 -1px 0 rgba(0,0,0,0.35);
}

.card .btn.btn-primary.login-submit[disabled],
.card .btn.btn-primary.login-submit[aria-disabled="true"] {
  background: #4a4a4a;
  border-color: #3b3b3b;
  opacity: 0.9;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}

/* ensure consistent box sizing so widths include padding/border */
.card, .card * { box-sizing: border-box; }

/* remove any outer padding on card and keep a single equal padding inside */
.card { padding: 0; margin: 0 auto; max-width: 550px; width: 100%; }
.card .card-body {
    padding: 24px !important; /* equal padding on all sides */
    box-sizing: border-box;
}

/* Make all inputs fill their column exactly so there's no right whitespace */
.card .col-md-6 input,
.card .col-md-6 select,
.card .col-md-6 textarea,
.card .col-md-6 .form-control,
.card .col-12 input,
.card .col-12 select,
.card .col-12 textarea,
.card .col-12 .form-control {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0;
}

/* Ensure two-column name-row uses the full width without leaving gaps */
.name-row { display: block; }
@media (min-width: 576px) {
    .name-row { display: flex; gap: 10px; }
    .name-row > .col-md-6 { flex: 1 1 0; max-width: none; }
    .name-row .form-control { width: 100%; }
}

/* Align the action button to the right end of its column */
.form-actions {
    width: 100%;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    align-items: center;
    box-sizing: border-box;
}

/* On narrow screens, stack actions and allow full-width buttons */
@media (max-width: 576px) {
    .form-actions { justify-content: center; flex-direction: column-reverse; gap: 10px; }
    .form-actions .btn { width: 100% !important; min-width: 0; }
}

/* small-screen safety: ensure wrapper padding doesn't cause horizontal overflow */
.d-flex.justify-content-center.align-items-center {
    padding-left: 16px;
    padding-right: 16px;
}

        /* remove any earlier rules that force an extra right padding */
        .card .card-body { padding-right: 24px !important; } /* keep equal padding */

        /* Make inputs match the register form visuals: compact padding, subtle border and focus ring */
        .card .form-control {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #d9d9d9;
            background: #fff;
            box-sizing: border-box;
        }
        .card .form-control:focus {
            outline: none;
            border-color: #9bb0ff;
            box-shadow: 0 0 0 3px rgba(16,87,255,0.06);
        }

    /* toggle-eye visuals (match login page)
       Anchor the toggle to the input element itself using an inner wrapper
       so label/errors changing the field height won't move the icon. */
        .input-with-toggle { position: relative; display: block; }
        .input-with-toggle .form-control { padding-right: 44px; /* room for the eye */ }
        .toggle-eye {
            position: absolute;
            right: 12px; /* inside the input */
            top: 50%;    /* vertically centered relative to the input */
            transform: translateY(-50%);
            background: transparent;
            border: none;
            padding: 4px;
            color: #4b5563;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            z-index: 2; /* ensure it sits above the input */
        }
        /* remove focus highlight when clicked */
        .toggle-eye:focus, .toggle-eye:focus-visible, .toggle-eye:active {
            outline: none !important;
            box-shadow: none !important;
        }
        .toggle-eye svg { display: block; width: 18px; height: 18px; }
        .eye-open { opacity: 0; transition: opacity 120ms ease; }
        .eye-closed { opacity: 1; transition: opacity 120ms ease; }
        .toggle-eye[aria-pressed="true"] .eye-open { opacity: 1; }
        .toggle-eye[aria-pressed="true"] .eye-closed { opacity: 0; }

        /*
         * Append a visual asterisk to most visible text elements inside the card body.
         * Exceptions are marked with the .no-asterisk class (PrimeDesk brand, the h6
         * heading and subtitle are marked below).
         *
         * We explicitly avoid adding stars to error messages and form controls.
         */
        .card .card-body label:not(.no-asterisk):not(.text-danger):not(.form-errors)::after,
        .card .card-body .form-label:not(.no-asterisk):not(.text-danger):not(.form-errors)::after,
        .card .card-body p:not(.no-asterisk):not(.text-danger):not(.form-errors):not(.server-field-error)::after,
        .card .card-body .lead:not(.no-asterisk):not(.text-danger):not(.form-errors)::after,
        .card .card-body h1:not(.no-asterisk):not(.text-danger):not(.form-errors)::after,
        .card .card-body h2:not(.no-asterisk):not(.text-danger):not(.form-errors)::after,
        .card .card-body h3:not(.no-asterisk):not(.text-danger):not(.form-errors)::after,
        .card .card-body h4:not(.no-asterisk):not(.text-danger):not(.form-errors)::after,
        .card .card-body h5:not(.no-asterisk):not(.text-danger):not(.form-errors)::after,
        .card .card-body a:not(.no-asterisk):not(.text-danger):not(.form-errors)::after,
        .card .card-body button:not(.no-asterisk):not(.text-danger):not(.form-errors)::after,
        .card .card-body .btn:not(.no-asterisk):not(.text-danger):not(.form-errors)::after {
            content: " *";
            color: #d32f2f;
            font-weight: 600;
            margin-left: 4px;
            display: inline-block;
            line-height: 1;
        }

        /* explicitly do not append for these classes (safety) */
        .card .card-body .field-error::after,
        .card .card-body .server-field-error::after,
        .card .card-body .form-errors::after {
            content: none !important;
        }

    </style>
{% endblock %}

{% block helpdesk_body %}
<div class="d-flex justify-content-center align-items-center" style="padding:48px; min-height: calc(100vh - 72px);">
    <div class="card" style="max-width:550px; width:100%; box-shadow: 0 6px 18px rgba(2,6,23,0.12); border-radius:12px;">
        <div class="card-body">
                    <h6 class="mb-0 no-asterisk">{% trans "Create the first admin account" %}</h6>
                    <p class="text-muted no-asterisk" style="margin-top: 8px">{% trans "Create the first admin account for this helpdesk installation. This is only required once." %}</p>

            <form method="post" novalidate>
                {% csrf_token %}
        {% if form.non_field_errors %}
            {% for err in form.non_field_errors %}
                <div class="alert alert-danger">{% if err == "A user with that email address already exists." %}Invalid Email.{% else %}{{ err }}{% endif %}</div>
            {% endfor %}
        {% endif %}

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="id_first_name" class="form-label">{{ form.first_name.label }}</label>
                        {{ form.first_name }}
                        {% for err in form.first_name.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                        <div id="id_first_name-client-error" class="text-danger small" aria-live="polite"></div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="id_last_name" class="form-label">{{ form.last_name.label }}</label>
                        {{ form.last_name }}
                        {% for err in form.last_name.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                        <div id="id_last_name-client-error" class="text-danger small" aria-live="polite"></div>
                    </div>

                    <div class="col-12 mb-3">
                        <label for="id_username" class="form-label">{{ form.username.label }}</label>
                        {{ form.username }}
                        {% for err in form.username.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                        <div id="id_username-client-error" class="text-danger small" aria-live="polite"></div>
                    </div>

                    <div class="col-12 mb-3">
                        <label for="id_email" class="form-label">{{ form.email.label }}</label>
                        {{ form.email }}
                        {% for err in form.email.errors %}
                            <div class="text-danger small">{% if err == "A user with that email address already exists." %}Invalid Email.{% else %}{{ err }}{% endif %}</div>
                        {% endfor %}
                        <div id="id_email-client-error" class="text-danger small" aria-live="polite"></div>
                    </div>

                    <div class="col-12 mb-3 password-field">
                        <label for="id_password1" class="form-label">{{ form.password1.label }}</label>
                        <div class="input-with-toggle">
                            {% with field=form.password1 %}
                                {% if field %}
                                    {% with widget=field.field.widget %}
                                        {% if widget.input_type == "password" %}
                                            {% with attrs=field.field.widget.attrs %}
                                                {% if attrs %}
                                                    {% with attrs=attrs|dictsort:"0" %}
                                                        {% for k,v in attrs %}
                                                            {% if k == "autocomplete" %}{% else %}{% endif %}
                                                        {% endfor %}
                                                    {% endwith %}
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            {% endwith %}
                            {{ form.password1 }}
                            <button type="button" class="toggle-eye no-asterisk" aria-label="Toggle password visibility" data-target="id_password1" aria-pressed="false">
                                <svg class="eye-svg" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                                    <g class="eye-open" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M1.5 12s4-6.5 10.5-6.5S22.5 12 22.5 12s-4 6.5-10.5 6.5S1.5 12 1.5 12z" />
                                        <circle class="iris" cx="12" cy="12" r="3" fill="currentColor" />
                                    </g>
                                    <g class="eye-closed" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 12c3.5-3 7-3 9-3s5.5 0 9 3" />
                                    </g>
                                </svg>
                            </button>
                        </div>
                        {% for err in form.password1.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                        <div id="id_password1-client-error" class="text-danger small" aria-live="polite"></div>
                    </div>

                    <div class="col-12 mb-3 password-field">
                        <label for="id_password2" class="form-label">{{ form.password2.label }}</label>
                        <div class="input-with-toggle">
                            {{ form.password2 }}
                            <button type="button" class="toggle-eye no-asterisk" aria-label="Toggle password visibility" data-target="id_password2" aria-pressed="false">
                                <svg class="eye-svg" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                                    <g class="eye-open" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M1.5 12s4-6.5 10.5-6.5S22.5 12 22.5 12s-4 6.5-10.5 6.5S1.5 12 1.5 12z" />
                                        <circle class="iris" cx="12" cy="12" r="3" fill="currentColor" />
                                    </g>
                                    <g class="eye-closed" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 12c3.5-3 7-3 9-3s5.5 0 9 3" />
                                    </g>
                                </svg>
                            </button>
                        </div>
                        {% for err in form.password2.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                        <div id="id_password2-client-error" class="text-danger small" aria-live="polite"></div>
                    </div>
                </div>
                

                <div class="row">
                    <div class="col-12">
                        <div class="form-actions" style="width:100%; margin:0; display:flex; justify-content:flex-end;">
                            <button type="submit" class="btn btn-primary login-submit no-asterisk">{% trans "Create admin" %}</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block helpdesk_js %}
<script>
    (function(){
        // Validation adapted from register.html
        var card = document.querySelector('.card');
        if(!card) return;

        // Ensure inputs have form-control class for consistent styling
        Array.prototype.forEach.call(card.querySelectorAll('input, textarea, select'), function(f){
            if(!f.classList.contains('form-control')) f.classList.add('form-control');
        });

        var first = document.getElementById('id_first_name');
        var last = document.getElementById('id_last_name');
        var username = document.getElementById('id_username');
        var email = document.getElementById('id_email');
        var pwd1 = document.getElementById('id_password1');
        var pwd2 = document.getElementById('id_password2');

        var firstErr = document.getElementById('id_first_name-client-error');
        var lastErr = document.getElementById('id_last_name-client-error');
        var usernameErr = document.getElementById('id_username-client-error');
        var emailErr = document.getElementById('id_email-client-error');
        var pwd1Err = document.getElementById('id_password1-client-error');
        var pwd2Err = document.getElementById('id_password2-client-error');

        var submitBtn = card.querySelector('button[type="submit"]');

        var REQUIRED_MSG = 'Please fill in the required field.';
    var INVALID_NAME_MSG = 'Invalid character.';
        var USERNAME_MIN = 3;
    var USERNAME_MIN_MSG = 'Username must be at least 3 characters.';

        function showError(el, box, msg){
            if(!box) return;
            box.textContent = msg;
            box.style.visibility = 'visible';
            if(el) el.classList.add('is-invalid');
            if(el) el.setAttribute('aria-invalid','true');
            if(el) el.setAttribute('aria-describedby', box.id);
        }
        function clearError(el, box){
            if(!box) return;
            box.textContent = '';
            box.style.visibility = 'hidden';
            if(el) el.classList.remove('is-invalid');
            if(el) el.removeAttribute('aria-invalid');
            if(el) el.removeAttribute('aria-describedby');
        }

        function validateNameField(el, box, showErrors){
            if(!el) return true;
            var v = (el.value || '').trim();
            if(!v){ if(showErrors) showError(el, box, REQUIRED_MSG); return false; }
            var validNameRe = /^[\p{L} .'\-]+$/u;
            if(!validNameRe.test(v)) { if(showErrors) showError(el, box, INVALID_NAME_MSG); return false; }
            clearError(el, box);
            return true;
        }

        function validateUsername(showErrors){
            if(!username) return true;
            var v = (username.value || '').trim();
            if(!v){ if(showErrors && touched.username) showError(username, usernameErr, REQUIRED_MSG); return false; }
            if(v.length < USERNAME_MIN){ if(showErrors) showError(username, usernameErr, USERNAME_MIN_MSG); return false; }
            clearError(username, usernameErr);
            return true;
        }

        function validateEmail(showErrors){
            if(!email) return true;
            var v = (email.value || '').trim();
            if(!v){ if(showErrors) showError(email, emailErr, REQUIRED_MSG); return false; }
            var re = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
            if(!re.test(v)){ if(showErrors) showError(email, emailErr, 'Please enter a valid email address.'); return false; }
            clearError(email, emailErr);
            return true;
        }

        function validatePasswords(showPwd1Errors, showPwd2Errors){
            var v1 = (pwd1 && pwd1.value) ? pwd1.value : '';
            var v2 = (pwd2 && pwd2.value) ? pwd2.value : '';
            var ok = true;

            if(!v1){ if(showPwd1Errors) showError(pwd1, pwd1Err, REQUIRED_MSG); ok = false; }
            else {
                var parts = [];
                var lengthTooShort = v1.length < 8;
                var missing = [];
                if(!/[A-Z]/.test(v1)) missing.push('uppercase');
                if(!/[a-z]/.test(v1)) missing.push('lowercase');
                if(!/[0-9]/.test(v1)) missing.push('number');
                // require at least one non-alphanumeric (special) character
                if(!/[^A-Za-z0-9]/.test(v1)) missing.push('special character');
                // If there are other missing requirements, don't add a period to the
                // length message so it can flow into the "and must contain ..." clause.
                if(lengthTooShort){
                    if(missing.length) parts.push('Password must be at least 8 characters long');
                    else parts.push('Password must be at least 8 characters long.');
                }
                if(missing.length || parts.length){
                    // helper to format arrays as natural language lists
                    var formatList = function(arr){
                        if(!arr || arr.length === 0) return '';
                        if(arr.length === 1) return arr[0];
                        if(arr.length === 2) return arr[0] + ' and ' + arr[1];
                        return arr.slice(0, -1).join(', ') + ', and ' + arr[arr.length-1];
                    };
                    var containPrefix = parts.length ? 'and must contain ' : 'Password must contain ';
                    var msg = parts.concat(missing.length ? [containPrefix + formatList(missing)] : []).join(' ');
                    msg = msg.trim();
                    if(msg.charAt(msg.length-1) !== '.') msg += '.';
                    if(showPwd1Errors) showError(pwd1, pwd1Err, msg);
                    ok = false;
                } else { clearError(pwd1, pwd1Err); }
            }

            if(!v2){ if(showPwd2Errors) showError(pwd2, pwd2Err, REQUIRED_MSG); ok = false; }
            else { clearError(pwd2, pwd2Err); }

            if(v1 && v2 && v1 !== v2){ showError(pwd2, pwd2Err, 'Password did not match.'); ok = false; }

            return ok;
        }

        // touched flags
        var touched = { first_name:false, last_name:false, username:false, email:false, password1:false, password2:false };

    function setTouchedOnPointer(el, key){ if(!el) return; el.addEventListener('pointerdown', function(){ touched[key]=true; }); el.addEventListener('mousedown', function(){ touched[key]=true; }); el.addEventListener('focus', function(){ touched[key]=true; }); el.addEventListener('keydown', function(){ touched[key]=true; }); }

        function attachFieldHandlers(el, validator, boxId, key){ if(!el) return; var box=document.getElementById(boxId);
            // validate on input but only show messages after the field is touched; always show on blur
            el.addEventListener('input', function(){ validator(touched[key]); checkFormValidity(); });
            el.addEventListener('blur', function(){ validator(true); checkFormValidity(); });
            setTouchedOnPointer(el, key);
        }

        attachFieldHandlers(first, function(show){ return validateNameField(first, firstErr, show); }, 'id_first_name-client-error', 'first_name');
        attachFieldHandlers(last, function(show){ return validateNameField(last, lastErr, show); }, 'id_last_name-client-error', 'last_name');
        attachFieldHandlers(username, function(show){ return validateUsername(show); }, 'id_username-client-error', 'username');
        attachFieldHandlers(email, function(show){ return validateEmail(show); }, 'id_email-client-error', 'email');

        // Passwords special handlers
        function attachPasswordHandlers(pwEl, box, key){
            if(!pwEl) return;
            // typing in password1 should not show the 'required' error for confirm (password2)
            if(key === 'password1'){
                pwEl.addEventListener('input', function(){ validatePasswords(true, false); checkFormValidity(); });
            } else if(key === 'password2'){
                // typing in confirm should show confirm-related errors but avoid prematurely showing password1-specific requirements
                pwEl.addEventListener('input', function(){ validatePasswords(false, true); checkFormValidity(); });
            } else {
                pwEl.addEventListener('input', function(){ validatePasswords(true, true); checkFormValidity(); });
            }
            pwEl.addEventListener('blur', function(){ validatePasswords(touched.password1, touched.password2); checkFormValidity(); });
            setTouchedOnPointer(pwEl, key);
        }
        attachPasswordHandlers(pwd1, pwd1Err, 'password1');
        attachPasswordHandlers(pwd2, pwd2Err, 'password2');

        // Prevent paste into confirm password
        if(pwd2){ pwd2.addEventListener('paste', function(e){ e.preventDefault(); }); pwd2.addEventListener('drop', function(e){ e.preventDefault(); }); }

        function checkFormValidity(){
            var requiredIds = [first, last, username, email, pwd1, pwd2];
            var filled = requiredIds.every(function(el){ return el && el.value && el.value.trim().length>0; });
            var namesOk = validateNameField(first, firstErr, false) && validateNameField(last, lastErr, false);
            var pwdOk = validatePasswords(false, false);
            if(filled && namesOk && pwdOk && validateUsername(false) && validateEmail(false)){
                if(submitBtn) { submitBtn.disabled = false; submitBtn.removeAttribute('aria-disabled'); }
            } else { if(submitBtn) { submitBtn.disabled = true; submitBtn.setAttribute('aria-disabled','true'); } }
        }

        // Initial check
        checkFormValidity();

        // Put keyboard focus in the first-name field by default.
        // Use a short timeout so this runs after any browser autofill or focus events.
        if(first){
            setTimeout(function(){ try{ first.focus(); }catch(e){} }, 50);
        }

        // On submit, mark all touched and validate with messages shown
        var form = card.querySelector('form');
        if(form){ form.addEventListener('submit', function(e){ for(var k in touched) if(touched.hasOwnProperty(k)) touched[k]=true; var ok=true; ok = validateNameField(first, firstErr, true) && ok; ok = validateNameField(last, lastErr, true) && ok; ok = validateUsername(true) && ok; ok = validateEmail(true) && ok; ok = validatePasswords(true, true) && ok; if(!ok){ e.preventDefault(); checkFormValidity(); } }); }

        // Toggle-eye behavior (show/hide password) matching login page
        document.querySelectorAll('.toggle-eye').forEach(function(btn){
            btn.addEventListener('click', function(){
                var targetId = btn.getAttribute('data-target');
                var input = document.getElementById(targetId);
                if(!input) return;
                var isPressed = btn.getAttribute('aria-pressed') === 'true';
                if(isPressed){
                    input.type = 'password';
                    btn.setAttribute('aria-pressed','false');
                } else {
                    input.type = 'text';
                    btn.setAttribute('aria-pressed','true');
                }
            });
        });
    })();
</script>
{% endblock %}
