{% extends "helpdesk/public_base.html" %}{% load i18n static %}

{% block helpdesk_title %}{% trans "Create account" %}{% endblock %}

{% block helpdesk_head %}
  <style>
    .page-empty { padding: 60px 20px; display:flex; align-items:center; justify-content:center; }
    .empty-card, .register-card { width: 600px; max-width:94%; padding: 28px; border-radius: 12px; background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.06); border: 1px solid #e6e6e6; }
    .register-card { text-align: left; }
    .register-card h1 { margin: 0 0 8px 0; font-size: 20px; }
  .register-card p.lead { margin: 0 0 16px 0; color: #666; font-size: 15px; }

  .form-row { margin-bottom: 4px; }
  .form-row label { display:block; margin-bottom:2px; font-weight:600; color:#222; }
    .form-row input { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #d9d9d9; background: #fff; box-sizing: border-box; font-size:14px; }
    .form-row input:focus { outline: none; border-color:#9bb0ff; box-shadow: 0 0 0 3px rgba(16,87,255,0.06); }

    /* Two-column layout for name fields on wider screens */
    .name-row { display:block; }
    .name-row .form-row { width:100%; }
    @media(min-width:700px) {
      .name-row { display:flex; gap:12px; }
      .name-row .form-row { width:50%; }
    }

  .form-errors { background:#fff4f4; border:1px solid #ffd7d7; color:#7a1212; padding:6px 12px 6px 12px; border-radius:8px; margin-bottom:4px; }
  /* Server-rendered field errors: reserve space so showing messages doesn't shift the form layout */
  /* Remove left padding so server error text is flush with the start of the field */
  .server-field-error { min-height:24px; visibility: hidden; padding:6px 0; margin-bottom:4px; border-radius:8px; background:#fff4f4; border:1px solid #ffd7d7; color:#7a1212; }
  .server-field-error:not(:empty) { visibility: visible; }
    .form-note { margin-top:8px; color:#666; font-size:13px; }

    /* Field error visuals (consistent with password_reset) */
    .field-error {
  color: #c62828; /* professional red */
  font-size: 12px;
    margin-top: 1px;
  /* Reserve vertical space so showing/hiding the error doesn't shift layout */
  display: block;
  min-height: 12px;
  visibility: hidden; /* use visibility so element still occupies space */
  padding-left: 0; /* flush with start of field (no left padding) */
  margin-left: 0;
    }
  /* removed visual icon to keep message minimal */
  .field-error::before { content: none; }
    input.is-invalid { border-color: #c62828 !important; box-shadow: none !important; }
  /* Strong overrides to remove any error icon glyphs inside this card */
  .register-card .field-error::before,
  .register-card .form-errors::before,
  .register-card .server-field-error::before,
  .register-card .field-error::after,
  .register-card .form-errors::after,
  .register-card .server-field-error::after,
  .register-card [class*="fa-"]::before {
    content: none !important;
    display: none !important;
    width: 0 !important;
    height: 0 !important;
  }
  .register-card .field-error-space i,
  .register-card .field-error-space svg,
  .register-card .form-errors i,
  .register-card .form-errors svg { display: none !important; width: 0 !important; height: 0 !important; }

  /* Hard overrides: prevent any browser/vendor inserted icons on invalid inputs */
  .register-card input.is-invalid,
  .register-card textarea.is-invalid,
  .register-card .form-select.is-invalid {
    background-image: none !important;
    background: none !important;
    -webkit-appearance: none !important;
    appearance: none !important;
    box-shadow: none !important;
    outline: none !important;
  }

  .register-card input.is-invalid::before,
  .register-card input.is-invalid::after,
  .register-card textarea.is-invalid::before,
  .register-card textarea.is-invalid::after,
  .register-card .form-select.is-invalid::before,
  .register-card .form-select.is-invalid::after {
    content: none !important;
    display: none !important;
    width: 0 !important;
    height: 0 !important;
  }

  .register-card .is-invalid + i,
  .register-card .is-invalid + svg,
  .register-card .is-invalid ~ i,
  .register-card .is-invalid ~ svg { display: none !important; width: 0 !important; height: 0 !important; }

  .register-actions { display:flex; gap:12px; align-items:center; justify-content:center; margin-top:8px; width:100%; }
    .btn-primary { 
      min-width: 180px;
      padding: 8px 12px;
      border-radius: 15px;
      background-color: #000C7D;
      color: #ffffff;
      border: 1px solid #000C7D;
      font-weight: normal;
      text-align: center;
      cursor: pointer;
      transition: transform 90ms ease, background-color 120ms ease, box-shadow 120ms ease;
      display: inline-block;
      font-size: 14px;
    }
    .btn-primary:hover, .btn-primary:focus {
      background-color: #08104f;
      border-color: #08104f;
      transform: translateY(-1px);
    }
    /* Secondary button: white with brand border/text */
    .btn-secondary {
      min-width: 140px;
      padding: 8px 12px;
      border-radius: 15px;
      background: #ffffff;
      border: 1px solid #333;
      color: #333;
      text-align: center;
      display: inline-block;
      font-weight: normal;
      font-size: 14px;
    }
    .btn-secondary:hover, .btn-secondary:focus {
      background: #3333336c;
      text-decoration: none;
    }
      /* Shared interactive behavior for both buttons */
      .btn-primary,
      .btn-secondary {
        min-width: 140px;
        padding: 8px 12px;
        border-radius: 15px;
        text-align: center;
        display: inline-block;
        font-weight: normal;
        cursor: pointer;
        transition: transform 90ms ease, background-color 120ms ease, border-color 120ms ease, box-shadow 120ms ease, color 120ms ease;
        will-change: transform, background-color;
      }
      /* Primary color (brand) */
      .btn-primary {
        background-color: #000C7D;
        color: #ffffff;
        border: 1px solid #000C7D;
      }
      /* Secondary: white with brand border/text */
      .btn-secondary {
        background: #ffffff;
        border: 1px solid #333;
        color: #333;
      }
      /* Hover and focus show the same motion/feedback for both buttons */
      .btn-primary:hover,
      .btn-primary:focus,
      .btn-secondary:hover,
      .btn-secondary:focus {
        transform: translateY(-1px);
        outline: none;
      }
      /* Color-specific hover adjustments */
      .btn-primary:hover { background-color: #08104f; border-color: #08104f; }
      .btn-secondary:hover { background-color: #33333334; color: #333;}
      /* Strong focus ring for keyboard users (use brand accent) */
      .btn-primary:focus-visible {
        box-shadow: 0 0 0 4px rgba(0,12,125,0.12);
      }
      /* Active/pressed state */
      .btn-primary:active,
      .btn-secondary:active {
        transform: translateY(0);
        transition-duration: 60ms;
      }
    /* Disabled primary button visual: dark gray, non-interactive */
    .btn-primary[disabled], .btn-primary[aria-disabled="true"] {
      background-color: #000535d8;
      border-color: #000535d8;
      color: #fff;
      opacity: 0.65;
      cursor: not-allowed;
      box-shadow: none;
    }
    .btn-primary[disabled]:hover, .btn-primary[aria-disabled="true"]:hover { background-color: #444444; border-color: #444444; }
      /* Disabled primary button visual: dark gray, non-interactive (but keep pointer-events so hover/tooltip works) */
      .btn-primary[disabled], .btn-primary[aria-disabled="true"] {
        background-color: #444444;
        border-color: #444444;
        color: #ffffff;
        opacity: 1;
        cursor: not-allowed;
        /* do NOT disable pointer-events so users can hover and see the tooltip */
        box-shadow: none;
      }
      .btn-primary[disabled]:hover, .btn-primary[aria-disabled="true"]:hover { background-color: #444444; border-color: #444444; }

      /* Tooltip wrapper for disabled button */
      .tooltip-wrap { position: relative; display: inline-block; }
      .tooltip-wrap::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: #222;
        color: #fff;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 120ms ease;
        z-index: 30;
      }
      .tooltip-wrap:hover::after,
      .tooltip-wrap.show-tooltip::after { opacity: 1; }
    @media (max-width: 480px) {
      .register-actions { flex-direction: column; align-items:stretch; }
      .btn-primary, .btn-secondary { width: 90% !important; display: block; }
    }

    /* Hide header elements on register page */
    #sidebarToggle { display: none !important; }
    .btn-outline-secondary { display: none !important; }
  </style>
{% endblock %}

{% block helpdesk_body %}
  <div class="page-empty">
    <div class="register-card">
      <h1>{% trans "Create a new account" %}</h1>
      <p class="lead">{% trans "Fill in the fields below to create your account. All fields marked required must be completed." %}</p>

  {# server non-field errors removed per UX request; per-field server error containers remain and reserve space to prevent layout shifts #}

      <form method="post" action="" novalidate>
        {% csrf_token %}

        <div class="name-row">
          <div class="form-row">
            <label for="id_first_name">{% trans "First name" %} <span style="color:#999;font-weight:400">*</span></label>
            <input id="id_first_name" name="first_name" type="text" autocomplete="given-name" required value="{{ form.first_name.value|default_if_none:'' }}">
            <div id="id_first_name-server-error" class="form-errors server-field-error" aria-live="polite">{% if form and form.first_name.errors %}{{ form.first_name.errors|join:' ' }}{% endif %}</div>
            <div id="id_first_name-client-error" class="field-error" aria-live="polite"></div>
          </div>

          <div class="form-row">
            <label for="id_last_name">{% trans "Last name" %} <span style="color:#999;font-weight:400">*</span></label>
            <input id="id_last_name" name="last_name" type="text" autocomplete="family-name" required value="{{ form.last_name.value|default_if_none:'' }}">
            <div id="id_last_name-server-error" class="form-errors server-field-error" aria-live="polite">{% if form and form.last_name.errors %}{{ form.last_name.errors|join:' ' }}{% endif %}</div>
            <div id="id_last_name-client-error" class="field-error" aria-live="polite"></div>
          </div>
        </div>

        <div class="form-row">
          <label for="id_username">{% trans "Username" %} <span style="color:#999;font-weight:400">*</span></label>
          <input id="id_username" name="username" type="text" autocomplete="username" required value="{{ form.username.value|default_if_none:'' }}">
          <div id="id_username-server-error" class="form-errors server-field-error" aria-live="polite">{% if form and form.username.errors %}{{ form.username.errors|join:' ' }}{% endif %}</div>
          <div id="id_username-client-error" class="field-error" aria-live="polite"></div>
        </div>

        <div class="form-row">
          <label for="id_email">{% trans "Email address" %} <span style="color:#999;font-weight:400">*</span></label>
          <input id="id_email" name="email" type="email" autocomplete="email" required value="{{ form.email.value|default_if_none:'' }}">
          <div id="id_email-server-error" class="form-errors server-field-error" aria-live="polite">{% if form and form.email.errors %}{{ form.email.errors|join:' ' }}{% endif %}</div>
          <div id="id_email-client-error" class="field-error" aria-live="polite"></div>
        </div>

        <div class="form-row">
          <label for="id_password1">{% trans "Password" %} <span style="color:#999;font-weight:400">*</span></label>
          <input id="id_password1" name="password1" type="password" autocomplete="new-password" required aria-required="true">
          <div id="id_password1-server-error" class="form-errors server-field-error" aria-live="polite">{% if form and form.password1.errors %}{{ form.password1.errors|join:' ' }}{% endif %}</div>
          <div id="id_password1-client-error" class="field-error" aria-live="polite"></div>
        </div>

        <div class="form-row">
          <label for="id_password2">{% trans "Confirm password" %} <span style="color:#999;font-weight:400">*</span></label>
          <input id="id_password2" name="password2" type="password" autocomplete="new-password" required aria-required="true">
          <div id="id_password2-server-error" class="form-errors server-field-error" aria-live="polite">{% if form and form.password2.errors %}{{ form.password2.errors|join:' ' }}{% endif %}</div>
          <div id="id_password2-client-error" class="field-error" aria-live="polite"></div>
        </div>

        <div class="form-note">{% trans "Passwords must be at least 8 characters and include a mix of letters and numbers." %}</div>

        <div class="register-actions">
          <a href="/login/" class="btn-secondary">{% trans "Return to login" %}</a>
          <button id="register-submit" type="submit" class="btn-primary" disabled aria-disabled="true">{% trans "Create account" %}</button>
        </div>
      </form>
      <script>
        (function(){
          var form = document.querySelector('.register-card form');
          if (!form) return;
          var pwd1 = document.getElementById('id_password1');
          var pwd2 = document.getElementById('id_password2');
          var err1 = document.getElementById('id_password1-client-error');
          var err2 = document.getElementById('id_password2-client-error');
          var username = document.getElementById('id_username');
          var email = document.getElementById('id_email');
          var errUsername = document.getElementById('id_username-client-error');
          var errEmail = document.getElementById('id_email-client-error');

          var REQUIRED_MSG = 'Please fill in the required field.';
          var INVALID_NAME_MSG = 'Invalid Character';
          var USERNAME_MIN = 3;
          var USERNAME_MIN_MSG = 'Username must be at least 3 characters.';

          function showError(el, box, msg) {
            if (!box) return;
            box.textContent = msg;
            box.style.visibility = 'visible';
            el.classList.add('is-invalid');
            el.setAttribute('aria-invalid', 'true');
            el.setAttribute('aria-describedby', box.id);
          }

          function clearError(el, box) {
            if (!box) return;
            box.textContent = '';
            box.style.visibility = 'hidden';
            el.classList.remove('is-invalid');
            el.removeAttribute('aria-invalid');
            el.removeAttribute('aria-describedby');
          }

          // showErrorsForPwd1 controls showing required/length for pwd1
          // showErrorsForPwd2 controls showing confirm-required and mismatch for pwd2
          function validatePasswords(showErrorsForPwd1, showErrorsForPwd2) {
            var v1 = pwd1.value || '';
            var v2 = pwd2.value || '';
            var ok = true;

            // pwd1: required and complex requirements
            if (!v1) {
              if (showErrorsForPwd1) showError(pwd1, err1, REQUIRED_MSG);
              ok = false;
            } else {
              var parts = [];
              // length requirement
              if (v1.length < 8) parts.push('Password must be at least 8 characters');

              // character requirements (collect short labels)
              var missing = [];
              if (!/[A-Z]/.test(v1)) missing.push('uppercase');
              if (!/[a-z]/.test(v1)) missing.push('lowercase');
              if (!/[0-9]/.test(v1)) missing.push('number');
              // special: contains a character outside letters, numbers, space, dot, apostrophe or hyphen
              if (!/[^A-Za-z0-9\s.\'\-]/.test(v1)) {
                missing.push('special character');
              }

              if (parts.length === 0 && missing.length === 0) {
                // all good
                clearError(pwd1, err1);
              } else {
                ok = false;
                // compose message
                var msg = '';
                var missingMsg = '';
                if (missing.length) {
                  missingMsg = missing.length === 1 ? missing[0] : (missing.slice(0, -1).join(', ') + ' and ' + missing[missing.length - 1]);
                }
                if (parts.length) {
                  msg = parts[0];
                  if (missingMsg) msg = msg + ' and must contain ' + missingMsg;
                } else {
                  // only missing character types
                  msg = 'Password must contain ' + missingMsg;
                }
                if (showErrorsForPwd1) showError(pwd1, err1, msg);
              }
            }

            // pwd2: required (confirm) and mismatch
            if (!v2) {
              // Only show the required message for the confirm field if it's been touched
              if (showErrorsForPwd2 && typeof touched !== 'undefined' && touched.password2) showError(pwd2, err2, REQUIRED_MSG);
              ok = false;
            } else {
              // clear prior confirm error; mismatch handled below
              clearError(pwd2, err2);
            }

            if (v2 && v1 !== v2) {
              // Show mismatch instantly regardless of showErrorsForPwd2 flag
              showError(pwd2, err2, 'Password did not match.');
              ok = false;
            } else if (v2 && v1 === v2) {
              clearError(pwd2, err2);
            }

            return ok;
          }

      function validateUsername(showErrors) {
            if (!username) return true;
            var v = username.value ? username.value.trim() : '';
            if (!v) {
        if (showErrors) showError(username, errUsername, REQUIRED_MSG);
              return false;
            }
            if (v.length < 3) {
        if (showErrors) showError(username, errUsername, 'Username must be at least 3 characters.');
              return false;
            }
            clearError(username, errUsername);
            return true;
          }

      function validateEmail(showErrors) {
            if (!email) return true;
            var v = email.value ? email.value.trim() : '';
            if (!v) {
        if (showErrors) showError(email, errEmail, REQUIRED_MSG);
              return false;
            }
            // basic email regex
            var re = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
            if (!re.test(v)) {
              if (showErrors) showError(email, errEmail, 'Please enter a valid email address.');
              return false;
            }
            clearError(email, errEmail);
            return true;
          }

          var submitBtn = document.getElementById('register-submit');

  function validateNameField(el, box, showErrors) {
    if (!el) return true;
    var v = el.value ? el.value.trim() : '';
    if (!v) {
    if (showErrors) showError(el, box, REQUIRED_MSG);
      return false;
    }
    // Allow letters (unicode), spaces, dot, apostrophe, hyphen
    // Disallow digits and other special characters
    var validNameRe = /^[\p{L} .'\-]+$/u;
    if (!validNameRe.test(v)) {
  if (showErrors) showError(el, box, INVALID_NAME_MSG);
      return false;
    }
    clearError(el, box);
    return true;
      }

          function checkFormValidity() {
            var requiredFields = ['id_first_name','id_last_name','id_username', 'id_email', 'id_password1', 'id_password2'];
            var filled = requiredFields.every(function(id){
              var el = document.getElementById(id);
              return el && el.value && el.value.trim().length > 0;
            });
            var namesOk = validateNameField(document.getElementById('id_first_name'), document.getElementById('id_first_name-client-error'), false) &&
                          validateNameField(document.getElementById('id_last_name'), document.getElementById('id_last_name-client-error'), false);
            var pwdOk = validatePasswords(false);
            if (filled && pwdOk && namesOk && validateUsername(false) && validateEmail(false)) {
              submitBtn.disabled = false;
              submitBtn.removeAttribute('aria-disabled');
            } else {
              submitBtn.disabled = true;
              submitBtn.setAttribute('aria-disabled', 'true');
            }
          }

          // Generic touched flags
          var touched = {
            first_name: false,
            last_name: false,
            username: false,
            email: false,
            // independent flags for each password field
            password1: false,
            password2: false
          };

          function attachTouchedHandlers(el, validator, boxId) {
            if (!el) return;
            var box = document.getElementById(boxId);
            // consider a field "touched" only when the user actively clicks/taps into it
            el.addEventListener('pointerdown', function(){ touched[el.id.replace('id_','')] = true; });
            el.addEventListener('mousedown', function(){ touched[el.id.replace('id_','')] = true; });
            el.addEventListener('input', function(){
              // clear error while typing
              clearError(el, box);
              checkFormValidity();
            });
            el.addEventListener('blur', function(){
              // only show errors on blur if the field was clicked/touched before
              var ok = validator(touched[el.id.replace('id_','')]);
              if (touched[el.id.replace('id_','')] && !ok) {
                // validator already showed the error when called with true
              }
              checkFormValidity();
            });
          }

          // Attach handlers to name, username and email fields
          attachTouchedHandlers(document.getElementById('id_first_name'), function(show){ return validateNameField(document.getElementById('id_first_name'), document.getElementById('id_first_name-client-error'), show); }, 'id_first_name-client-error');
          attachTouchedHandlers(document.getElementById('id_last_name'), function(show){ return validateNameField(document.getElementById('id_last_name'), document.getElementById('id_last_name-client-error'), show); }, 'id_last_name-client-error');
          // Immediate character validation for name fields: show "Invalid Character" as soon as a disallowed character is typed
          (function(){
            var firstEl = document.getElementById('id_first_name');
            var lastEl = document.getElementById('id_last_name');
            var firstBox = document.getElementById('id_first_name-client-error');
            var lastBox = document.getElementById('id_last_name-client-error');
            // Allow letters (unicode), spaces, dot, apostrophe, hyphen
            var nameValidRe = /^[\p{L} .'\-]+$/u;
            function attachImmediate(el, box){
              if (!el || !box) return;
              el.addEventListener('input', function(){
                var v = el.value ? el.value.trim() : '';
                if (v && !nameValidRe.test(v)) {
                  showError(el, box, INVALID_NAME_MSG);
                } else {
                  // clear any client error while typing if the content is valid or empty
                  clearError(el, box);
                }
                checkFormValidity();
              });
            }
            attachImmediate(firstEl, firstBox);
            attachImmediate(lastEl, lastBox);
          })();
          attachTouchedHandlers(username, function(show){ return validateUsername(show); }, 'id_username-client-error');
          attachTouchedHandlers(email, function(show){ return validateEmail(show); }, 'id_email-client-error');

          // Immediate username length validation: show message as soon as input is too short
          (function(){
            var uname = document.getElementById('id_username');
            var unameBox = document.getElementById('id_username-client-error');
            if (!uname || !unameBox) return;
            uname.addEventListener('input', function(){
              var v = uname.value ? uname.value.trim() : '';
              if (v && v.length < USERNAME_MIN) {
                showError(uname, unameBox, USERNAME_MIN_MSG);
              } else {
                clearError(uname, unameBox);
              }
              checkFormValidity();
            });
          })();

          // Passwords: independent touched flags so each field's click+blur shows only its own errors
          function attachPasswordTouchedHandlers(pwEl, boxId, which) {
            if (!pwEl) return;
            var box = document.getElementById(boxId);
            // mark this specific password field touched only when the user actively clicks/taps into it
            pwEl.addEventListener('pointerdown', function(){ touched[which] = true; });
            pwEl.addEventListener('mousedown', function(){ touched[which] = true; });
            pwEl.addEventListener('input', function(){
              // run full password validation on every keystroke so mismatch shows instantly
              validatePasswords(true, true);
              checkFormValidity();
            });
            pwEl.addEventListener('blur', function(){
              // on blur, show errors only for the field that was clicked/touched.
              if (which === 'password1') {
                // show errors for password1 (required/length). Do not show mismatch here.
                validatePasswords(touched.password1, false);
              } else {
                // for password2 (confirm) show confirm-required and mismatch
                validatePasswords(false, touched.password2);
              }
              checkFormValidity();
            });
          }

          attachPasswordTouchedHandlers(pwd1, 'id_password1-client-error', 'password1');
          attachPasswordTouchedHandlers(pwd2, 'id_password2-client-error', 'password2');

          // Prevent pasting into the confirm-password field (no content from clipboard should be inserted)
          (function(){
            var confirmEl = document.getElementById('id_password2');
            if (!confirmEl) return;
            // block standard paste
            confirmEl.addEventListener('paste', function(e){
              e.preventDefault();
            });
            // block drop (drag-and-drop)
            confirmEl.addEventListener('drop', function(e){
              e.preventDefault();
            });
            // block 'beforeinput' paste insertion where supported
            confirmEl.addEventListener('beforeinput', function(e){
              try {
                if (e.inputType === 'insertFromPaste' || e.inputType === 'insertFromDrop') e.preventDefault();
              } catch (err) {
                // ignore
              }
            });
          })();

          // initial check on load
          checkFormValidity();

          form.addEventListener('submit', function(e){
            // mark all fields as touched so errors surface on submit
            for (var k in touched) if (touched.hasOwnProperty(k)) touched[k] = true;
            var allOk = true;
            allOk = validateNameField(document.getElementById('id_first_name'), document.getElementById('id_first_name-client-error'), true) && allOk;
            allOk = validateNameField(document.getElementById('id_last_name'), document.getElementById('id_last_name-client-error'), true) && allOk;
            allOk = validateUsername(true) && allOk;
            allOk = validateEmail(true) && allOk;
            allOk = validatePasswords(true) && allOk;
            // ensure passwords match check was applied to pwd2 as well
            if (!allOk) {
              e.preventDefault();
              var firstInvalid = form.querySelector('.is-invalid');
              if (firstInvalid) firstInvalid.focus();
            }
          });
        })();
      </script>
    </div>
  </div>
{% endblock %}
