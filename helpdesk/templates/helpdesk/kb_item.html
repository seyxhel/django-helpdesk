{% extends "helpdesk/base.html" %}{% load i18n %}


{% block helpdesk_title %}{% trans "Add knowledgebase item" %}{% endblock %}

{% block helpdesk_head %}
    <style>
        :root{
          --kb-bg: #ffffff;
          --kb-ink: #0f2b44;
          --kb-muted: #6c7783;
          --kb-accent: #0b57d0;
          --kb-border: rgba(15,23,42,0.06);
          --kb-radius: 14px;
        }

        /* Card wrapper — slightly lighter shadow + tighter padding */
        .kb-form-card {
          max-width: 920px;
          margin: 18px auto;
          background: var(--kb-bg);
          border: 1px solid var(--kb-border);
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 6px 18px rgba(15,23,42,0.03);
        }
        .kb-form-card h2 {
          margin: 0 0 10px 0;
          font-size: 1.25rem;
          color: var(--kb-ink);
          font-weight: 700;
        }

        /* Form spacing and labels — tighter spacing */
        .kb-form-card .form-group { margin-bottom: 14px; padding-bottom: 0; }
        .kb-form-card .form-group > label { display:block; margin-bottom:6px; color:var(--kb-ink); font-weight:600; font-size:0.95rem; }

        /* Inputs: slightly reduced padding */
        .kb-form-card input[type="text"],
        .kb-form-card textarea,
        .kb-form-card select,
        .kb-form-card .form-control {
          width: 100%;
          padding: 10px 12px;
          border-radius: 10px;
          border: 1px solid rgba(15,23,42,0.08);
          background: #fff;
          font-size: 0.98rem;
          box-shadow: none;
          box-sizing: border-box;
        }
        .kb-form-card textarea { min-height: 160px; resize: vertical; }

        /* Helper/meta text */
        .kb-form-card .help-text { color: var(--kb-muted); font-size: .92rem; margin-top:6px; }

        /* Actions: centered, primedesk-style primary */
        .kb-form-actions { display:flex; gap:12px; justify-content:center; margin-top:18px; }
        .kb-form-actions .btn {
          border-radius: 999px;
          padding: 10px 18px;
          font-weight:600;
          border: 1px solid rgba(15,23,42,0.06);
          background: #fff;
          color: var(--kb-ink);
        }
        .kb-form-actions .btn-primary {
          background: var(--kb-accent);
          color: #fff;
          border-color: var(--kb-accent);
          box-shadow: 0 10px 24px rgba(11,87,208,0.10);
          padding: 12px 22px;
        }
        .kb-form-actions .btn-primary:hover { background:#064da8; border-color:#064da8; }

        /* Make server errors inline (remove boxed red card appearance) */
        .server-field-error {
          display: block;
          background: transparent;  /* remove red box */
          border: none;             /* remove red border */
          color: #c62828;           /* keep red text for visibility */
          padding: 0;
          margin-top: 6px;
          font-size: 0.92rem;
        }
        /* Hide empty server-error nodes */
        .server-field-error:empty { display: none; }

        /* client-side field errors: subtle red text below field */
        .field-error {
          color: #c62828;
          background: transparent;
          padding: 0;
          margin-top: 6px;
          font-size: 0.9rem;
        }

        /* inline select + action button */
        .input-with-action { display:flex; gap:8px; align-items:center; }
        .input-with-action > select,
        .input-with-action .form-control { flex:1; min-width:0; } /* allow select to shrink in flex */
        .add-kb-cat-btn {
            flex: 0 0 auto;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            width:36px;
            height:36px;
            border-radius:8px;
            padding:0;
            border:1px solid rgba(11,87,208,0.12);
            background:#fff;
            color:var(--kb-accent);
            text-decoration:none;
        }
        .add-kb-cat-btn i { font-size:16px; line-height:1; }
        .add-kb-cat-btn:hover { background:var(--kb-accent); color:#fff; border-color:var(--kb-accent); }

        /* inline checkbox rows */
        .form-group-inline { display:flex; align-items:center; gap:12px; margin-bottom:14px; }
        .form-group-inline > label { flex:1; margin:0; color:var(--kb-ink); font-weight:600; font-size:0.95rem; }
        .form-group-inline .inline-control { flex:0 0 auto; display:inline-flex; align-items:center; }

        /* compact custom checkbox (small visual size, full click area via label) */
        .kb-checkbox {
          width:14px;
          height:14px;
          -webkit-appearance: none;
          appearance: none;
          border: 1px solid rgba(15,23,42,0.12);
          border-radius:4px;
          background: #fff;
          display:inline-block;
          position:relative;
          vertical-align:middle;
          margin:0;
        }
        /* ensure Django-rendered checkboxes inside inline-control match size */
        .form-group-inline .inline-control input[type="checkbox"] { width:14px; height:14px; margin:0; }
        .kb-checkbox:checked {
          background: var(--kb-accent);
          border-color: var(--kb-accent);
        }
        .kb-checkbox:checked::after {
          content: "";
          position: absolute;
          left: 3px;
          top: 1px;
          width: 5px;
          height: 8px;
          border: solid #fff;
          border-width: 0 2px 2px 0;
          transform: rotate(45deg);
        }
        .kb-checkbox:focus {
          outline: 3px solid rgba(11,87,208,0.08);
          outline-offset: 2px;
        }

        @media (max-width:720px) {
          .kb-form-card { padding:16px; margin:12px; }
          .kb-form-actions { flex-direction:column-reverse; gap:10px; align-items:stretch; }
          .kb-form-actions .btn { width:100%; justify-content:center; }
        }
    </style>
{% endblock %}

{% block helpdesk_breadcrumb %}
<li class="breadcrumb-item">
    <a href="{% url 'helpdesk:kb_index' %}">{% trans "Knowledgebase" %}</a>
</li>
<li class="breadcrumb-item active">{% trans "Add item" %}</li>
{% endblock %}

{% block helpdesk_body %}
<div class="kb-form-card" role="region" aria-labelledby="kbitem-heading">
  <h2 id="kbitem-heading">{% trans "Add knowledge base item" %}</h2>
  <form method="post" novalidate>
        {% csrf_token %}

        <div class="form-group">
                {{ form.category.label_tag }}
                <div class="input-with-action">
                    {{ form.category }}
                    {% if request.user.is_superuser %}
                    <a href="{% url 'helpdesk:kb_category_add' %}" class="add-kb-cat-btn" title="{% trans 'Add KB category' %}">
                        <i class="fa fa-plus" aria-hidden="true"></i>
                        <span class="sr-only">{% trans 'Add KB category' %}</span>
                    </a>
                    {% endif %}
                </div>
                <div id="id_category-server-error" class="form-errors server-field-error" aria-live="polite">{% if form and form.category.errors %}{{ form.category.errors|join:' ' }}{% endif %}</div>
                <div id="id_category-client-error" class="field-error" aria-live="polite"></div>
        </div>

        <div class="form-group">
                {{ form.title.label_tag }}
                {{ form.title }}
                <div id="id_title-server-error" class="form-errors server-field-error" aria-live="polite">{% if form and form.title.errors %}{{ form.title.errors|join:' ' }}{% endif %}</div>
                <div id="id_title-client-error" class="field-error" aria-live="polite"></div>
        </div>

        <div class="form-group">
                {{ form.question.label_tag }}
                {{ form.question }}
                <div id="id_question-server-error" class="form-errors server-field-error" aria-live="polite">{% if form and form.question.errors %}{{ form.question.errors|join:' ' }}{% endif %}</div>
                <div id="id_question-client-error" class="field-error" aria-live="polite"></div>
        </div>

        <div class="form-group">
                {{ form.answer.label_tag }}
                {{ form.answer }}
                <div id="id_answer-server-error" class="form-errors server-field-error" aria-live="polite">{% if form and form.answer.errors %}{{ form.answer.errors|join:' ' }}{% endif %}</div>
                <div id="id_answer-client-error" class="field-error" aria-live="polite"></div>
        </div>

    <div class="form-group">
        <label for="id_allow_ticket">Allow regular users to make ticket about this?</label>
        <input type="checkbox" id="id_allow_ticket" name="allow_ticket" {% if form.allow_ticket.value %}checked{% endif %} />
    </div>
    <div class="form-group">
        {{ form.enabled.label_tag }} {{ form.enabled }}
    </div>

        <div class="kb-form-actions">
            <a href="{% url 'helpdesk:kb_index' %}" class="btn" role="button">{% trans "Cancel" %}</a>
            <button id="kb-submit" type="submit" class="btn btn-primary" disabled aria-disabled="true">{% trans "Create" %}</button>
        </div>
    </form>
</div>

    <script>
    (function(){
        var form = document.querySelector('form[method="post"]');
        if (!form) return;
        var category = document.getElementById('id_category');
        var title = document.getElementById('id_title');
        var question = document.getElementById('id_question');
        var answer = document.getElementById('id_answer');

        var errCategory = document.getElementById('id_category-client-error');
        var errTitle = document.getElementById('id_title-client-error');
        var errQuestion = document.getElementById('id_question-client-error');
        var errAnswer = document.getElementById('id_answer-client-error');

        var submitBtn = document.getElementById('kb-submit');

        var REQUIRED_MSG = 'Please fill in the required field.';

        // Track whether a field has been focused (clicked into) at least once
        var touched = {};

        function showError(el, box, msg) {
            if (!box) return;
            box.textContent = msg;
            box.style.visibility = 'visible';
            if (el) el.classList.add('is-invalid');
            if (el) el.setAttribute('aria-invalid', 'true');
            if (el) el.setAttribute('aria-describedby', box.id);
        }

        function clearError(el, box) {
            if (!box) return;
            box.textContent = '';
            box.style.visibility = 'hidden';
            if (el) el.classList.remove('is-invalid');
            if (el) el.removeAttribute('aria-invalid');
            if (el) el.removeAttribute('aria-describedby');
        }

        // validateField shows the error only if showErrors is true; otherwise it only
        // returns boolean (used to compute form validity without flashing errors on load)
        function validateField(el, box, showErrors) {
            if (!el) return true;
            var v = el.value ? el.value.trim() : '';
            if (!v) {
                if (showErrors) showError(el, box, REQUIRED_MSG);
                return false;
            }
            clearError(el, box);
            return true;
        }

        function checkForm() {
            // Only display errors for fields that have been touched or contain content.
            var ok = true;
            ok = validateField(category, errCategory, touched['id_category'] || (category && category.value && category.value.trim() !== '')) && ok;
            ok = validateField(title, errTitle, touched['id_title'] || (title && title.value && title.value.trim() !== '')) && ok;
            ok = validateField(question, errQuestion, touched['id_question'] || (question && question.value && question.value.trim() !== '')) && ok;
            ok = validateField(answer, errAnswer, touched['id_answer'] || (answer && answer.value && answer.value.trim() !== '')) && ok;
            if (ok) {
                submitBtn.disabled = false;
                submitBtn.removeAttribute('aria-disabled');
            } else {
                submitBtn.disabled = true;
                submitBtn.setAttribute('aria-disabled', 'true');
            }
            return ok;
        }

        [category, title, question, answer].forEach(function(el){
            if (!el) return;
            // Mark field as touched when focused (clicked into)
            el.addEventListener('focus', function(){ touched[el.id] = true; });
            // On input, re-check and show errors if field was touched
            el.addEventListener('input', function(){ checkForm(); });
            // On blur, show the required message if the field was touched (clicked then left)
            el.addEventListener('blur', function(){
                var box = document.getElementById(el.id+'-client-error');
                validateField(el, box, true);
                checkForm();
            });
        });

        // initial check to set button state if browser pre-fills fields; do not show errors on load
        checkForm();

    })();
</script>
{% endblock %}
