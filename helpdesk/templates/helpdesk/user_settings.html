{% extends "helpdesk/base.html" %}{% load i18n bootstrap4form %}

{% block helpdesk_title %}{% trans "Change User Settings" %}{% endblock %}

{% block helpdesk_breadcrumb %}
<li class="breadcrumb-item">
        <a href="{% url 'helpdesk:user_settings' %}">{% trans "Settings" %}</a>
</li>
<li class="breadcrumb-item active">
        Change User Settings
</li>
{% endblock %}

{% block helpdesk_head %}
<style>
    :root { --input-padding-x: 0.75rem; --input-padding-y: 0.75rem; }
    .reset-wrapper { padding: 40px 20px; display:flex; align-items:center; justify-content:center; }
    .reset-card { width: 640px; max-width:94%; padding: 28px; border-radius: 12px; background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.06); border: 1px solid #e0e0e0; border-top: 0; }
    .reset-card h1 { margin: 0 0 14px 0; font-size: 20px; }
    .reset-card p { margin: 0 0 16px 0; color: #444; font-size:13px; }

    .form-control { width: 100%; padding: 12px 14px; border-radius: 8px; border: 1px solid #ccc; font-size:13px; line-height:1.4; }
    .form-label { display:block; margin-bottom:8px; font-size:13px; color:#333; }

    .reset-actions { display:flex; flex-direction:row; gap:12px; margin-top: 14px; align-items:center; justify-content:center; width:100%; }
    .btn-primary { min-width: 160px; padding: 8px 12px; border-radius: 12px; background-color: #000C7D; color: #ffffff; border: 1px solid #000C7D; font-weight: 500; text-align: center; cursor: pointer; font-size: 14px; }
    .btn-primary:hover { background-color: #08104f; border-color: #08104f; }
    .btn-secondary { min-width: 140px; padding: 8px 12px; border-radius: 12px; background: #ffffff; border: 1px solid #9c9c9c; color: #333; text-align: center; display: inline-block; font-size: 14px; }
    .helper-note { font-size: 13px; color: #666; margin-top: 10px; }
    .field-error { color: #c62828; font-size: 12px; margin-top: 6px; display: inline-flex; align-items: center; gap: 6px; }
    .field-error::before { content: "\26A0"; font-size: 13px; line-height: 1; color: #c62828; }
    input.is-invalid, textarea.is-invalid { border-color: #c62828 !important; box-shadow: none !important; }
    body, .reset-card, .form-group, .form-text { font-size: 13px; }
    .form-check { display:flex; align-items:center; gap:12px; }
    .form-check-input { width:18px; height:18px; }
    .form-check-label { margin:0; }
    @media (max-width: 480px) { .reset-actions { flex-direction: column; } .btn-primary, .btn-secondary { width: 90% !important; display: block; } }
    /* Hide breadcrumb placeholder for this page (settings) */
    .breadcrumb { display: none !important; }
</style>
{% endblock %}

{% block helpdesk_body %}
    {% if user.is_staff %}
        <div class="reset-wrapper">
            <div class="reset-card">
                <h1>User settings</h1>

                <form method="post" action="{% url 'helpdesk:user_settings' %}" novalidate>
                    {% csrf_token %}
                    {{ form.non_field_errors }}

                    <div class="form-group mb-3">
                        <label class="form-label" for="id_first_name">{% trans "First name:" %}</label>
                        <div>
                            <input type="text" name="first_name" id="id_first_name" value="{{ request.user.first_name|default_if_none:'' }}" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label" for="id_last_name">{% trans "Last name:" %}</label>
                        <div>
                            <input type="text" name="last_name" id="id_last_name" value="{{ request.user.last_name|default_if_none:'' }}" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label" for="id_username">{% trans "Username:" %}</label>
                        <div>
                            <input type="text" name="username" id="id_username" value="{{ request.user.username }}" class="form-control" readonly aria-readonly="true" />
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label" for="id_email">{% trans "Email address:" %}</label>
                        <div>
                            <input type="email" name="email" id="id_email" value="{{ request.user.email }}" class="form-control" readonly aria-readonly="true" />
                        </div>
                    </div>

                    <div style="height:8px"></div>

                    <div class="form-group mb-3">
                        <div class="form-check">
                            {{ form.email_on_ticket_change }}
                            <label class="form-check-label" for="{{ form.email_on_ticket_change.id_for_label }}">{{ form.email_on_ticket_change.label }}</label>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <div class="form-check">
                            {{ form.email_on_ticket_assign }}
                            <label class="form-check-label" for="{{ form.email_on_ticket_assign.id_for_label }}">{{ form.email_on_ticket_assign.label }}</label>
                        </div>
                    </div>

                        <input type="hidden" name="tickets_per_page" value="{{ request.user.usersettings_helpdesk.tickets_per_page }}" />
                          <input type="hidden" name="use_email_as_submitter" value="{% if request.user.usersettings_helpdesk.use_email_as_submitter %}1{% else %}0{% endif %}" />
                          <input type="hidden" name="login_view_ticketlist" value="{% if request.user.usersettings_helpdesk.login_view_ticketlist %}1{% else %}0{% endif %}" />

                    <div class="reset-actions">
                        <a class="btn-secondary" href="{% url 'helpdesk:dashboard' %}">{% trans "Cancel" %}</a>
                        <button type="submit" class="btn-primary">{% trans "Save changes" %}</button>
                    </div>

                </form>
                                {% if request.GET.updated %}
                                    <div id="profile-success-overlay" aria-hidden="true" style="display:none; position:fixed; inset:0; z-index:1200; align-items:center; justify-content:center;">
                                        <div id="profile-success-backdrop" style="background: rgba(0,0,0,0.4); position:absolute; inset:0;"></div>
                                        <div style="position:relative; z-index:1201; display:flex; align-items:center; justify-content:center;">
                                            <div id="profile-success-card" role="status" aria-live="polite" style="width:420px; max-width:94vw; background:#fff; border-radius:12px; padding:28px; box-shadow:0 10px 40px rgba(0,0,0,0.2); text-align:center; transition: transform 250ms ease, opacity 250ms ease;">
                                                <svg width="84" height="84" viewBox="0 0 120 120" style="display:block;margin:0 auto 12px auto;">
                                                    <circle cx="60" cy="60" r="48" stroke="#0f9d58" stroke-width="6" fill="none" stroke-dasharray="302" stroke-dashoffset="302">
                                                        <animate attributeName="stroke-dashoffset" from="302" to="0" dur="0.45s" fill="freeze" />
                                                    </circle>
                                                    <path d="M40 62 L54 76 L82 46" stroke="#0f9d58" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0">
                                                        <animate attributeName="opacity" from="0" to="1" begin="0.4s" dur="0.15s" fill="freeze" />
                                                    </path>
                                                </svg>
                                                <h2 style="margin:0 0 8px 0; font-size:20px;">Success!</h2>
                                                <p id="profile-success-text" style="margin:0; color:#444;">User Settings Updated.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <script>
                                    (function(){
                                        var overlay = document.getElementById('profile-success-overlay');
                                        var card = document.getElementById('profile-success-card');
                                        if(overlay && card) {
                                            overlay.style.display = 'flex';
                                            overlay.setAttribute('aria-hidden','false');
                                            card.style.transform = 'translateY(-6px)';
                                            card.style.opacity = '1';
                                            setTimeout(function(){
                                                try {
                                                    var url = new URL(window.location.href);
                                                    url.searchParams.delete('updated');
                                                    window.history.replaceState({}, document.title, url.pathname + url.search + url.hash);
                                                } catch (e) {}
                                                overlay.style.display = 'none';
                                            }, 1400);
                                        }
                                    })();
                                    </script>
                                {% endif %}
            </div>
        </div>
    {% else %}
        <h2>{% trans "User Settings" %}</h2>

        <p>{% blocktrans %}Use the following options to change the way your helpdesk system works for you. These settings do not impact any other user.{% endblocktrans %}</p>

        {% block form_content %}
        <form role="form" method='post' action='./'>
                {% csrf_token %}
                {{ form|bootstrap4form }}
                <div class="form-group">
                    <input type="submit" value="Submit" class="btn btn-primary" />
                </div>
        </form>
        {% endblock %}
    {% endif %}
{% endblock %}
