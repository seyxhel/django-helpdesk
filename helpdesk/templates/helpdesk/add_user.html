{% extends "helpdesk/base.html" %}{% load i18n %}

{% block helpdesk_title %}{% trans "Add User" %}{% endblock %}

{% block helpdesk_breadcrumb %}
<li class="breadcrumb-item">
    <a href="{% url 'helpdesk:system_settings' %}">{% trans "System Settings" %}</a>
</li>
<li class="breadcrumb-item active">{% trans "Add User" %}</li>
{% endblock %}

{% block helpdesk_body %}
<h2 class="sr-only">{% trans "Add User" %}</h2>

<style>
:root{
  --brand: #0b3ea6;            /* slightly darker for strong CTA */
  --brand-strong: #062f85;
  --muted: #6b7280;
  --card-bg: #fff;
  --surface: #fbfdff;
  --radius-lg: 12px;
  --radius-sm: 8px;
  --btn-radius: 22px;
  --input-height: 46px;
}

/* Centered page card matching the screenshot */
.page-card {
  max-width: 640px;
  margin: 28px auto;
  padding: 0 16px;
}
.page-card .card {
  border-radius: var(--radius-lg);
  background: linear-gradient(180deg,var(--card-bg) 0%, var(--surface) 100%);
  box-shadow: 0 12px 40px rgba(8,24,48,0.08);
  border: 1px solid rgba(15,23,42,0.04);
  overflow: hidden;
}
.page-card .card-body { padding: 28px 28px 20px; }

/* Title & subtitle */
h3.page-title { margin:0 0 8px; font-size:20px; font-weight:700; color:#0f1724; }
.page-sub { color:var(--muted); font-size:13px; margin-bottom:20px; display:block; }

/* Inputs */
.helpdesk-add-user input[type="text"],
.helpdesk-add-user input[type="password"],
.helpdesk-add-user input[type="email"],
.helpdesk-add-user select,
.helpdesk-add-user textarea {
  width:100%;
  height:var(--input-height);
  padding:.5rem .9rem;
  border-radius:10px;
  border:1px solid rgba(15,23,42,0.08);
  box-sizing:border-box;
  background:#fff;
  font-size:14px;
  transition: box-shadow .12s ease, border-color .12s ease, transform .06s ease;
  outline: none;
}
.helpdesk-add-user textarea { min-height:140px; height:auto; padding-top:.75rem; padding-bottom:.75rem; }

/* Input focus */
.helpdesk-add-user input:focus,
.helpdesk-add-user textarea:focus,
.helpdesk-add-user select:focus {
  border-color: rgba(11,94,215,0.25);
  box-shadow: 0 6px 18px rgba(11,94,215,0.08);
}

/* Labels / helper text / errors */
.helpdesk-add-user label { display:block; margin-bottom:8px; font-weight:600; color:#111827; font-size:13px; }
.helpdesk-add-user .form-text, .helpdesk-add-user .helptext { font-size:13px; color:var(--muted); margin-top:6px; }
.helpdesk-add-user .text-danger.small, .helpdesk-add-user .client-required-error { color:#dc3545; font-size:13px; margin-top:6px; }

/* Small utility spacing for stacked fields */
.gap-row { gap: 12px; display:flex; flex-wrap:wrap; }

/* Checkbox layout improvements */
.checkbox-row {
  display: flex;
  flex-wrap: wrap;
  gap: 18px;
  align-items: center;
  margin-bottom: 6px;
}

/* Toggle / checkboxes - improved alignment & clickable labels */
.form-check {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  margin: 0;
  vertical-align: middle;
}
.form-check input[type="checkbox"],
.form-check input[type="radio"] {
  width: 18px;
  height: 18px;
  margin: 0;
  flex: 0 0 18px;
  transform: translateY(-1px);
  accent-color: var(--brand); /* modern browsers */
  cursor: pointer;
}
.form-check .form-check-label {
  margin: 0;
  font-weight: 600;
  color: #111827;
  font-size: 13px;
  cursor: pointer; /* label clickable */
  user-select: none;
}

/* Reserve space for inline server/client errors to avoid layout jump */
.field-error-space { min-height: 1.25rem; }

/* Small screens stack checkboxes */
@media (max-width: 576px) {
  .checkbox-group { flex-direction: column; align-items: flex-start; }
}

/* Action buttons â€” centered, pill style */
.form-actions {
  padding-top:22px;
  display:flex;
  justify-content:center;
  gap:12px;
  align-items:center;
}
.form-actions .btn {
  height:44px;
  border-radius:var(--btn-radius);
  padding:0 20px;
  display:inline-flex;
  align-items:center;
  gap:10px;
  font-weight:600;
  font-size:14px;
}
.btn-cancel {
  background:#ffffff;
  color:#0f1724;
  border:1px solid rgba(15,23,42,0.08);
  box-shadow:none;
}
.btn-primary {
  background:var(--brand);
  border:1px solid var(--brand);
  color:#fff;
  box-shadow: 0 10px 28px rgba(11,94,215,0.12);
}
.btn-primary:hover { background:var(--brand-strong); border-color:var(--brand-strong); transform: translateY(-1px); }

/* Responsive tweaks */
@media (max-width:600px) {
  .page-card { margin: 18px; }
  .form-actions { flex-direction:column-reverse; }
  .form-actions .btn { width:100%; justify-content:center; }
  .row.gx-3 { --bs-gutter-x: .75rem; }
  .checkbox-row { flex-direction: column; align-items: flex-start; gap: 10px; }
}
</style>

<div class="container page-card">
  <div class="card">
    <div class="card-body">
      <h3 class="page-title">{% trans "Add User" %}</h3>
      <span class="page-sub">{% trans "Create a new user for the helpdesk." %}</span>

      <form method="post" class="form helpdesk-add-user" novalidate>
        {% csrf_token %}

        <div class="row gx-3">
          <div class="col-12 col-md-6 mb-3">
            <label for="id_first_name">{{ form.first_name.label }}</label>
            {{ form.first_name }}
            <div class="field-error-space">{% for err in form.first_name.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}</div>
          </div>

          <div class="col-12 col-md-6 mb-3">
            <label for="id_last_name">{{ form.last_name.label }}</label>
            {{ form.last_name }}
            <div class="field-error-space">{% for err in form.last_name.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}</div>
          </div>

          <div class="col-12 mb-3">
            <label for="id_username">{{ form.username.label }}</label>
            {{ form.username }}
            {% if form.username.help_text %}<div class="form-text">{{ form.username.help_text }}</div>{% endif %}
            <div class="field-error-space">{% for err in form.username.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}</div>
          </div>

          <div class="col-12 mb-3">
            <label for="id_email">{{ form.email.label }}</label>
            {{ form.email }}
            {% if form.email.help_text %}<div class="form-text">{{ form.email.help_text }}</div>{% endif %}
            <div class="field-error-space">{% for err in form.email.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}</div>
          </div>

          <div class="col-12 col-md-6 mb-3">
            <label for="id_password1">{{ form.password1.label }}</label>
            {{ form.password1 }}
            {% if form.password1.help_text %}<div class="form-text">{{ form.password1.help_text }}</div>{% endif %}
            <div class="field-error-space">{% for err in form.password1.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}</div>
          </div>

          <div class="col-12 col-md-6 mb-3">
            <label for="id_password2">{{ form.password2.label }}</label>
            {{ form.password2 }}
            <div class="field-error-space">{% for err in form.password2.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}</div>
          </div>

          <div class="col-12 mb-2 d-flex align-items-center">
            <div class="form-check">
              {{ form.is_staff }}
              <label class="form-check-label" for="id_is_staff">{{ form.is_staff.label }}</label>
            </div>
            <div class="form-check">
              {{ form.is_active }}
              <label class="form-check-label" for="id_is_active">{{ form.is_active.label }}</label>
            </div>
          </div>

          {% if form.non_field_errors %}
          <div class="col-12 mb-2">
            {% for err in form.non_field_errors %}<div class="alert alert-danger mb-0">{{ err }}</div>{% endfor %}
          </div>
          {% endif %}

          <div class="col-12 form-actions mt-4">
            <a class="btn btn-cancel" href="{% url 'helpdesk:system_settings' %}">{% trans "Cancel" %}</a>
            <button type="submit" class="btn btn-primary">{% trans "Create User" %}</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- keep the existing client-side validation script unchanged -->
<script>
// Show inline required message on blur for required fields and remove on input
 (function(){
    var form = document.querySelector('form.form');
    if (!form) return;
    // translated messages from template
    var reqMsg = "{% trans 'Please fill in the required field.' %}";
    // message for invalid name characters
    var INVALID_NAME_MSG = "{% trans 'Invalid character' %}";
    // confirm/mismatch message
    var CONFIRM_MISMATCH_MSG = "{% trans 'Password did not match.' %}";
    // username constraints
    var USERNAME_MIN = 3;
    var USERNAME_MIN_MSG = "{% trans 'Username must be at least 3 characters.' %}";
    // email invalid message
    var EMAIL_INVALID_MSG = "{% trans 'Please enter a valid email address.' %}";

    function getErrorContainer(el){
        // Prefer a direct child `.field-error-space` of the field's parent (or nearest ancestor).
        // Using a deep querySelector on the parent can accidentally pick a different field's
        // error container when inputs are nested; check immediate children instead.
        var node = el && el.parentNode;
        while(node){
            try {
                // check only immediate children of this ancestor
                for(var i=0;i<node.children.length;i++){
                    var child = node.children[i];
                    if(child && child.classList && child.classList.contains('field-error-space')){
                        return child;
                    }
                }
            } catch(err) {
                // ignore and continue up the tree
            }
            node = node.parentNode;
        }
        // fallback: next sibling chain from the element itself
        var next = el.nextElementSibling;
        while(next){
            if(next.classList && next.classList.contains('field-error-space')) return next;
            next = next.nextElementSibling;
        }
        return null;
    }

    function hasClientError(container){
        if(!container) return false;
        return Boolean(container.querySelector('.client-required-error'));
    }

    function addClientError(el){
        var container = getErrorContainer(el);
        if(!container) return;
        if(hasClientError(container)) return;
        var div = document.createElement('div');
        div.className = 'text-danger small client-required-error';
        div.textContent = reqMsg;
        container.appendChild(div);
        // ensure the container has an id for aria-describedby and set it if possible
        try {
            if (!container.id && el && el.id) container.id = el.id + '-client-error';
            // visual invalid state on the input
            if (el && el.classList) el.classList.add('is-invalid');
            if (el && el.setAttribute) {
                el.setAttribute('aria-invalid', 'true');
                if (container.id) el.setAttribute('aria-describedby', container.id);
            }
        } catch (err) {}
    }

    function removeClientError(el){
        var container = getErrorContainer(el);
        if(!container) return;
        var existing = container.querySelectorAll('.client-required-error');
        existing.forEach(function(n){ n.parentNode.removeChild(n); });
        try {
            if (el && el.classList) el.classList.remove('is-invalid');
            if (el && el.removeAttribute) {
                el.removeAttribute('aria-invalid');
                // only remove aria-describedby if it points to the client error id we set
                var desc = el.getAttribute && el.getAttribute('aria-describedby');
                if (desc && container.id && desc.indexOf(container.id) !== -1) {
                    el.removeAttribute('aria-describedby');
                }
            }
        } catch(err) {}
    }

    // Password complexity helpers
    var PWD_MIN = 8;
    function joinList(arr){
        if (!arr || !arr.length) return '';
        if (arr.length === 1) return arr[0];
        if (arr.length === 2) return arr[0] + ' and ' + arr[1];
        return arr.slice(0, -1).join(', ') + ' and ' + arr[arr.length - 1];
    }

    function addPasswordError(el, msg){
        var container = getErrorContainer(el);
        if(!container) return;
        removeClientError(el);
        var div = document.createElement('div');
        div.className = 'text-danger small client-required-error';
        div.textContent = msg;
        container.appendChild(div);
        try { el.classList.add('is-invalid'); } catch (e) {}
    }

    function clearPasswordError(el){
        removeClientError(el);
        try { el.classList.remove('is-invalid'); } catch (e) {}
    }

    // Confirm-password helpers
    function addConfirmError(el, msg){
        var container = getErrorContainer(el);
        if(!container) return;
        removeClientError(el);
        var div = document.createElement('div');
        div.className = 'text-danger small client-required-error';
        div.textContent = msg;
        container.appendChild(div);
        try { el.classList.add('is-invalid'); } catch (e) {}
    }

    function clearConfirmError(el){
        removeClientError(el);
        try { el.classList.remove('is-invalid'); } catch (e) {}
    }

    // Email helpers
    function addEmailError(el, msg){
        var container = getErrorContainer(el);
        if(!container) return;
        removeClientError(el);
        var div = document.createElement('div');
        div.className = 'text-danger small client-required-error';
        div.textContent = msg;
        container.appendChild(div);
        try { el.classList.add('is-invalid'); } catch (e) {}
    }

    function clearEmailError(el){
        removeClientError(el);
        try { el.classList.remove('is-invalid'); } catch (e) {}
    }

    function passwordComplexityMessage(value){
        var v = value || '';
        var missing = [];
        if (v.length < PWD_MIN) {
            // we'll report length separately
        }
        if (!/[A-Z]/.test(v)) missing.push('uppercase');
        if (!/[a-z]/.test(v)) missing.push('lowercase');
        if (!/[0-9]/.test(v)) missing.push('number');
        if (!/[^A-Za-z0-9]/.test(v)) missing.push('special character');

        var wantsLen = v.length < PWD_MIN;
        if (wantsLen && missing.length === 0) {
            return 'Password must be at least ' + PWD_MIN + ' characters long';
        }
        if (!wantsLen && missing.length > 0) {
            return 'Password must contain ' + joinList(missing);
        }
        if (wantsLen && missing.length > 0) {
            return 'Password must be at least ' + PWD_MIN + ' characters long and must contain ' + joinList(missing);
        }
        return '';
    }


    function addNameInvalidError(el){
        var container = getErrorContainer(el);
        if(!container) return;
        // remove existing client errors first
        removeClientError(el);
        var div = document.createElement('div');
        div.className = 'text-danger small client-required-error';
        div.textContent = INVALID_NAME_MSG;
        container.appendChild(div);
        // visual invalid state
        el.classList.add('is-invalid');
    }

    function clearNameInvalidState(el){
        removeClientError(el);
        try { el.classList.remove('is-invalid'); } catch (e) {}
    }

    // helper: determine if a field currently meets client-side validation rules
    function isFieldValid(field){
        if(!field) return false;
        var id = field.id || '';
        var v = field.value || '';
        // required non-empty
        if(field.hasAttribute('required')){
            if(!v || (typeof v === 'string' && v.trim() === '')) return false;
        }
        // username min length
        try {
            if(id === 'id_username'){
                return (v || '').trim().length >= USERNAME_MIN;
            }
        } catch(e) {}
        // email format
        if(id === 'id_email'){
            var reEmail = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
            return reEmail.test((v || '').trim());
        }
        // name fields: no invalid characters
        if(id === 'id_first_name' || id === 'id_last_name'){
            try {
                var invalidCharRe_local = null;
                try {
                    invalidCharRe_local = new RegExp("[^\\p{L} .'\\-]", 'u');
                } catch(e) {
                    invalidCharRe_local = null;
                }
                if(!invalidCharRe_local) return true; // can't perform strict unicode check
                return !invalidCharRe_local.test(v || '');
            } catch(err){
                return true;
            }
        }
        // password complexity
        if(id === 'id_password1'){
            return passwordComplexityMessage(v || '') === '';
        }
        // confirm match
        if(id === 'id_password2'){
            var p1 = document.getElementById('id_password1');
            var v1 = p1 ? (p1.value || '') : '';
            return (v || '') !== '' && v === v1;
        }
        return true;
    }

    var requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(function(field){
        field.addEventListener('blur', function(){
            // On blur, only remove the client error if the field currently passes validation.
            if(!isFieldValid(field)){
                addClientError(field);
            } else {
                removeClientError(field);
            }
            updateSubmitState();
        });

        // on input: only remove client error if the field currently passes validation
        field.addEventListener('input', function(){
            if(isFieldValid(field)){
                removeClientError(field);
            }
            updateSubmitState();
        });
    });

    // Disable submit until all required fields are non-empty
    var submitBtn = form.querySelector('button[type="submit"]');
    function areAllRequiredFilled(){
        for(var i=0;i<requiredFields.length;i++){
            var f = requiredFields[i];
            if(!f.value || (typeof f.value === 'string' && f.value.trim() === '')) return false;
        }
        return true;
    }

    function updateSubmitState(){
        if(!submitBtn) return;
        var enabled = areAllRequiredFilled();
        try {
            var uname = document.getElementById('id_username');
            if (uname) {
                var v = (uname.value || '').trim();
                if (v.length < USERNAME_MIN) enabled = false;
            }
        } catch (e) {}
        submitBtn.disabled = !enabled;
    }

    // call on input/change/blur
    requiredFields.forEach(function(f){
        f.addEventListener('input', updateSubmitState);
        f.addEventListener('change', updateSubmitState);
        f.addEventListener('blur', updateSubmitState);
    });

    // initial state
    updateSubmitState();

    // Prevent submit if not all required filled and show inline messages
    form.addEventListener('submit', function(e){
        if(!areAllRequiredFilled()){
            e.preventDefault();
            requiredFields.forEach(function(f){
                if(!f.value || (typeof f.value === 'string' && f.value.trim() === '')){
                    addClientError(f);
                }
            });
            if(submitBtn) submitBtn.disabled = true;
        }
    });
    // Immediate invalid-character detection for name fields: show message as soon as a disallowed char is typed
    (function(){
        var first = document.getElementById('id_first_name');
        var last = document.getElementById('id_last_name');
        if (!first && !last) return;
        // allowed: Unicode letters, space, dot, apostrophe, hyphen
        var invalidCharRe = null;
        try {
            invalidCharRe = new RegExp("[^\\p{L} .'\\-]", 'u');
        } catch(err) {
            invalidCharRe = null;
        }
        function onNameInput(e){
            var el = e.target;
            var v = el.value || '';
            if (v && invalidCharRe && invalidCharRe.test(v)) {
                addNameInvalidError(el);
            } else {
                clearNameInvalidState(el);
            }
            updateSubmitState();
        }
        if (first) first.addEventListener('input', onNameInput);
        if (last) last.addEventListener('input', onNameInput);
    })();

    // Username live validation (min length)
    (function(){
        var uname = document.getElementById('id_username');
        if (!uname) return;
        function showUsernameMsg(){
            var v = (uname.value || '').trim();
            var container = getErrorContainer(uname);
            if (!container) return;
            // If empty: show required message (don't clear it) and return.
            if (v.length === 0) {
                if (uname.hasAttribute && uname.hasAttribute('required')) {
                    addClientError(uname);
                } else {
                    removeClientError(uname);
                }
                updateSubmitState();
                return;
            }
            // remove prior client-required errors for non-empty values
            removeClientError(uname);
            if (v.length < USERNAME_MIN) {
                var div = document.createElement('div');
                div.className = 'text-danger small client-required-error';
                div.textContent = USERNAME_MIN_MSG;
                container.appendChild(div);
                try { uname.classList.add('is-invalid'); } catch(e){}
            } else {
                try { uname.classList.remove('is-invalid'); } catch(e){}
            }
            updateSubmitState();
        }
        uname.addEventListener('input', showUsernameMsg);
        uname.addEventListener('blur', showUsernameMsg);
    })();

    // Email live validation
    (function(){
        var el = document.getElementById('id_email');
        if (!el) return;
        var re = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
        function validateEmailInput(){
            var v = el.value ? el.value.trim() : '';
            // If empty and the field is required, show the required message; otherwise clear.
            if (!v) {
                if (el.hasAttribute && el.hasAttribute('required')) {
                    // use generic required message so placement/formatting is consistent
                    addClientError(el);
                } else {
                    clearEmailError(el);
                }
                updateSubmitState();
                return;
            }
            if (!re.test(v)) {
                addEmailError(el, EMAIL_INVALID_MSG);
            } else {
                clearEmailError(el);
            }
            updateSubmitState();
        }
        el.addEventListener('input', validateEmailInput);
        el.addEventListener('blur', validateEmailInput);
        // instant duplicate-email check on input (debounced) and blur
        var emailCheckTimer = null;
        function runEmailExistsCheck(v){
            try {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '{% url "helpdesk:ajax_email_exists" %}?email=' + encodeURIComponent(v), true);
                xhr.onreadystatechange = function(){
                    if (xhr.readyState === 4 && xhr.status === 200){
                        try {
                            var data = JSON.parse(xhr.responseText);
                            if (data && data.exists){
                                addEmailError(el, "Invalid email.");
                            } else {
                                if (re.test(v)) clearEmailError(el);
                            }
                        } catch(err){}
                    }
                };
                xhr.send();
            } catch(err){}
        }
        el.addEventListener('input', function(){
            var v = el.value ? el.value.trim() : '';
            if (!v || !re.test(v)) return;
            if (emailCheckTimer) clearTimeout(emailCheckTimer);
            emailCheckTimer = setTimeout(function(){ runEmailExistsCheck(v); }, 300);
        });
        el.addEventListener('blur', function(){
            var v = el.value ? el.value.trim() : '';
            if (!v || !re.test(v)) return;
            if (emailCheckTimer) { clearTimeout(emailCheckTimer); emailCheckTimer = null; }
            runEmailExistsCheck(v);
        });
        // also validate on form submit to block invalid emails
        form.addEventListener('submit', function(e){
            var v = el.value ? el.value.trim() : '';
            if (v && !re.test(v)) {
                addEmailError(el, EMAIL_INVALID_MSG);
                e.preventDefault();
                el.focus();
            }
        });
    })();

    // Password complexity live feedback
    (function(){
        var pwd = document.getElementById('id_password1');
        if (!pwd) return;
        pwd.addEventListener('input', function(){
            var msg = passwordComplexityMessage(pwd.value || '');
            if (msg) addPasswordError(pwd, msg);
            else clearPasswordError(pwd);
            updateSubmitState();
        });
        pwd.addEventListener('blur', function(){
            var v = pwd.value || '';
            if (!v) {
                // If required show generic required message; otherwise clear
                if (pwd.hasAttribute && pwd.hasAttribute('required')) addClientError(pwd);
                else clearPasswordError(pwd);
                return;
            }
            var msg = passwordComplexityMessage(v);
            if (msg) addPasswordError(pwd, msg);
            else clearPasswordError(pwd);
        });
    })();

    // Confirm password: forbid paste/drop and validate match
    (function(){
        var pwd1 = document.getElementById('id_password1');
        var pwd2 = document.getElementById('id_password2');
        if (!pwd2) return;
        // check mismatch only when confirm has a value (do NOT show required here)
        function checkConfirmMismatch(){
            var v1 = pwd1 ? (pwd1.value || '') : '';
            var v2 = pwd2.value || '';
            if (!v2) return; // do not show required on input
            if (v1 !== v2) addConfirmError(pwd2, CONFIRM_MISMATCH_MSG);
            else clearConfirmError(pwd2);
            updateSubmitState();
        }

        function showOrClear(){
            // on blur: show required if empty, otherwise run mismatch check
            var v2 = pwd2.value || '';
            if (!v2) {
                if (pwd2.hasAttribute && pwd2.hasAttribute('required')) addClientError(pwd2);
                else clearConfirmError(pwd2);
                updateSubmitState();
                return;
            }
            // non-empty -> check mismatch
            checkConfirmMismatch();
        }

        // block paste/drop
        pwd2.addEventListener('paste', function(e){ e.preventDefault(); });
        pwd2.addEventListener('drop', function(e){ e.preventDefault(); });
        pwd2.addEventListener('beforeinput', function(e){ try { if (e.inputType === 'insertFromPaste' || e.inputType === 'insertFromDrop') e.preventDefault(); } catch(err){} });
        // on input only perform mismatch checks (do not show required on input)
        pwd2.addEventListener('input', checkConfirmMismatch);
        pwd2.addEventListener('blur', showOrClear);
        // when primary password changes, only run mismatch check if confirm has a value
        if (pwd1) pwd1.addEventListener('input', checkConfirmMismatch);
    })();
  
        // On load: if server rendered per-field errors exist, mirror them into the
        // client-side error containers so all validation appears in the same place.
        function syncServerErrors() {
            var fields = ['first_name','last_name','username','email','password1','password2'];
            fields.forEach(function(name){
                try {
                    var server = document.getElementById('id_' + name + '-server-error');
                    var client = document.getElementById('id_' + name + '-client-error');
                    var fieldEl = document.getElementById('id_' + name);
                    if (!server || !client || !fieldEl) return;
                    var text = server.textContent ? server.textContent.trim() : '';
                    if (text) {
                        // place the message into the client box and mark the field invalid
                        client.textContent = text;
                        client.style.visibility = 'visible';
                        fieldEl.classList.add('is-invalid');
                        fieldEl.setAttribute('aria-invalid', 'true');
                        fieldEl.setAttribute('aria-describedby', client.id);
                        // clear the server box so it doesn't duplicate visually; CSS will
                        // hide it because it's empty (keeps reserved space behavior)
                        server.textContent = '';
                    }
                } catch (err) {
                    // ignore any issues
                }
            });
        }
})();
</script>
{% endblock %}
