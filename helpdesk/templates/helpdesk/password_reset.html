{# Override navigation header to hide search bar and log in button for this page only #}
{% extends "helpdesk/public_base.html" %}{% load i18n static %}
{% block header %}
  <nav class="navbar navbar-expand static-top" style="background-color: #000C7D;">
    <div class="d-flex align-items-center">
      <a class="navbar-brand" href="/" style="color: white; text-decoration: none; font-size: 16px; font-weight: 700; font-family: 'Montserrat', sans-serif; user-select: none; pointer-events: none; margin-left: 5px;">{% trans 'PrimeDesk Technologies' %}</a>
    </div>
    <!-- No search bar, no log in button -->
  </nav>
{% endblock %}

{% block helpdesk_title %}{% trans "Forgot password" %}{% endblock %}

{% block helpdesk_head %}
  <style>
    /* Floating-label textbox style from the login page */
    :root { --input-padding-x: 0.75rem; --input-padding-y: 0.75rem; }
    .reset-wrapper { padding: 80px 20px; display:flex; align-items:center; justify-content:center; }
  /* slightly wider card for better spacing */
  .reset-card { width: 540px; max-width:94%; padding: 28px; border-radius: 12px; background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.06); border: 1px solid #9c9c9c; }
    .reset-card h1 { margin: 0 0 6px 0; font-size: 20px; }
    .reset-card p { margin: 0 0 16px 0; color: #444; }

    /* Floating label (shared login style) */
    .form-label-group { position: relative; }
    .form-label-group > input,
    .form-label-group > label { padding: var(--input-padding-y) var(--input-padding-x); height: auto; }
    .form-label-group > label {
      position: absolute;
      top: 0;
      left: 0;
      display: block;
      width: 100%;
      margin-bottom: 12px;
      /* Override default `<label>` margin */
      line-height: 1.5;
      color: #495057;
      border: 1px solid transparent;
      border-radius: 0.25rem;
      -webkit-transition: all 0.1s ease-in-out;
      transition: all 0.1s ease-in-out;
    }
    .form-label-group input::-webkit-input-placeholder { color: transparent; }
    .form-label-group input:-ms-input-placeholder { color: transparent; }
    .form-label-group input::-ms-input-placeholder { color: transparent; }
    .form-label-group input::placeholder { color: transparent; }
    .form-label-group input:not(:placeholder-shown) {
      padding-top: calc(var(--input-padding-y) + var(--input-padding-y) * (2 / 3));
      padding-bottom: calc(var(--input-padding-y) / 3);
    }
    .form-label-group input:not(:placeholder-shown) ~ label {
      padding-top: calc(var(--input-padding-y) / 3);
      padding-bottom: calc(var(--input-padding-y) / 3);
      font-size: 12px;
      color: #777;
    }

  .form-control { width: 100%; padding: 12px 14px; border-radius: 8px; border: 1px solid #ccc; font-size:15px; line-height:1.4; }
  .form-label { display:block; margin-bottom:8px; font-size:14px; color:#333; }
    .reset-card input[type="email"],
    .reset-card input[type="text"],
    .reset-card input#id_email {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 15px;
      line-height: 1.4;
      color: #222;
      background: #fff;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }
    .reset-card input[type="email"]:focus,
    .reset-card input#id_email:focus {
      outline: none;
      border-color: #0b57d0;
      box-shadow: 0 6px 20px rgba(11,87,208,0.08);
    }
  /* Arrange actions horizontally on wider screens, stack on small screens */
  .reset-actions { display:flex; flex-direction:row; gap:12px; margin-top: 14px; align-items:center; justify-content:center; width:100%; }
    /* Primary button: brand color and rounded rectangle */
    .btn-primary {
      min-width: 180px;
      padding: 8px 12px;
      border-radius: 15px;
      background-color: #000C7D;
      color: #ffffff;
      border: 1px solid #000C7D;
      font-weight: normal;
      text-align: center;
      cursor: pointer;
      transition: transform 90ms ease, background-color 120ms ease, box-shadow 120ms ease;
      display: inline-block;
      font-size: 14px;
    }
    .btn-primary:hover, .btn-primary:focus {
      background-color: #08104f;
      border-color: #08104f;
      transform: translateY(-1px);
    }
    /* Secondary button: white with brand border/text */
    .btn-secondary {
      min-width: 140px;
      padding: 8px 12px;
      border-radius: 15px;
      background: #ffffff;
      border: 1px solid #333;
      color: #333;
      text-align: center;
      display: inline-block;
      font-weight: normal;
      font-size: 14px;
    }
    .btn-secondary:hover, .btn-secondary:focus {
      background: #3333336c;
      text-decoration: none;
    }
      /* Shared interactive behavior for both buttons */
      .btn-primary,
      .btn-secondary {
        min-width: 140px;
        padding: 8px 12px;
        border-radius: 15px;
        text-align: center;
        display: inline-block;
        font-weight: normal;
        cursor: pointer;
        transition: transform 90ms ease, background-color 120ms ease, border-color 120ms ease, box-shadow 120ms ease, color 120ms ease;
        will-change: transform, background-color;
      }
      /* Primary color (brand) */
      .btn-primary {
        background-color: #000C7D;
        color: #ffffff;
        border: 1px solid #000C7D;
      }
      /* Secondary: white with brand border/text */
      .btn-secondary {
        background: #ffffff;
        border: 1px solid #333;
        color: #333;
      }
      /* Hover and focus show the same motion/feedback for both buttons */
      .btn-primary:hover,
      .btn-primary:focus,
      .btn-secondary:hover,
      .btn-secondary:focus {
        transform: translateY(-1px);
        outline: none;
      }
      /* Color-specific hover adjustments */
      .btn-primary:hover { background-color: #08104f; border-color: #08104f; }
      .btn-secondary:hover { background-color: #33333334; color: #333;}
      /* Strong focus ring for keyboard users (use brand accent) */
      .btn-primary:focus-visible {
        box-shadow: 0 0 0 4px rgba(0,12,125,0.12);
      }
      /* Active/pressed state */
      .btn-primary:active,
      .btn-secondary:active {
        transform: translateY(0);
        transition-duration: 60ms;
      }
    @media (max-width: 480px) {
      .reset-actions { flex-direction: column; }
      .btn-primary, .btn-secondary { width: 90% !important; display: block; }
    }
    .helper-note { font-size: 13px; color: #666; margin-top: 10px; }
    /* Field error visuals (match login page) */
    .field-error {
      color: #c62828; /* professional red */
      font-size: 12px;
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .field-error::before {
      content: "\26A0"; /* warning triangle */
      font-size: 13px;
      line-height: 1;
      color: #c62828;
    }
    input.is-invalid, textarea.is-invalid {
      border-color: #c62828 !important;
      box-shadow: none !important;
    }
  </style>
{% endblock %}

{% block helpdesk_body %}
  <div class="reset-wrapper">
    <div class="reset-card">
      <h1>{% trans "Forgot your password?" %}</h1>
      <p>{% trans "Enter the email address associated with your account and we'll send instructions to reset your password." %}</p>

      <form method="post" action="." novalidate>
        {% csrf_token %}
        {# show non-field errors (e.g., general form errors) #}
        {% if form.non_field_errors %}
          {% for err in form.non_field_errors %}
            <div class="field-error" aria-live="polite">{{ err }}</div>
          {% endfor %}
        {% endif %}

          <div class="form-group">
            <label for="id_email" class="form-label">{% trans "Enter your email address:" %}</label>
            {{ form.email }}
            {% if form.email.errors %}
              {% for err in form.email.errors %}
                {% if err == "This field is required." %}
                  <div id="id_email-error" class="field-error" aria-live="polite">{% trans "Please fill in the required field." %}</div>
                {% else %}
                  <div id="id_email-error" class="field-error" aria-live="polite">{{ err }}</div>
                {% endif %}
              {% endfor %}
            {% endif %}
          </div>

        <div class="reset-actions">
          <div class="reset-actions-inner">
            <a href="/login/" class="btn-secondary">{% trans "Back to login" %}</a>
            <button type="submit" class="btn-primary">{% trans "Send reset link" %}</button>
          </div>
        </div>
        <div class="helper-note">{% trans "If an account exists for the email provided, you'll receive an email with further instructions." %}</div>
      </form>

      <script>
        // Client-side validation: show a persistent "Please enter a valid email."
        // message until the value matches a simple email pattern. Keep server-side
        // errors intact; client errors use a separate element so both can coexist.
        (function(){
          try {
            var emailInput = document.getElementById('id_email');
            if (!emailInput) return;

            if (!emailInput.classList.contains('form-control')) {
              emailInput.classList.add('form-control');
            }
            emailInput.setAttribute('autocomplete', 'email');
            if (!emailInput.getAttribute('placeholder')) {
              emailInput.setAttribute('placeholder', 'name@example.com');
            }
            if (emailInput.style && emailInput.style.height) {
              emailInput.style.height = '';
            }

            var serverErr = document.getElementById('id_email-error');

            // Create or return the client-side error element (separate id)
            function getClientErr() {
              var id = 'id_email-client-error';
              var el = document.getElementById(id);
              if (!el) {
                el = document.createElement('div');
                el.id = id;
                el.className = 'field-error';
                el.setAttribute('aria-live', 'polite');
                // insert after server error if present, otherwise after input
                if (serverErr && serverErr.parentNode) serverErr.parentNode.insertBefore(el, serverErr.nextSibling);
                else emailInput.parentNode.insertBefore(el, emailInput.nextSibling);
              }
              return el;
            }

            function updateAriaDescribedBy() {
              var ids = [];
              if (serverErr) ids.push(serverErr.id);
              var client = document.getElementById('id_email-client-error');
              if (client) ids.push(client.id);
              if (ids.length) emailInput.setAttribute('aria-describedby', ids.join(' '));
              else emailInput.removeAttribute('aria-describedby');
            }

            function showClientMessage(msg) {
              var el = getClientErr();
              el.textContent = msg;
              // client errors are removable, so mark flag
              el._serverError = false;
              emailInput.classList.add('is-invalid');
              emailInput.setAttribute('aria-invalid', 'true');
              updateAriaDescribedBy();
            }

            function clearClientMessage() {
              var el = document.getElementById('id_email-client-error');
              if (el && el.parentNode) el.parentNode.removeChild(el);
              // if there is still a server error, keep invalid state; otherwise clear
              if (!serverErr) {
                emailInput.classList.remove('is-invalid');
                emailInput.removeAttribute('aria-invalid');
              }
              updateAriaDescribedBy();
            }

            // Simple email pattern: something@something.tld (sufficient for client-side)
            var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            // On load: if empty, show required message (client) unless server rendered error
            if (!emailInput.value || !emailInput.value.trim()) {
              if (!serverErr) showClientMessage('Please fill in the required field.');
            } else {
              // if non-empty but invalid, show invalid message
              if (!emailPattern.test(emailInput.value.trim())) {
                showClientMessage('Please enter a valid email.');
              } else {
                clearClientMessage();
              }
            }

            // On input: validate and show required/invalid until the value becomes valid
            emailInput.addEventListener('input', function() {
              var v = emailInput.value ? emailInput.value.trim() : '';
              if (!v) {
                // empty => required
                if (!serverErr) showClientMessage('Please fill in the required field.');
              } else if (!emailPattern.test(v)) {
                // non-empty but invalid => persistent invalid message
                showClientMessage('Please enter a valid email.');
              } else {
                // valid => remove client errors
                clearClientMessage();
              }
            });

            // On submit: re-check; allow submission if valid, otherwise prevent and focus
            var form = emailInput.form;
            if (form) {
              form.addEventListener('submit', function(e) {
                var v = emailInput.value ? emailInput.value.trim() : '';
                if (!v || !emailPattern.test(v)) {
                  // show message and prevent submit
                  if (!v) showClientMessage('Please fill in the required field.'); else showClientMessage('Please enter a valid email.');
                  try { emailInput.focus(); } catch(_) {}
                  e.preventDefault();
                }
              });
            }

          } catch (err) { /* ignore to avoid blocking page */ }
        })();
      </script>
    </div>
  </div>
{% endblock %}
