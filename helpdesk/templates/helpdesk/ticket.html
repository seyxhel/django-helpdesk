{% extends "helpdesk/base.html" %}
{% load i18n bootstrap4form humanize %}
{% load static %}



{% block helpdesk_title %}{{ ticket.queue.slug }}-{{ ticket.id }} : {% trans "View Ticket Details" %}{% endblock %}

{% block h1_title %}{{ ticket.ticket_for_url }}{% endblock %}

{% block helpdesk_breadcrumb %}
<li class="breadcrumb-item">
    <a href="{% url 'helpdesk:list' %}">{% trans "Tickets" %}</a>
</li>
<li class="breadcrumb-item active">
    {{ ticket.queue.slug }}-{{ ticket.id }}
</li>
{% endblock %}

{% block helpdesk_body %}
	{% if form.errors %}
	    {% include 'helpdesk/include/alert_form_errors.html' %}
	{% endif %}
    {% if helpdesk_settings.HELPDESK_TRANSLATE_TICKET_COMMENTS %}
        <div id="google_translate_element"></div>
        <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    {% endif %}

  {% include ticket_desc_template|default:"helpdesk/ticket_desc_table.html" %}

    {% if ticket.merged_to %}
        <div class="card card-body bg-light">
            <h3 class="text-center">
                {% trans "This ticket has been merged into ticket" %}
                <a href="{{ ticket.merged_to.get_absolute_url }}">{{ ticket.merged_to }}</a>
            </h3>
        </div>
    {% else %}
        {% if ticket.followup_set.all %}
        {% load ticket_to_link %}
            <div class="card mb-3">
                <div class="card-header"><i class="fas fa-clock fa-fw fa-lg"></i>&nbsp;{% trans "Follow-Ups" %}</div>
                <div class="card-body">
                    <div class="list-group">
                    {% for followup in ticket.followup_set.all %}
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ followup.title|escape|num_to_link }}</h5>
                                <small><i class="fas fa-clock"></i>&nbsp;<span class='byline text-info'>{% if followup.user %}by {{ followup.user }},{% endif %} <span title='{{ followup.date|date:"DATETIME_FORMAT" }}'>{{ followup.date|naturaltime }}</span>{% if helpdesk_settings.HELPDESK_ENABLE_TIME_SPENT_ON_TICKET %}{% if followup.time_spent %}{% endif %}, <span>{% trans "time spent" %}: {{ followup.time_spent_formated }}</span>{% endif %} {% if not followup.public %} <span class='private'>({% trans "Private" %})</span>{% endif %}</span></small>
                            </div>
                            <p class="mb-1">
                                {% if followup.comment %}
                                    <p>{{ followup.get_markdown|urlizetrunc:50|num_to_link }}</p>
                                {% endif %}
                                {% for change in followup.ticketchange_set.all %}
                                    {% if forloop.first %}<div class='changes'><ul>{% endif %}
                                    <li>{% blocktrans with change.field as field and change.old_value as old_value and change.new_value as new_value %}Changed {{ field }} from {{ old_value }} to {{ new_value }}.{% endblocktrans %}</li>
                                    {% if forloop.last %}</ul></div>{% endif %}
                                {% endfor %}
                                {% if helpdesk_settings.HELPDESK_ENABLE_ATTACHMENTS %}
                                    {% for attachment in followup.followupattachment_set.all %}{% if forloop.first %}{% trans "Attachments" %}:<div class='attachments'><ul>{% endif %}
                                    <li><a href='{{ attachment.file.url }}'>{{ attachment.filename }}</a> ({{ attachment.mime_type }}, {{ attachment.size|filesizeformat }})
                                        {# delete button removed - attachments are shown read-only here #}
                                    </li>
                                        {% if forloop.last %}</ul></div>{% endif %}
                                    {% endfor %}
                                {% endif %}
                            </p>
                            <!--- ugly long test to suppress the following if it will be empty, to save vertical space -->
                            {% with possible=helpdesk_settings.HELPDESK_SHOW_EDIT_BUTTON_FOLLOW_UP %}
                                {% if  possible and followup.user and request.user == followup.user and not followup.ticketchange_set.all or  possible and user.is_superuser and helpdesk_settings.HELPDESK_SHOW_DELETE_BUTTON_SUPERUSER_FOLLOW_UP %}
                                <small class="d-flex justify-content-end align-items-center gap-2">
                                    {% if helpdesk_settings.HELPDESK_SHOW_EDIT_BUTTON_FOLLOW_UP %}
                                        {% if followup.user and request.user == followup.user and not followup.ticketchange_set.all %}
                                        <a href="{% url 'helpdesk:followup_edit' ticket.id followup.id %}" class='followup-edit'><button type="button" class="btn btn-warning btn-sm float-right"><i class="fas fa-edit"></i></button></a>
                                        {% endif %}
                                    {% endif %}
                                    {% if user.is_superuser and helpdesk_settings.HELPDESK_SHOW_DELETE_BUTTON_SUPERUSER_FOLLOW_UP %}
                                        <!-- if both edit and delete are present then put a spacer in -->
                                        {% if helpdesk_settings.HELPDESK_SHOW_EDIT_BUTTON_FOLLOW_UP and followup.user and request.user == followup.user and not followup.ticketchange_set.all %}
                                            <span class="text-muted px-2">|</span>
                                        {% endif %}
                                        <a href="{% url 'helpdesk:followup_delete' ticket.id followup.id %}" class='followup-edit'><button type="button" class="btn btn-warning btn-sm float-right"><i class="fas fa-trash"></i></button></a>
                                    {% endif %}
                                </small>
                            {% endif %}{% endwith %}
                        </div>
                        <!-- /.list-group-item -->
                    {% endfor %}
                    </div>
                    <!-- /.list-group -->
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->

        {% endif %}

        <div class="card mb-3">
          <div class="card-header">{% trans "Respond to this ticket" %}</div>
          <div class="card-body">

    <form method="post" action="{% url 'helpdesk:update' ticket.id %}" enctype="multipart/form-data" novalidate>
      <fieldset>
        <div class="form-row">
          <!-- Main column: comment + presets -->
          <div class="col-lg-8 col-md-12 mb-3">
            {% if preset_replies %}
            <div class="form-group">
              <label for="id_preset" class="font-weight-600">{% trans "Use a Pre-set Reply" %} <small class="text-muted">({% trans "Optional" %})</small></label>
              <select name="preset" id="id_preset" class="custom-select">
                <option value="">{% trans "Choose..." %}</option>
                {% for preset in preset_replies %}
                <option value="{{ preset.id }}">{{ preset.name }}</option>
                {% endfor %}
              </select>
              <small class="form-text text-muted">
                {% trans "Selecting a pre-set reply will over-write your comment below. You can then modify the pre-set reply to your liking before saving this update." %}
              </small>
            </div>
            {% endif %}

            <div class="form-group">
              <label for="commentBox" class="font-weight-600">{% trans "Comment / Resolution" %}</label>
              <textarea id="commentBox" name="comment" rows="8" class="form-control" placeholder="{% trans 'Write your comment or resolution here...' %}">{% if form.errors %}{{ xform.comment }}{% endif %}</textarea>
              {% url "helpdesk:help_context" as context_help_url %}
              <small class="form-text text-muted">
                {% blocktrans %}
                You can insert ticket and queue details in your message. For more information, see the <a href='{{ context_help_url }}'>context help page</a>.
                {% endblocktrans %}
              </small>
            </div>

            <!-- Attachments toggle kept for backward compatibility -->
            {% if helpdesk_settings.HELPDESK_ENABLE_ATTACHMENTS %}
            <p id="ShowFileUploadPara" class="mb-2">
              <button type="button" id="ShowFileUpload" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-paperclip mr-1"></i> {% trans "Attach File(s)" %} &raquo;
              </button>
            </p>
            <div id="FileUpload" style="display: none;">
              <div class="form-group">
                <label for="file0">{% trans "Attach a File" %}</label>
                <div class="add_file_fields_wrap">
                  <button class="add_file_field_button btn btn-sm btn-success mb-2">{% trans "Add Another File" %}</button>
                  <div>
                    <label class="btn btn-primary btn-sm btn-file">
                      Browse... <input type="file" name="attachment" id="file0" style="display: none;" />
                    </label>
                    <span class="ml-2" id="selectedfilename0">{% trans 'No files selected.' %}</span>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Side column: status / public / time / actions -->
          <div class="col-lg-4 col-md-12">
            <div class="card card-body p-3 mb-3">
              <div class="mb-2">
                <label class="d-block font-weight-600">{% trans "Edit Status" %}</label>
                {% if not ticket.can_be_resolved %}
                  <small class="d-block text-muted mb-2">{% trans "This ticket cannot be resolved or closed until the tickets it depends on are resolved." %}</small>
                {% endif %}
                <div class="btn-group-toggle btn-group d-flex flex-wrap" data-toggle="buttons" role="group" aria-label="{% trans 'Status' %}">
                  {% for status_choice in ticket.get_allowed_status_flow %}
                    {% comment %} Use the status name as a stable id (lowered) {% endcomment %}
                    <label class="btn btn-outline-secondary mb-2 flex-fill {% if ticket.status == status_choice.0 %}active{% endif %}">
                      <input type="radio"
                             name="new_status"
                             value="{{ status_choice.0 }}"
                             id="st_{{ status_choice.1|lower }}"
                             {% if not ticket.can_be_resolved %} disabled="disabled"{% endif %}
                             {% if ticket.status == status_choice.0 %} checked="checked"{% endif %}>
                      {{ status_choice.1 }}
                    </label>
                  {% endfor %}
                  <label class="btn btn-outline-secondary mb-2 flex-fill {% if ticket.status == 'reopened' %}active{% endif %}">
                      <input type="radio" name="new_status" value="reopened" id="st_reopened" {% if ticket.status == 'reopened' %} checked="checked"{% endif %}>
                      {% trans "Reopened" %}
                  </label>
                </div>
              </div>

              {% if helpdesk_settings.HELPDESK_UPDATE_PUBLIC_DEFAULT %}
                <input type="hidden" name="public" value="1">
              {% else %}
                <div class="form-group form-check mb-2">
                  <input type="checkbox" class="form-check-input" id="id_public" name="public" value="1" checked="checked">
                  <label class="form-check-label" for="id_public">{% trans "Yes, make this update public." %}</label>
                  <small class="form-text text-muted">{% trans "If this is public, the submitter will be e-mailed your comment or resolution." %}</small>
                </div>
              {% endif %}

              {% if helpdesk_settings.HELPDESK_ENABLE_TIME_SPENT_ON_TICKET and user.is_staff %}
              <div class="form-group mb-2">
                <label for="id_time_spent" class="font-weight-600">{% trans "Time spent" %} <small class="text-muted">({% trans "Optional" %})</small></label>
                <input id="id_time_spent" name="time_spent" type="time" class="form-control" value="{% if form.errors %}{{ xform.time_spent }}{% endif %}" />
              </div>
              {% endif %}

            </div>
          </div>
        </div> <!-- /.form-row -->

                      <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-outline-warning btn-sm mr-2" id="ShowFurtherEditOptions">{% trans "Change Further Details" %} &raquo;</button>
                <button type="submit" class="btn btn-primary">{% trans "Update This Ticket" %}</button>
              </div>

        <!-- Further edit options (keeps existing ids for JS hooks) -->
        <div id="FurtherEditOptions" style="display: none;">
          <div class="card card-body mb-3">
            <div class="form-row">
              <div class="form-group col-md-12">
                <label for="id_title" class="font-weight-600">{% trans "Title" %}</label>
                <input type="text" class="form-control" id="id_title" name="title" value="{{ ticket.title|escape }}" />
              </div>

              <div class="form-group col-md-6">
                <label for="id_owner" class="font-weight-600">{% trans "Owner" %}</label>
                <select id="id_owner" name="owner" class="custom-select">
                  <option value="0">{% trans "Unassigned" %}</option>
                  {% for u in assignable_users %}
                    <option value="{{ u.id }}"{% if u.id == ticket.assigned_to.id %} selected{% endif %}>{{ u }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group col-md-6">
                <label for="id_priority" class="font-weight-600">{% trans "Priority" %}</label>
                <select id="id_priority" name="priority" class="custom-select">
                  {% for p in priorities %}
                    <option value="{{ p.0 }}"{% if p.0 == ticket.priority %} selected{% endif %}>{{ p.1 }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group col-md-6">
                <label for="id_queue" class="font-weight-600">{% trans "Queue" %}</label>
                <select id="id_queue" name="queue" class="custom-select">
                  {% for queue_id, queue_name in queues %}
                    <option value="{{ queue_id }}"{% if queue_id == ticket.queue.id %} selected{% endif %}>{{ queue_name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group col-md-6">
                <label for="id_due_date" class="font-weight-600">{% trans "Due on" %}</label>
                <div>{{ form.due_date }}</div>
              </div>
            </div>

            <div class="mt-2">
              <label class="font-weight-600">{% trans "Custom fields" %}</label>
              <div>{{ customfields_form }}</div>
            </div>
          </div>
        </div>

        {% if ticket.checklists.exists %}
        <div class="mb-3">
          <button type="button" class="btn btn-outline-warning btn-sm" id="ShowChecklistEditOptions">{% trans "Update checklists" %} &raquo;</button>
          <div id="checklistEdit" style="display: none;" class="mt-3">
            <div class="row">
              {% for checklist in ticket.checklists.all %}
              <div class="col-sm-4 col-xs-12 mb-3">
                <div class="card h-100">
                  <div class="card-header"><h5 class="mb-0">{{ checklist }}</h5></div>
                  <div class="card-body">
                    <div class="list-group">
                      {% for task in checklist.tasks.all %}
                        <div class="list-group-item"{% if task.completion_date %} title="{% trans "Completed on" %} {{ task.completion_date }}"{% endif %}>
                          <label class="mb-0">
                            <input type="checkbox" name="checklist-{{ checklist.id }}" value="{{ task.id }}" {% if task.completion_date %} checked{% endif %}>
                            {{ task }}
                          </label>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        {% csrf_token %}
      </fieldset>
    </form>
  </div>
</div>

    <div class="modal fade" id="createChecklistModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          {% if staff_only_view %}
          <form method="post">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title">{% trans "Select a checklist" %}</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="{% trans 'Close' %}">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              {{ checklist_form.as_p }}
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">{% trans "Select" %}</button>
            </div>
          </form>
          {% else %}
          <form method="post">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title">{% trans "Add a new checklist" %}</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="{% trans 'Close' %}">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>{% trans "You can select a template to generate a checklist with a predefined set of tasks." %}</p>
              <p>{% trans "Ignore it and only give a name to create an empty checklist." %}</p>
              {{ checklist_form.as_p }}
            </div>
            <div class="modal-footer">
              <a class="btn btn-secondary" href="{% url 'helpdesk:checklist_templates' %}">
                {% trans "Manage templates" %}
              </a>
              <button type="submit" class="btn btn-primary">{% trans "Add" %}</button>
            </div>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Delete confirmation modal -->
    <div class="modal fade" id="deleteChecklistModal" tabindex="-1" role="dialog" aria-labelledby="deleteChecklistModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteChecklistModalLabel">Confirm delete</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this checklist?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" id="deleteChecklistConfirm" class="btn btn-danger">Confirm</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
{% endblock %}


{% block helpdesk_js %}
<div id="checklist-alert" style="display:none">{% trans "If you want to update state of checklist tasks, please do a Follow-Up response and click on Update checklists" %}</div>
<script type='text/javascript' language='javascript'>
$( function() {
        try {
            if (!window.HELPDESK_DISABLE_LEGACY_DATEPICKER) {
                $( "#id_due_date" ).datepicker({dateFormat: 'yy-mm-dd'});
            }
        } catch (e) { /* ignore */ }
} );
</script>

<script type='text/javascript' language='javascript'>
  $(document).ready(function() {
      $("#ShowFurtherEditOptions").click(function() {
          $("#FurtherEditOptions").toggle();
      });

      $("#ShowChecklistEditOptions").click(function() {
          $("#checklistEdit").toggle();
      });

      $('#id_preset').change(function() {
          preset = $('#id_preset').val();
          if (preset != '') {
              $.get("{% url 'helpdesk:raw' 'preset' %}?id=" + preset, function(data) {
                  $("#commentBox").val(data)
              });
          }
      });

      // Preset name of checklist when a template is selected
    $('#id_checklist_template').on('change', function() {
      const nameField = $('#id_name')
      const selectedTemplate = $(this).children(':selected')
      if (selectedTemplate.val()) {
        // Template chosen: prefill name (if empty) and make it readonly
        if (nameField.val() === '') {
          nameField.val(selectedTemplate.text())
        }
        nameField.prop('readonly', true).addClass('readonly-template')
      } else {
        // No template selected: make name editable again
        nameField.prop('readonly', false).removeClass('readonly-template')
      }
    })

    {% if staff_only_view %}
    // Change default empty option text for staff users
    $('#id_checklist_template option:first').text('{% trans "Select Template" %}');
    // If page loaded with a template already selected, ensure name is readonly
    if ($('#id_checklist_template').val()) {
      const nameField = $('#id_name')
      if (!nameField.val()) {
        nameField.val($('#id_checklist_template').children(':selected').text())
      }
      nameField.prop('readonly', true).addClass('readonly-template')
    }
    {% endif %}

    {% if staff_only_view %}
    // Staff: disable Select button until a template is chosen
    $('#createChecklistModal .modal-footer button[type=submit]').prop('disabled', true);
    $('#id_checklist_template').on('change', function(){
      var has = !!$(this).val();
      $('#createChecklistModal .modal-footer button[type=submit]').prop('disabled', !has);
    });
    {% endif %}

    // JS flag for staff-only view
  var STAFF_ONLY_VIEW = {% if staff_only_view %}true{% else %}false{% endif %};

    // AJAX submit for staff 'Select' checklist modal
    $('#createChecklistModal form').on('submit', function(e) {
      if (!STAFF_ONLY_VIEW) return true; // non-staff use normal submit
      e.preventDefault();
      var $form = $(this);
      var url = "{% url 'helpdesk:create_checklist_ajax' ticket.id %}";
      var data = $form.serialize();
      // clear previous inline errors
      $form.find('.invalid-feedback').remove();
      $form.find('.is-invalid').removeClass('is-invalid');
      $.ajax({
        url: url,
        method: 'POST',
        data: data,
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        success: function(resp) {
          if (resp.success) {
            // Insert the new checklist card before the 'Select checklist' button column
            $('.col-sm-4.col-xs-12.ml-auto.d-flex.justify-content-end').before(resp.html);
              // hide the Select button for staff now that a checklist exists
              $('.col-sm-4.col-xs-12.ml-auto.d-flex.justify-content-end').find('button[data-target="#createChecklistModal"]').hide();
            // remove the selected option from dropdown so it cannot be reused
            var selectedVal = $('#id_checklist_template').val();
            if (selectedVal) {
              $('#id_checklist_template option[value="' + selectedVal + '"]').remove();
              $('#id_checklist_template').val('');
              $('#id_name').prop('readonly', false).removeClass('readonly-template').val('');
              // disable select button again until another template chosen
              $('#createChecklistModal .modal-footer button[type=submit]').prop('disabled', true);
            }
            $('#createChecklistModal').modal('hide');
          } else {
            alert('Failed to create checklist');
          }
        },
        error: function(xhr) {
          // Show validation errors inline in the modal form if JSON returned
          try {
            var json = JSON.parse(xhr.responseText);
            if (json && json.errors) {
              Object.keys(json.errors).forEach(function(field){
                var messages = json.errors[field];
                var $el = $('#id_' + field);
                if ($el.length) {
                  $el.addClass('is-invalid');
                  messages.forEach(function(msg){
                    $el.after('<div class="invalid-feedback">' + msg + '</div>');
                  });
                } else {
                  // fallback: alert first message
                  try { if (messages && messages.length) alert(messages[0]); } catch(_){ }
                }
              });
            }
          } catch (e) {
            // ignore parse errors
          }
          alert('Error creating checklist');
        }
      })
    })

    // Delegated handler so dynamically inserted checklist cards show the same alert
    $(document).on('click', '.disabledTask', function() {
      var el = document.getElementById('checklist-alert');
      var msg = (el && el.textContent) ? el.textContent.trim() : 'If you want to update state of checklist tasks, please do a Follow-Up response and click on Update checklists';
      alert(msg);
    });

    // Replace JS confirm with a Bootstrap modal. When a delete form (may be dynamically inserted)
    // is submitted, open the modal. If the form has data-ajax=true, perform AJAX delete and
    // update the UI to remove the card and re-add the template option.
    var $pendingDeleteForm = null;
    $(document).on('submit', '.delete-checklist-form', function(e) {
      e.preventDefault();
      $pendingDeleteForm = $(this);
      var msg = $pendingDeleteForm.data('confirm') || 'Are you sure you want to delete this checklist?';
      $('#deleteChecklistModal .modal-body').text(msg);
      $('#deleteChecklistModal').modal('show');
      return false;
    });

    // Confirm action in modal
    $(document).on('click', '#deleteChecklistConfirm', function(e) {
      if (!$pendingDeleteForm) return;
      var $form = $pendingDeleteForm;
      $('#deleteChecklistModal').modal('hide');
      // if form marked for AJAX, submit via AJAX
      if ($form.data('ajax')) {
        var action = $form.attr('action');
        var data = $form.serialize();
        $.post(action, data).done(function() {
          // remove the checklist card
          var $card = $form.closest('[data-checklist-id]');
          var templateId = $card.data('template-id');
          var templateName = $card.data('template-name');
          $card.remove();
          // if a template id/name present, re-add option to the template select
          if (templateId && templateName) {
            // only add if not already present
            if ($('#id_checklist_template option[value="' + templateId + '"]').length === 0) {
              // Prefer DOM Option API (works well with select2)
              try {
                var newOption = new Option(templateName, templateId, false, false);
                $('#id_checklist_template')[0].add(newOption);
              } catch (e) {
                // fallback to jQuery append
                $('#id_checklist_template').append($('<option>', {value: templateId, text: templateName}));
              }

              // If select2 is initialized, trigger change so it notices the new option
              try {
                if ($('#id_checklist_template').data('select2')) {
                  $('#id_checklist_template').trigger('change');
                }
              } catch (e) {}

              // If using bootstrap-select, refresh the picker
              try {
                if ($('#id_checklist_template').hasClass('selectpicker') && $('#id_checklist_template').selectpicker) {
                  $('#id_checklist_template').selectpicker('refresh');
                }
              } catch (e) {}
            }
          }
          // if no checklists left, show Select button again for staff
          if ($('[data-checklist-id]').length === 0) {
            var $selectBtn = $('.col-sm-4.col-xs-12.ml-auto.d-flex.justify-content-end');
            $selectBtn.find('button[data-target="#createChecklistModal"]').show();
          }
        }).fail(function() {
          alert('Failed to delete checklist');
        }).always(function() {
          $pendingDeleteForm = null;
        });
      } else {
        // fallback: normal submit
        $form.off('submit');
        $form.submit();
      }
    });

    // Attachment delete: use a dedicated modal (so we match checklist UX)
    // We'll reuse the same pattern: intercept delete form submit and show modal
    var $pendingAttachmentDeleteForm = null;
    // Insert delete attachment modal into page if not present
    if ($('#deleteAttachmentModal').length === 0) {
      $('body').append('\n<div class="modal fade" id="deleteAttachmentModal" tabindex="-1" role="dialog" aria-labelledby="deleteAttachmentModalLabel" aria-hidden="true">\n  <div class="modal-dialog modal-dialog-centered" role="document">\n    <div class="modal-content">\n      <div class="modal-header">\n        <h5 class="modal-title" id="deleteAttachmentModalLabel">Confirm delete</h5>\n        <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n          <span aria-hidden="true">&times;</span>\n        </button>\n      </div>\n      <div class="modal-body">Delete this attachment?</div>\n      <div class="modal-footer">\n        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>\n        <button type="button" id="deleteAttachmentConfirm" class="btn btn-danger">Confirm</button>\n      </div>\n    </div>\n  </div>\n</div>\n');
      // Ensure a global hidden delete form exists (so fallback confirm() branches are not needed)
      if ($('#followup-attachment-delete-form').length === 0) {
        // try to copy CSRF token from an existing input on the page
        var _csrf_val = '';
        var $csrf_input = $('input[name="csrfmiddlewaretoken"]').first();
        if ($csrf_input.length) _csrf_val = $csrf_input.val();
        // fallback: try cookie (if available)
        if (!_csrf_val) {
          function _getCookie(name){
            var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return v ? v.pop() : '';
          }
          _csrf_val = _getCookie('csrftoken');
        }
        var formHtml = '<form id="followup-attachment-delete-form" method="post" style="display:none;">'
                     + '<input type="hidden" name="csrfmiddlewaretoken" value="' + (_csrf_val||'') + '" />'
                     + '</form>';
        $('body').append(formHtml);
      }
      // Ensure the delete modal appears above any currently visible modal (fix stacking order)
      $('#deleteAttachmentModal').on('show.bs.modal', function(){
        try {
          // compute a z-index higher than any visible modal
          var base = 1050;
          $('.modal:visible').each(function(){
            var zi = parseInt($(this).css('z-index')) || base;
            if (zi >= base) base = zi + 2;
          });
          $(this).css('z-index', base);
          // adjust the most recent backdrop after it's created
          setTimeout(function(){
            var $backdrop = $('.modal-backdrop').not('.modal-stack-applied').last();
            if ($backdrop && $backdrop.length) {
              $backdrop.css('z-index', base - 1).addClass('modal-stack-applied');
            }
          }, 0);
        } catch (e) { console.warn('failed to adjust delete modal z-index', e); }
      });
    }

  // When any delete-attachment-btn is clicked, open the modal and remember the delete form/action
  $(document).on('click', '.delete-attachment-btn', function(e){
      e.preventDefault();
      var $btn = $(this);
      // if this button was created inside the modal, it likely has a data-delete-url
      var deleteUrl = $btn.data('delete-url');
      // We'll submit the main hidden form (#followup-attachment-delete-form) with this action
      $pendingAttachmentDeleteForm = $('#followup-attachment-delete-form');
      if ($pendingAttachmentDeleteForm.length === 0) {
        // fallback: if there is a form next to the button, use it
        $pendingAttachmentDeleteForm = $btn.closest('form');
      }
      if ($pendingAttachmentDeleteForm.length) {
        // store url on form for confirm handler
        $pendingAttachmentDeleteForm.data('delete-url', deleteUrl);
        $('#deleteAttachmentModal .modal-body').text('Delete this attachment?');
        $('#deleteAttachmentModal').modal('show');
      } else {
        // As fallback, navigate directly to delete URL (no browser confirm)
        if (deleteUrl) window.location = deleteUrl;
      }
    });

    // Confirm action for attachment delete
    $(document).on('click', '#deleteAttachmentConfirm', function(e){
      // Prefer the document-scoped pending form, otherwise fall back to a window-level one
      var $form = $pendingAttachmentDeleteForm || window._pendingAttachmentDeleteForm || $('#followup-attachment-delete-form');
      if (!$form || $form.length === 0) return;
      $('#deleteAttachmentModal').modal('hide');
      var delUrl = $form.data('delete-url');
      if (delUrl) {
        $form.attr('action', delUrl);
      }
      // submit normally
      $form.off('submit');
      $form.submit();
      // clear both references
      $pendingAttachmentDeleteForm = null;
      try { window._pendingAttachmentDeleteForm = null; } catch(e){}
    });

  // Pencil (edit) button behavior has been consolidated into the modal-local script

    // Helper to safely open a file input that may be display:none
    window._openHiddenFileInput = function(inputEl){
      try {
        var el = inputEl;
        var cs = window.getComputedStyle(el);
        var wasHidden = (cs && cs.display === 'none');
        var orig = {display: el.style.display || '', position: el.style.position || '', left: el.style.left || '', opacity: el.style.opacity || '', width: el.style.width || '', height: el.style.height || ''};
        if (wasHidden) {
          el.style.display = 'block';
          el.style.position = 'absolute';
          el.style.left = '-9999px';
          el.style.opacity = '0';
          el.style.width = '1px';
          el.style.height = '1px';
        }
        try { el.click(); } catch(e) { try { $(el).trigger('click'); } catch(e2){} }
        // restore after a short delay (selection will already be handled)
        setTimeout(function(){
          try {
            el.style.display = orig.display;
            el.style.position = orig.position;
            el.style.left = orig.left;
            el.style.opacity = orig.opacity;
            el.style.width = orig.width;
            el.style.height = orig.height;
          } catch(e){}
        }, 300);
      } catch(e) { try { $(inputEl).trigger('click'); } catch(_){} }
    };

    // Consolidated modal-local handlers for attachment edit/change/delete
    try {
      var $modalGlobal = $('#followupEditModal');
      // edit -> set replace id, show wrapper, click replacement label
      $modalGlobal.on('click', '.edit-attachment-btn', function(e){
        e.preventDefault();
        var id = $(this).data('attachment-id');
        $modalGlobal.find('#followup_replace_attachment_id').val(id);
        $modalGlobal.find('#followup_replace_file_wrap').show();
        var lbl = $modalGlobal.find('#followup_replacement_label');
        if (lbl && lbl.length) { try { lbl.get(0).click(); return; } catch(e) {} }
        var $file = $modalGlobal.find('#followup_replacement_file');
        if ($file.length) { try { $file.get(0).click(); } catch(e) { $file.trigger('click'); } }
      });

      // update filename label
      $modalGlobal.on('change', '#followup_replacement_file', function(){
        var input = $(this);
        var label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
        if (!label) label = '{% trans "No files selected." %}';
        $modalGlobal.find('#followup_replacement_filename').text(label);
      });

      // delete attachment -> open centralized confirm modal
      $modalGlobal.on('click', '.delete-attachment-btn', function(){
        var url = $(this).data('delete-url');
        try {
          window._pendingAttachmentDeleteForm = $('#followup-attachment-delete-form');
          window._pendingAttachmentDeleteForm.data('delete-url', url);
          $('#deleteAttachmentModal .modal-body').text('{% trans "Delete this attachment?" %}');
          $('#deleteAttachmentModal').modal('show');
        } catch(e) {
          var $form = $('#followup-attachment-delete-form'); if ($form.length) { $form.attr('action', url); $form.submit(); } else { if (url) window.location = url; }
        }
      });
    } catch(e) { /* ignore */ }

    // Robust helper: create a temporary visible file input, open chooser, then copy selected files
    // into the provided real input element (if possible). Calls optional callback with the files.
    window._openFileChooserAndCopy = function(realInputEl, cb) {
      try {
        // create a temporary input (not display:none) so most browsers will open chooser
        var temp = document.createElement('input');
        temp.type = 'file';
        // Allow multiple selection if the real input supports it
        try { if (realInputEl && realInputEl.multiple) temp.multiple = true; } catch(e){}
        // position offscreen but visible to layout (not display:none)
        temp.style.position = 'absolute';
        temp.style.left = '-9999px';
        temp.style.top = '0px';
        temp.style.opacity = '0';
        temp.style.width = '1px';
        temp.style.height = '1px';
        document.body.appendChild(temp);

        var cleanup = function(){ try { document.body.removeChild(temp); } catch(e){} };

        temp.addEventListener('change', function _tempChange(ev){
          try {
            var files = temp.files;
            if (files && files.length) {
              var assigned = false;
              // Try DataTransfer assignment to real input
              if (realInputEl) {
                try {
                  var dt = new DataTransfer();
                  for (var i=0;i<files.length;i++) dt.items.add(files[i]);
                  realInputEl.files = dt.files;
                  assigned = true;
                } catch(eAssign) {
                  assigned = false;
                }
              }

              // If assignment failed, move the temp input into the real input's form so the file will be submitted
              if (!assigned && realInputEl) {
                try {
                  // find the closest form of the real input (modal form)
                  var form = realInputEl.form || (function(el){ var p=el; while(p && p.nodeName.toLowerCase()!=='form') p=p.parentNode; return p; })(realInputEl);
                  if (form) {
                    // ensure temp has the same name as the real input so server receives it
                    try { temp.name = realInputEl.name || temp.name; } catch(_){}
                    // disable the real input so server only gets the temp file
                    try { realInputEl.disabled = true; } catch(_){}
                    // give the temp a related id and store real id for cleanup
                    try { temp.id = (realInputEl.id || realInputEl.name || 'followup_replacement') + '_tmp'; } catch(_){}
                    window._tempReplacementRealInputId = realInputEl.id || realInputEl.name || null;
                    // move temp into the form so it will be uploaded
                    form.appendChild(temp);
                    // store reference to temp so cleanup can find it
                    window._tempReplacementInput = temp;
                    // wire a change handler to update filename label in modal if present
                    try {
                      temp.addEventListener('change', function(){
                        try {
                          var labelEl = document.querySelector('#followupEditModal #followup_replacement_filename') || document.getElementById('followup_replacement_filename');
                          var label = temp.files && temp.files.length ? temp.files[0].name : '';
                          if (labelEl) labelEl.textContent = label || '{% trans "No files selected." %}';
                        } catch(e){ }
                      });
                    } catch(e){}
                    assigned = true; // consider as handled
                  } else {
                    // fallback: keep files in global store
                    window._lastPickedFiles = files;
                  }
                } catch(eMove) {
                  window._lastPickedFiles = files;
                }
              }

              // Trigger change on the real input so UI updates if assignment succeeded
              try { if (realInputEl) realInputEl.dispatchEvent(new Event('change', {bubbles:true})); } catch(e) { try { $(realInputEl).trigger('change'); } catch(_){} }
            }

            if (cb) try { cb(files); } catch(_){ }
          } finally {
            // If we moved the temp into the form, don't remove it here; wait for modal hide or form submit to cleanup.
            if (!window._tempReplacementInput || window._tempReplacementInput !== temp) {
              setTimeout(cleanup, 200);
            }
          }
        }, {once:true});

        // opening the chooser
        try { temp.click(); } catch(eClick) {
          // worst-case use the old fallback
          try { if (realInputEl) realInputEl.click(); } catch(e2) { try { $(realInputEl).trigger('click'); } catch(_){} }
        }
      } catch(e) {
        // last fallback: try clicking the real input directly
        try { if (realInputEl) realInputEl.click(); } catch(e2) { try { $(realInputEl).trigger('click'); } catch(_){} }
      }
    };

    // Ensure the followup replacement wrapper exists inside the modal. Safe to call multiple times.
    window._ensureReplacementWrapper = function(){
      try {
        var $m = $('#followupEditModal');
        if ($m.length === 0) return false;
        if ($m.find('#followup_replace_file_wrap').length) return true;
  var $replaceWrap = $('<div>', {id: 'followup_replace_file_wrap', style: 'display:none;'});
  var $label = $('<label>', {class: 'btn btn-primary btn-sm btn-file followup-replacement-trigger', id: 'followup_replacement_label'});
  $label.append('{% trans "Choose replacement file" %} ');
  $label.append($('<input>', {type: 'file', name: 'replacement_attachment', id: 'followup_replacement_file', style: 'display:none;'}));
        $replaceWrap.append($label);
        $replaceWrap.append($('<span>', {class: 'ml-2', id: 'followup_replacement_filename'}).text('{% trans "No files selected." %}'));
        $replaceWrap.append($('<input>', {type: 'hidden', name: 'replace_attachment_id', id: 'followup_replace_attachment_id', value: ''}));
  var $formTargetEnsure = $m.find('form').first();
  if ($formTargetEnsure.length) { $formTargetEnsure.append($replaceWrap); } else { $m.find('.modal-body').append($replaceWrap); }
        return true;
      } catch(e) { console.warn('ensureReplacementWrapper error', e); return false; }
    };

    // Fetch and display followup edit form in a modal via AJAX when clicking the edit button.
    // Only trigger for the edit action (icons with fa-edit). Delete links (fa-trash) will behave normally.
    $(document).on('click', 'a.followup-edit', function(e){
      var $a = $(this);
      // If this is not the edit button (no edit icon), let it proceed (e.g., delete)
      if ($a.find('i.fa-edit').length === 0) {
        return true;
      }
      e.preventDefault();
      var url = $a.attr('href');
      // Request the modal HTML from the server (view returns JSON {html: ...} for AJAX GET)
      $.ajax({
        url: url,
        method: 'GET',
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        success: function(resp){
          if (resp && resp.html) {
            // Remove any existing modal to avoid duplicates
            $('#followupEditModal').remove();
            // Parse the returned HTML into a temporary container so we can extract the modal element
            try {
              var $tmp = $('<div>').html(resp.html);
              var $modalEl = $tmp.find('#followupEditModal');
              if ($modalEl.length) {
                // Append the modal element itself (not the whole HTML string)
                $('body').append($modalEl);
                // Ensure the modal contains the replacement file wrapper so file chooser can be triggered
                try {
                  var $m = $('#followupEditModal');
                    if ($m.length && $m.find('#followup_replace_file_wrap').length === 0) {
                    var $replaceWrap = $('<div>', {id: 'followup_replace_file_wrap', style: 'display:none;'});
                    var $label = $('<label>', {class: 'btn btn-primary btn-sm btn-file'});
                    $label.append('{% trans "Choose replacement file" %} ');
                    $label.append($('<input>', {type: 'file', name: 'replacement_attachment', id: 'followup_replacement_file', style: 'display:none;'}));
                    $replaceWrap.append($label);
                    $replaceWrap.append($('<span>', {class: 'ml-2', id: 'followup_replacement_filename'}).text('{% trans "No files selected." %}'));
                    $replaceWrap.append($('<input>', {type: 'hidden', name: 'replace_attachment_id', id: 'followup_replace_attachment_id', value: ''}));
                    // Prefer appending into the modal's form so the input is inside the form and will be uploaded
                    var $formTarget = $m.find('form').first();
                    if ($formTarget.length) { $formTarget.append($replaceWrap); } else { $m.find('.modal-body').append($replaceWrap); }
                  }
                } catch(e) { console.warn('failed to ensure replacement wrapper on appended modal', e); }
                // Execute any inline scripts that live inside the modal (after it's in the DOM)
                $modalEl.find('script').each(function(){
                  try { $.globalEval($(this).text()); } catch(e) { console.warn('eval modal script failed', e); }
                });
                console.log('Appended modal element and executed inline scripts.');
              } else {
                // fallback: append raw HTML
                $('body').append(resp.html);
                // attempt to execute scripts from the raw HTML
                try { $tmp.find('script').each(function(){ $.globalEval($(this).text()); }); } catch(e){}
              }
            } catch (e) {
              console.warn('Failed to parse modal HTML, appending raw HTML', e);
              $('body').append(resp.html);
            }

            // Show the modal (now appended)
            $('#followupEditModal').modal('show');

            // Ensure replacement wrapper is present (covers raw-html and other branches)
            try {
              (function ensureReplacementWrapper(){
                try {
                  var $mchk = $('#followupEditModal');
                  if ($mchk.length && $mchk.find('#followup_replace_file_wrap').length === 0) {
                    var $replaceWrap = $('<div>', {id: 'followup_replace_file_wrap', style: 'display:none;'});
                    var $label = $('<label>', {class: 'btn btn-primary btn-sm btn-file'});
                    $label.append('{% trans "Choose replacement file" %} ');
                    $label.append($('<input>', {type: 'file', name: 'replacement_attachment', id: 'followup_replacement_file', style: 'display:none;'}));
                    $replaceWrap.append($label);
                    $replaceWrap.append($('<span>', {class: 'ml-2', id: 'followup_replacement_filename'}).text('{% trans "No files selected." %}'));
                    $replaceWrap.append($('<input>', {type: 'hidden', name: 'replace_attachment_id', id: 'followup_replace_attachment_id', value: ''}));
                    var $formTargetChk = $mchk.find('form').first();
                    if ($formTargetChk.length) { $formTargetChk.append($replaceWrap); } else { $mchk.find('.modal-body').append($replaceWrap); }
                  }
                } catch(e) { console.warn('ensureReplacementWrapper inner failed', e); }
              })();
            } catch(e) { console.warn('ensureReplacementWrapper failed', e); }

            // Fetch attachments fragment via AJAX and inject it (works even if inline scripts didn't run)
            try {
              var followupId = $('#followupEditModal').data('followup-id');
              if (followupId) {
        var attachUrl = '/tickets/{{ ticket.id }}/followup_attachments_fragment/' + followupId + '/';
        $.ajax({url: attachUrl, method: 'GET', headers: {'X-Requested-With': 'XMLHttpRequest'}}).done(function(aresp){
                  if (aresp && aresp.html) {
                    // only inject if modal lacks attachments
                    var $existing = $('#followupEditModal .existing-attachments');
                    if ($existing.length === 0 || $existing.children().length === 0) {
                      // Use attachments JSON endpoint to build DOM reliably
                      var jsonUrl = '/tickets/{{ ticket.id }}/followup_attachments_json/' + followupId + '/';
                      $.getJSON(jsonUrl).done(function(jresp){
                        if (jresp && jresp.attachments && jresp.attachments.length) {
                          var $wrap = $('<div class="mt-3 followup-attachments-fragment" />');
                          $wrap.append('<label class="font-weight-600">Attachments (this follow-up)</label>');
                          var $list = $('<div class="existing-attachments mb-2" />');
                          // Dedupe attachments already present in modal
                          jresp.attachments.forEach(function(att){
                            try {
                              if ($('#followupEditModal').find('[data-attachment-id="'+att.id+'"]').length) return;
                            } catch(e) {}
                            var $row = $("<div class=\"d-flex align-items-center mb-1 justify-content-between\"></div>");
                            var left = $('<div />');
                            left.append($('<a/>',{href: att.url, text: att.filename}));
                            left.append(' ');
                            left.append($('<small class="text-muted"/>').text('(' + (att.mime_type||'') + ', ' + (att.size||'0') + ')'));
                            var right = $('<div class="d-flex align-items-center" />');
                            right.append($('<button type="button" class="edit-attachment-btn btn btn-sm ml-2" style="background:#ffd84d;border:none;color:#1f1f1f;border-radius:6px;padding:6px 8px;"/>').data('attachment-id', att.id).append($('<i class="fas fa-pencil-alt"></i>')));
                            if (att.delete_url) {
                              right.append($('<button type="button" class="delete-attachment-btn btn btn-sm btn-danger ml-2"/>').data('delete-url', att.delete_url).append($('<i class="fas fa-trash"></i>')));
                            }
                            $row.append(left).append(right);
                            $list.append($row);
                          });
                          $wrap.append($list);
                          // Ensure the modal contains the replacement file wrapper (hidden input + filename + hidden id)
                          try {
                            if ($('#followupEditModal #followup_replace_file_wrap').length === 0) {
                              var $replaceWrap = $('<div>', {id: 'followup_replace_file_wrap', style: 'display:none;'});
                              var $label = $('<label>', {class: 'btn btn-primary btn-sm btn-file'});
                              // Add translation text and the hidden file input
                              $label.append('{% trans "Choose replacement file" %} ');
                              $label.append($('<input>', {type: 'file', name: 'replacement_attachment', id: 'followup_replacement_file', style: 'display:none;'}));
                              $replaceWrap.append($label);
                              $replaceWrap.append($('<span>', {class: 'ml-2', id: 'followup_replacement_filename'}).text('{% trans "No files selected." %}'));
                              $replaceWrap.append($('<input>', {type: 'hidden', name: 'replace_attachment_id', id: 'followup_replace_attachment_id', value: ''}));
                              $wrap.append($replaceWrap);
                            }
                          } catch(e) { console.warn('failed appending replacement file wrapper', e); }
                          var $formTargetWrap = $('#followupEditModal').find('form').first();
                          if ($formTargetWrap.length) { $formTargetWrap.append($wrap); } else { $('#followupEditModal .modal-body').append($wrap); }
                          console.log('Built and appended attachments DOM via JSON endpoint.');
                        } else {
                          console.log('No attachments via JSON endpoint');
                        }
                      }).fail(function(){ console.warn('attachments json fetch failed'); });
                    }
                    // Rebind handlers to the newly injected content (click replacement label first)
                    $('#followupEditModal').find('.edit-attachment-btn').off('click').on('click', function(){
                      var id = $(this).data('attachment-id');
                      var $m = $('#followupEditModal');
                      $m.find('#followup_replace_attachment_id').val(id);
                      $m.find('#followup_replace_file_wrap').show();
                      try { if (window._ensureReplacementWrapper) window._ensureReplacementWrapper(); } catch(e) {}
                      var lbl = $m.find('#followup_replacement_label');
                      if (lbl && lbl.length) { try { lbl.get(0).click(); return; } catch(e) {} }
                      var inputEl = $m.find('#followup_replacement_file').get(0);
                      if (inputEl) try { inputEl.click(); } catch(e) { $m.find('#followup_replacement_file').trigger('click'); }
                    });
                    $('#followupEditModal').find('.delete-attachment-btn').off('click').on('click', function(){
                      var url = $(this).data('delete-url');
                      try {
                        window._pendingAttachmentDeleteForm = $('#followup-attachment-delete-form');
                        window._pendingAttachmentDeleteForm.data('delete-url', url);
                        $('#deleteAttachmentModal .modal-body').text('Delete this attachment?');
                        $('#deleteAttachmentModal').modal('show');
                      } catch(e) {
                        // fallback: direct submit
                        var $form = $('#followup-attachment-delete-form');
                        if ($form.length) {
                          $form.attr('action', url);
                          $form.submit();
                        } else {
                          // fallback: navigate directly
                          if (url) window.location = url;
                        }
                      }
                    });
                  }
                }).fail(function(){ console.warn('Failed to fetch followup attachments fragment'); });
              }
            } catch (e) { console.warn('attachments fragment injection failed', e); }
            // Debug: log whether attachments markup exists inside the modal and fallback highlight if missing
            try {
              var $existing = $('#followupEditModal .existing-attachments');
              console.log('followup modal appended, existing-attachments elements:', $existing.length, 'children:', $existing.children().length);
              if ($existing.length === 0 || $existing.children().length === 0) {
                console.warn('No attachments found in modal markup. Trying to inject attachments_html from response if present.');
                // Prefer injecting a full modal form HTML if available (ensures hidden delete form)
                if (resp.modal_form_html) {
                  try {
                    $('#followupEditModal .modal-body').html(resp.modal_form_html);
                    console.log('Replaced modal body with modal_form_html.');
                    $existing = $('#followupEditModal .existing-attachments');
                    console.log('after replace, existing-attachments elements:', $existing.length, 'children:', $existing.children().length);
                    // If still no attachments present, try appending attachments_html if provided
                    if (($existing.length === 0 || $existing.children().length === 0) && resp.attachments_html) {
                      try {
                        var $formTargetAfter = $('#followupEditModal').find('form').first();
                        if ($formTargetAfter.length) { $formTargetAfter.append(resp.attachments_html); } else { $('#followupEditModal .modal-body').append(resp.attachments_html); }
                        console.log('Appended attachments_html after modal_form_html replace (prefer form).');
                        $existing = $('#followupEditModal .existing-attachments');
                        console.log('after append, existing-attachments elements:', $existing.length, 'children:', $existing.children().length);
                      } catch (e) { console.warn('failed appending attachments_html after modal_form_html', e); }
                    }
                  } catch(e) { console.warn('failed replacing modal body with modal_form_html', e); }
                } else if (resp.attachments_html) {
                  try {
                    var $formTargetInject = $('#followupEditModal').find('form').first();
                    if ($formTargetInject.length) { $formTargetInject.append(resp.attachments_html); } else { $('#followupEditModal .modal-body').append(resp.attachments_html); }
                    console.log('Injected attachments_html into modal (prefer form).');
                    // re-query for existing-attachments
                    $existing = $('#followupEditModal .existing-attachments');
                    console.log('after inject, existing-attachments elements:', $existing.length, 'children:', $existing.children().length);
                  } catch(e) { console.warn('failed injecting attachments_html', e); }
                } else {
                  // add a temporary yellow border to help visually spot where modal content is
                  $('#followupEditModal .modal-body').css({'border': '3px dashed #ffd84d'});
                  // also dump a short preview of resp.html to console (trimmed)
                  try { console.log('resp.html preview:', resp.html ? resp.html.substr(0, 1000) : ''); } catch(e){}
                }
              }
            } catch (e) { /* ignore */ }

            // When modal is hidden, remove it from DOM so repeated opens are clean
            $('#followupEditModal').on('hidden.bs.modal', function(){
              // cleanup any temp replacement input that was moved into the form
              try {
                if (window._tempReplacementInput) { try { window._tempReplacementInput.parentNode.removeChild(window._tempReplacementInput); } catch(e){}; window._tempReplacementInput = null; }
              } catch(e){}
              $(this).remove();
            });

            // When modal is shown, ensure replacement wrapper exists (no global fallbacks)
            $('#followupEditModal').on('shown.bs.modal', function(){
              try { if (window._ensureReplacementWrapper) window._ensureReplacementWrapper(); } catch(e){}
            });

            // Cleanup temp replacement input on form submit as well (if present)
            $(document).on('submit', '#followupEditModal form', function(e){
              e.preventDefault();
              try {
                var formEl = this;
                var $formEl = $(formEl);
                var fd = new FormData(formEl);

                // If FormData lacks replacement_attachment files, try to supply them from temp or lastPickedFiles
                try {
                  var hasReplacement = false;
                  try { hasReplacement = fd.get('replacement_attachment') !== null; } catch(_) { hasReplacement = false; }
                  if (!hasReplacement) {
                    if (window._tempReplacementInput && window._tempReplacementInput.files && window._tempReplacementInput.files.length) {
                      for (var i=0;i<window._tempReplacementInput.files.length;i++) {
                        fd.append('replacement_attachment', window._tempReplacementInput.files[i]);
                      }
                    } else if (window._lastPickedFiles && window._lastPickedFiles.length) {
                      for (var j=0;j<window._lastPickedFiles.length;j++) fd.append('replacement_attachment', window._lastPickedFiles[j]);
                    }
                  }
                } catch(eFiles) { console.warn('followupEdit append files to FormData failed', eFiles); }

                // Ensure replace_attachment_id is present
                try {
                  if (!fd.get('replace_attachment_id')) {
                    var ridFallback = $('#followupEditModal').find('#followup_replace_attachment_id').val() || $('#followup_replace_attachment_id').val();
                    if (ridFallback) fd.append('replace_attachment_id', ridFallback);
                  }
                } catch(eRid) { console.warn('followupEdit ensure rid into FormData failed', eRid); }

                // Include CSRF token header if available inside the form
                var actionUrl = formEl.getAttribute('action') || window.location.href;
                // Send via AJAX so we can guarantee files go through
                $.ajax({
                  url: actionUrl,
                  method: 'POST',
                  data: fd,
                  processData: false,
                  contentType: false,
                  headers: {'X-Requested-With': 'XMLHttpRequest'},
                  success: function(resp) {
                    // On success, reload the page to reflect the update
                    try { window.location.reload(true); } catch(e) { window.location.reload(); }
                  },
                  error: function(xhr, status, err) {
                    console.error('followupEdit AJAX submit failed', status, err);
                    alert('Failed to submit followup edit. See console for details.');
                  }
                });
              } catch(eAll) { console.warn('followupEdit AJAX submit handler error', eAll); }
              return false;
            });

      // Bind delegated handlers for attachment buttons inside the modal (in case JS from include isn't executed)
      $(document).off('click', '#followupEditModal .edit-attachment-btn').on('click', '#followupEditModal .edit-attachment-btn', function(e){
        e.preventDefault();
        var $m = $('#followupEditModal');
        var id = $(this).data('attachment-id');
        $m.find('#followup_replace_attachment_id').val(id);
        $m.find('#followup_replace_file_wrap').show();
        try { if (window._ensureReplacementWrapper) window._ensureReplacementWrapper(); } catch(e) {}
        var lbl = $m.find('#followup_replacement_label');
        if (lbl && lbl.length) {
          try { lbl.get(0).click(); return; } catch(e) {}
        }
        var $file = $m.find('#followup_replacement_file');
        if ($file.length) {
          var inputEl = $file.get(0);
          try { inputEl.click(); } catch(e) { $file.trigger('click'); }
        }
      });
      // When a replacement file is selected inside the modal, update the filename label
      $(document).off('change', '#followupEditModal #followup_replacement_file').on('change', '#followupEditModal #followup_replacement_file', function(){
        var input = $(this);
        var label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
        if (!label) label = 'No files selected.';
        $('#followupEditModal').find('#followup_replacement_filename').text(label);
      });
      // Test chooser button (delegated) - useful for debugging in various browsers
      $(document).off('click', '#followupEditModal #test_followup_chooser').on('click', '#followupEditModal #test_followup_chooser', function(e){
        e.preventDefault();
        var $m = $('#followupEditModal');
        var inputEl = $m.find('#followup_replacement_file').get(0);
        if (!inputEl) return console.error('No replacement input found in modal');
        if (window._openFileChooserAndCopy) {
          window._openFileChooserAndCopy(inputEl, function(files){ console.log('test chooser callback files:', files ? files.length : 0); });
        } else if (window._openHiddenFileInput) {
          window._openHiddenFileInput(inputEl);
        } else {
          try { inputEl.click(); } catch(e) { $(inputEl).trigger('click'); }
        }
      });
      $(document).off('click', '#followupEditModal .delete-attachment-btn').on('click', '#followupEditModal .delete-attachment-btn', function(e){
        e.preventDefault();
        var url = $(this).data('delete-url');
        try {
          // prefer window-level pending form (set by modal-local handler) so confirm modal works
          window._pendingAttachmentDeleteForm = $('#followup-attachment-delete-form');
          window._pendingAttachmentDeleteForm.data('delete-url', url);
          $('#deleteAttachmentModal .modal-body').text('Delete this attachment?');
          $('#deleteAttachmentModal').modal('show');
        } catch (err) {
          var $form = $('#followup-attachment-delete-form');
          if ($form.length) {
            $form.attr('action', url);
            $form.submit();
          } else {
            // ultimate fallback: navigate directly
            if (url) window.location = url;
          }
        }
      });

            // Let the form submit normally (full POST -> redirect). If you want AJAX submit
            // we can change the view to return JSON on POST and wire up an AJAX submit here.
          } else {
            alert('Failed to load edit form');
          }
        },
        error: function() {
          alert('Failed to load edit form');
        }
      });
      return false;
    });

      $("[data-toggle=tooltip]").tooltip();

      {% if helpdesk_settings.HELPDESK_ENABLE_ATTACHMENTS %}
      $("#ShowFileUpload").click(function() {
          $("#FileUpload").fadeIn();
          $("#ShowFileUploadPara").hide();
      });

      // lists for file input change events, then updates the associated text label
      // with the file name selected
      $('.add_file_fields_wrap').on('fileselect', ':file', function(event, numFiles, label, browseButtonNum) {
          $("#selectedfilename"+browseButtonNum).html(label);
      });

      var x = 0;
      var wrapper         = $(".add_file_fields_wrap"); //Fields wrapper
      var add_button      = $(".add_file_field_button"); //Add button ID

      $(add_button).click(function(e){ //on add input button click
          x++;
          e.preventDefault();
          $(wrapper).append("<div><label class='btn btn-primary btn-sm btn-file'>Browse... <input type='file' name='attachment' id='file" + x + "' multiple style='display: none;'/></label><span>&nbsp;</span><span id='selectedfilename" + x + "'>{% trans 'No files selected.' %}</span></div>"); //add input box
      });
      {% endif %}
  });

  {% if helpdesk_settings.HELPDESK_ENABLE_ATTACHMENTS %}
  // this function listens for changes on any file input, and
  // emits the appropriate event to update the input's text.
  // Needed to have properly styled file input buttons! (this really shouldn't be this hard...)
  $(document).on('change', ':file', function() {
      var input = $(this),
          inputWidgetNum = $(this).attr('id').split("file")[1],
          numFiles = input.get(0).files ? input.get(0).files.length : 1,
          label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
      input.trigger('fileselect', [numFiles, label, inputWidgetNum]);
  });
  {% endif %}
  </script>
{% endblock %}
