{% extends "helpdesk/base.html" %}
{% load i18n %}

{% block helpdesk_title %}Service Level Agreement{% endblock %}

{% block helpdesk_head %}
<style>
    .sla-container { max-width:980px; margin:18px auto; background:#fff; border-radius:12px; padding:18px; border:1px solid rgba(15,23,42,0.06); }
    .sla-hero { display:flex; gap:18px; align-items:flex-start; }
    .sla-basics { flex:1; }
    .sla-policy { flex:1; }
    .sla-policy table { width:100%; border-collapse:collapse; }
    .sla-policy th, .sla-policy td { padding:8px 10px; border-bottom:1px solid rgba(15,23,42,0.06); text-align:left; }
    .sla-policy th { background:transparent; font-weight:700; }
    .status-chip { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; font-weight:600; }
    .status-chip.green { background:#e6f6ee; color:#0b7a3a; }
    .status-chip.yellow { background:#fff8e6; color:#a66b00; }
    .status-chip.red { background:#fff4f4; color:#a61a1a; }
    .sla-ticket-list { margin-top:16px; }
        .sla-ticket { display:flex; justify-content:space-between; gap:12px; padding:10px; border-radius:8px; border:1px solid rgba(15,23,42,0.04); margin-bottom:8px; }
        /* priority color indicators for table rows */
        .priority-1 { border-left:6px solid #d9534f; }
        .priority-2 { border-left:6px solid #f0ad4e; }
        .priority-3 { border-left:6px solid #ffc107; }
        .priority-4, .priority-5 { border-left:6px solid #0b7a3a; }
    .sla-ticket .left { display:flex; gap:12px; align-items:center; }
    .sla-ticket .meta { color:#6c7783; font-size:.95rem; }
</style>
{% endblock %}

{% block helpdesk_breadcrumb %}
<li class="breadcrumb-item active">{% trans "Service Level Agreement" %}</li>
{% endblock %}

{% block helpdesk_body %}
<div class="sla-container">
    <div class="sla-hero">
        <div class="sla-basics">
            <h2>{% trans "SLA Basics" %}</h2>
            <p><strong>{% trans "Response Time" %}</strong> ‚Äî {% trans "How fast you must acknowledge a ticket." %}</p>
            <p><strong>{% trans "Resolution Time" %}</strong> ‚Äî {% trans "How fast you must resolve it." %}</p>
            <p><strong>{% trans "Escalation" %}</strong> ‚Äî {% trans "What happens if SLA is breached." %}</p>

            <h3 style="margin-top:12px;">{% trans "Responsibilities for Staff" %}</h3>
            <ul>
                <li>{% trans "Work on My Assigned Tickets only." %}</li>
                <li>{% trans "Update ticket status regularly." %}</li>
                <li>{% trans "Escalate or request help if nearing SLA breach." %}</li>
            </ul>

            <h3 style="margin-top:12px;">{% trans "Notifications" %}</h3>
            <ul>
                <li>{% trans "Alerts before SLA breach." %}</li>
                <li>{% trans "Notification if ticket is reassigned." %}</li>
            </ul>
        </div>

        <div class="sla-policy">
            <h2>{% trans "SLA Policy" %}</h2>
            <table aria-describedby="sla-policy-desc">
                <thead>
                    <tr>
                        <th>{% trans "Priority" %}</th>
                        <th>{% trans "Response Time" %}</th>
                        <th>{% trans "Resolution Time" %}</th>
                        <th>{% trans "Escalation" %}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>üî¥ {% trans "Critical" %}</td>
                        <td>15 min</td>
                        <td>4 hrs</td>
                        <td>{% trans "Escalates to Admin" %}</td>
                    </tr>
                    <tr>
                        <td>üü† {% trans "High" %}</td>
                        <td>30 min</td>
                        <td>8 hrs</td>
                        <td>{% trans "Escalates after 2 hrs" %}</td>
                    </tr>
                    <tr>
                        <td>üü° {% trans "Medium" %}</td>
                        <td>2 hrs</td>
                        <td>24 hrs</td>
                        <td>{% trans "Escalates after 6 hrs" %}</td>
                    </tr>
                    <tr>
                        <td>üü¢ {% trans "Low" %}</td>
                        <td>4 hrs</td>
                        <td>3 days</td>
                        <td>{% trans "Escalates after 1 day" %}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <h3 style="margin-top:18px;">{% trans "Ticket SLA Status" %}</h3>
        <div class="sla-ticket-list">
            <table id="slaTicketTable" class="table" style="width:100%; border-collapse:collapse">
                <thead>
                    <tr>
                        <th style="text-align:left">{% trans "Ticket" %}</th>
                        <th>{% trans "Assigned To" %}</th>
                        <th>{% trans "Priority" %}</th>
                        <th>{% trans "SLA Status" %}</th>
                        <th>{% trans "Time to Respond" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tickets %}
                    {% comment %} Map priority to colors: 1- Critical (red), 2-High (orange), 3-Medium (yellow), 4-5 Low (green) {% endcomment %}
                            <tr class="priority-{{ t.priority }}">
                                            <td>
                                                            {% if t.kbitem and t.kbitem.category and t.kbitem.category.slug %}
                                                                <strong><a href="{% url 'helpdesk:view' t.pk %}">{{ t.kbitem.category.slug }}</a></strong>
                                                                ‚Äî
                                                            {% endif %}
                                                            <a href="{% url 'helpdesk:view' t.pk %}">{{ t.title|default:'' }}</a>
                                            </td>
                        <td>
                            {% if t.assigned_to %}
                                {{ t.assigned_to.get_full_name|default:t.assigned_to.username }}
                            {% else %}
                                {% trans "Unassigned" %}
                            {% endif %}
                        </td>
                        <td>{{ t.get_priority_display }}</td>
                        <td>
                            {# Placeholder status - server-side logic needed to determine real status #}
                            <span class="status-chip {% if t.priority == 1 %}red{% elif t.priority == 2 %}yellow{% elif t.priority == 3 %}yellow{% else %}green{% endif %}">
                                {% if t.priority == 1 %}‚ùå {% trans "Breached" %}{% elif t.priority == 2 %}‚ö†Ô∏è {% trans "At risk" %}{% else %}‚úÖ {% trans "On track" %}{% endif %}
                            </span>
                        </td>
                        <td class="meta">{% trans "--" %}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4">{% trans "No tickets assigned to you." %}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="entriesControls" class="d-flex justify-content-between align-items-center mt-3"></div>
            <!-- Persistent controls so we can always control paging even if DataTables omits its controls -->
            <div id="slaControlsBar" class="d-flex justify-content-between align-items-center mt-2" style="gap:12px;">
                <div class="d-flex align-items-center" id="slaControlsLeft">
                    <label for="slaPageSizeInput" style="margin-right:8px; white-space:nowrap;">{% trans "Show" %}</label>
                    <input id="slaPageSizeInput" type="number" min="1" step="1" value="10" class="form-control form-control-sm d-inline-block" style="width:80px;" />
                    <div id="slaInfoText" class="ml-3 text-muted small" style="margin-left:12px;"></div>
                </div>
                <div id="slaPaginatePlaceholder"></div>
            </div>
        </div>
</div>

<script>
(function(){
    if (typeof $ === 'undefined') return;
    var attempts = 0, maxAttempts = 20;
    var tryInit = function(){
        attempts++;
        if(!$.fn || !$.fn.DataTable){
            if(attempts < maxAttempts){
                return setTimeout(tryInit, 150);
            }
            console.warn('DataTables not available to initialize SLA table');
            return;
        }
        $(function(){
            var slaTable = $('#slaTicketTable').DataTable({
                language: { "emptyTable": "{% trans 'No Tickets Match Your Selection' %}" },
                paging: true,
                pageLength: 10,
                lengthChange: true,
                info: true,
                dom: 'ltBp',
                buttons: [],
                order: [],
                initComplete: function(settings, json){
                    try {
                        var container = $('#entriesControls');
                        if(!container.length) return;
                        if(!container.find('.entries-left').length){
                            container.html('<div class="entries-left d-flex align-items-center"></div><div class="entries-right"></div>');
                        }
                        var left = container.find('.entries-left');
                        var right = container.find('.entries-right');
                        // Move length control and info to left, pagination to right
                        $('.dataTables_length').appendTo(left);
                        $('.dataTables_info').appendTo(left).addClass('ml-2 text-muted small');
                        $('.dataTables_paginate').appendTo(right);
                        // Replace the length <select> with a numeric input so users can type a custom page size
                        try {
                            var lengthSelect = left.find('.dataTables_length select');
                            if(lengthSelect.length) {
                                var current = parseInt(lengthSelect.val(), 10) || slaTable.page.len();
                                var input = $('<input/>', {
                                    type: 'number',
                                    min: 1,
                                    step: 1,
                                    value: current,
                                    class: 'form-control form-control-sm d-inline-block',
                                    style: 'width:80px; margin-left:8px;'
                                });
                                lengthSelect.replaceWith(input);
                                input.on('change', function() {
                                    var v = parseInt($(this).val(), 10);
                                    if (isNaN(v) || v < 1) v = slaTable.page.len();
                                    slaTable.page.len(v);
                                    slaTable.page(0).draw(false);
                                    setTimeout(function(){
                                        var info = slaTable.page.info();
                                        $('#slaInfoText').text('{% trans "Showing" %} ' + (info.start+1) + ' {% trans "to" %} ' + info.end + ' {% trans "of" %} ' + info.recordsTotal + ' {% trans "entries" %}');
                                    }, 50);
                                });
                            } else {
                                // Fallback: if DataTables didn't create the length control (e.g. rows <= pageLength), create a simple numeric control
                                if(!left.find('.dataTables_length').length){
                                    var current = slaTable.page.len();
                                    var input = $('<input/>', {
                                        type: 'number',
                                        min: 1,
                                        step: 1,
                                        value: current,
                                        class: 'form-control form-control-sm d-inline-block',
                                        style: 'width:80px; margin-left:8px;'
                                    });
                                    var lengthWrapper = $('<div class="dataTables_length"><label>{% trans "Show" %} </label></div>');
                                    lengthWrapper.find('label').append(input);
                                    left.prepend(lengthWrapper);
                                    input.on('change', function() {
                                        var v = parseInt($(this).val(), 10);
                                        if (isNaN(v) || v < 1) v = slaTable.page.len();
                                        slaTable.page.len(v).draw(false);
                                    });
                                }
                            }
                        } catch (e) {
                            console.warn('Could not replace length select', e);
                        }
                    } catch (e) {
                        console.warn('Could not relocate DataTables controls', e);
                    }
                },
                drawCallback: function(settings){
                    var container = $('#entriesControls');
                    if(!container.length) return;
                    var left = container.find('.entries-left');
                    var right = container.find('.entries-right');
                    $('.dataTables_length').appendTo(left);
                    $('.dataTables_info').appendTo(left);
                    $('.dataTables_paginate').appendTo(right);
                    try {
                        var lengthSelect = left.find('.dataTables_length select');
                        if(lengthSelect.length) {
                            var current = slaTable.page.len();
                            var input = $('<input/>', {
                                type: 'number',
                                min: 1,
                                step: 1,
                                value: current,
                                class: 'form-control form-control-sm d-inline-block',
                                style: 'width:80px; margin-left:8px;'
                            });
                            lengthSelect.replaceWith(input);
                            input.off('change.sla').on('change.sla', function() {
                                var v = parseInt($(this).val(), 10);
                                if (isNaN(v) || v < 1) v = slaTable.page.len();
                                slaTable.page.len(v);
                                slaTable.page(0).draw(false);
                            });
                        } else {
                            if(!left.find('.dataTables_length').length){
                                var current = slaTable.page.len();
                                var input = $('<input/>', {
                                    type: 'number',
                                    min: 1,
                                    step: 1,
                                    value: current,
                                    class: 'form-control form-control-sm d-inline-block',
                                    style: 'width:80px; margin-left:8px;'
                                });
                                var lengthWrapper = $('<div class="dataTables_length"><label>{% trans "Show" %} </label></div>');
                                lengthWrapper.find('label').append(input);
                                left.prepend(lengthWrapper);
                                input.off('change.sla').on('change.sla', function() {
                                    var v = parseInt($(this).val(), 10);
                                    if (isNaN(v) || v < 1) v = slaTable.page.len();
                                    slaTable.page.len(v);
                                    slaTable.page(0).draw(false);
                                });
                            }
                        }
                        // Ensure info exists and update its text
                        if(!left.find('.dataTables_info').length){
                            var info = $('<div class="dataTables_info ml-2 text-muted small"></div>');
                            left.append(info);
                        }
                        var infoObj = slaTable.page.info();
                        var infoText = '{% trans "Showing" %} ' + (infoObj.start+1) + ' {% trans "to" %} ' + infoObj.end + ' {% trans "of" %} ' + infoObj.recordsTotal + ' {% trans "entries" %}';
                        left.find('.dataTables_info').text(infoText);
                    } catch (e) {
                        console.warn('Could not replace length select on redraw', e);
                    }
                }
            });

            // Wire persistent controls
            try {
                var pageSizeInput = $('#slaPageSizeInput');
                var infoText = $('#slaInfoText');
                var paginatePlaceholder = $('#slaPaginatePlaceholder');

                // initialize values
                pageSizeInput.val(slaTable.page.len());
                var updateInfo = function(){
                    var info = slaTable.page.info();
                    infoText.text('{% trans "Showing" %} ' + (info.start+1) + ' {% trans "to" %} ' + info.end + ' {% trans "of" %} ' + info.recordsTotal + ' {% trans "entries" %}');
                };
                updateInfo();

                // handle input change
                pageSizeInput.off('change.sla input.sla').on('change.sla input.sla', function(){
                    var v = parseInt($(this).val(), 10);
                    if (isNaN(v) || v < 1) return;
                    slaTable.page.len(v);
                    slaTable.page(0).draw(false);
                });

                // place DataTables pagination into our placeholder if available
                var movePaginate = function(){
                    var pag = $('.dataTables_paginate');
                    if(pag.length){
                        paginatePlaceholder.empty().append(pag);
                    } else {
                        // fallback simple controls
                        var p = $('<div class="btn-group" role="group"></div>');
                        var prev = $('<button class="btn btn-light btn-sm">&laquo; Prev</button>');
                        var next = $('<button class="btn btn-light btn-sm">Next &raquo;</button>');
                        prev.on('click', function(){ slaTable.page('previous').draw(false); });
                        next.on('click', function(){ slaTable.page('next').draw(false); });
                        p.empty().append(prev).append(next);
                        paginatePlaceholder.empty().append(p);
                    }
                };

                // Update on draw
                slaTable.on('draw', function(){
                    pageSizeInput.val(slaTable.page.len());
                    updateInfo();
                    movePaginate();
                });

                // run once to position pagination
                movePaginate();
            } catch (e) {
                console.warn('Could not wire persistent SLA controls', e);
            }
        });
    };
    tryInit();
})();
</script>

{% endblock %}

