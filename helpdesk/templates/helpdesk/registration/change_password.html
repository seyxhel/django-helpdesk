{% extends 'helpdesk/base.html' %}
{% load i18n %}

{# Use the full site navigation header on this page #}
{% block header %}{% include 'helpdesk/navigation-header.html' %}{% endblock %}

{# Remove breadcrumb for this page (we're using the full navigation header) #}
{% block helpdesk_breadcrumb %}{% endblock %}

{% block helpdesk_head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;600&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<style>
    /* hide the breadcrumb wrapper for this page */
    ol.breadcrumb { display: none !important; }

    /* Reset-card layout styles (copied from password_reset.html for parity) */
    :root { --input-padding-x: 0.75rem; --input-padding-y: 0.75rem; }
    .reset-wrapper { padding: 40px 20px; display:flex; align-items:center; justify-content:center; }
    .reset-card { width: 540px; max-width:94%; padding: 28px; border-radius: 12px; background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.06); border: 1px solid #e0e0e0; }
    .reset-card h1 { margin: 0 0 6px 0; font-size: 20px; font-family: 'Montserrat', sans-serif; }
    .reset-card p { margin: 0 0 16px 0; color: #444; font-family: 'Roboto', sans-serif; font-size:13px; }

    .form-control { width: 100%; padding: 12px 14px; border-radius: 8px; border: 1px solid #ccc; font-size:13px; line-height:1.4; }
    .form-label { display:block; margin-bottom:8px; font-size:13px; color:#333; font-family: 'Roboto', sans-serif; }

    .reset-actions { display:flex; flex-direction:row; gap:12px; margin-top: 14px; align-items:center; justify-content:center; width:100%; }
    .btn-primary {
        min-width: 160px;
        padding: 8px 12px;
        border-radius: 12px;
        background-color: #000C7D;
        color: #ffffff;
        border: 1px solid #000C7D;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
    }
    .btn-primary:hover { background-color: #08104f; border-color: #08104f; }

    .btn-secondary {
        min-width: 140px;
        padding: 8px 12px;
        border-radius: 12px;
        background: #ffffff;
        border: 1px solid #9c9c9c;
        color: #333;
        text-align: center;
        display: inline-block;
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
    }

    .helper-note { font-size: 13px; color: #666; margin-top: 10px; font-family: 'Roboto', sans-serif; }
    .field-error { color: #c62828; font-size: 12px; margin-top: 6px; display: inline-flex; align-items: center; gap: 6px; }
    /* remove leading warning icon */
    .field-error::before { content: none; }
    /* remove Bootstrap's background icon for invalid inputs and keep simple red border */
    input.is-invalid, textarea.is-invalid {
        border-color: #c62828 !important;
        box-shadow: none !important;
        background-image: none !important;
        background-position: initial !important;
        background-size: initial !important;
        padding-left: .75rem !important;
        padding-right: .75rem !important;
    }
    /* hide browser-native password reveal / credentials icons where possible */
    input[type="password"]::-ms-reveal,
    input[type="password"]::-ms-clear {
        display: none !important;
    }
    /* Blink/WebKit-based browsers - best-effort selectors */
    input[type="password"]::-webkit-credentials-auto-fill-button,
    input[type="password"]::-webkit-contacts-autocomplete-button,
    input[type="password"]::-webkit-textfield-decoration-container {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
        opacity: 0 !important;
    }
    /* Remove built-in appearance that may show native icons */
    input[type="password"] {
        -webkit-appearance: none !important;
        appearance: none !important;
    }

    /* Typographic rules for this page */
    body, .reset-card, .form-group, .form-text { font-family: 'Roboto', sans-serif; font-size: 13px; }

    /* Buttons fallback font */
    .btn { font-family: 'Poppins', sans-serif; }

    @media (max-width: 480px) {
        .reset-actions { flex-direction: column; }
        .btn-primary, .btn-secondary { width: 90% !important; display: block; }
    }
        /* Floating label wrapper and toggle-eye styling (professional) */
            .form-label-group { position: relative; }
            /* Ensure input text/placeholder doesn't collide with the eye icon */
            .form-label-group > input {
                padding-right: 44px; /* room for the toggle icon */
                padding-left: 14px;
                height: 44px;
                box-sizing: border-box;
            }
            .form-label-group > label {
                position: absolute; left: 14px; pointer-events: none;
                top: 50%; transform: translateY(-50%);
                transition: transform 120ms ease, font-size 120ms ease, top 120ms ease;
                color: #6b7280; font-size: 13px;
            }
            .form-label-group > input::placeholder { color: transparent; }
            .form-label-group > input:focus + label,
            .form-label-group > input:not(:placeholder-shown) + label {
                transform: translateY(-135%);
                font-size: 12px;
                color: #374151;
            }
            .toggle-eye {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
            background: transparent;
            border: none;
            padding: 6px;
            color: #4b5563;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        .toggle-eye:focus { outline: none; box-shadow: 0 0 0 4px rgba(11,87,208,0.12); }
        .toggle-eye svg { display: block; width: 18px; height: 18px; }
        .eye-open { opacity: 0; transition: opacity 120ms ease; }
        .eye-closed { opacity: 1; transition: opacity 120ms ease; }
        .toggle-eye[aria-pressed="true"] .eye-open { opacity: 1; }
        .toggle-eye[aria-pressed="true"] .eye-closed { opacity: 0; }
</style>
{% endblock %}

{% block helpdesk_title %}{% trans "Change password" %}{% endblock %}

{% block helpdesk_body %}

    <div class="reset-wrapper">
        <div class="reset-card">
            <h1>{% trans "Change your password" %}</h1>

            <form method="post" novalidate>
                {% csrf_token %}

                {# non-field errors #}
                {% if form.non_field_errors %}
                    {% for err in form.non_field_errors %}
                        <div class="field-error" aria-live="polite">{{ err }}</div>
                    {% endfor %}
                {% endif %}

                        <div class="form-group">
                            <label class="form-label" for="{{ form.old_password.id_for_label }}">{% trans "Current password" %}</label>
                            <div class="password-wrapper" style="position:relative;">
                                {{ form.old_password }}
                                                                <button type="button" class="toggle-eye" aria-label="Toggle password visibility" data-target="{{ form.old_password.id_for_label }}" aria-pressed="false">
                                        <svg class="eye-svg" viewBox="0 0 24 24" width="22" height="22" aria-hidden="true" focusable="false">
                                            <!-- open eye path -->
                                            <g class="eye-open" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M1.5 12s4-6.5 10.5-6.5S22.5 12 22.5 12s-4 6.5-10.5 6.5S1.5 12 1.5 12z" />
                                                <circle class="iris" cx="12" cy="12" r="3" fill="currentColor" />
                                            </g>
                                            <!-- closed eye (simple curved line) -->
                                            <g class="eye-closed" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M3 12c3.5-3 7-3 9-3s5.5 0 9 3" />
                                            </g>
                                        </svg>
                                                                </button>
                            </div>
                            {% if form.old_password.errors %}
                                {% for err in form.old_password.errors %}
                                    {% if err == "This field is required." %}
                                        <div class="field-error" aria-live="polite">{% trans "Please fill in the required field." %}</div>
                                    {% elif err == "Your old password was entered incorrectly. Please enter it again." %}
                                        <div class="field-error" aria-live="polite">{% trans "Invalid Password." %}</div>
                                    {% else %}
                                        <div class="field-error" aria-live="polite">{{ err }}</div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            <div id="{{ form.old_password.id_for_label }}-client-error" class="field-error" aria-live="polite"></div>
                        </div>

                                                <div class="form-group">
                                                        <label class="form-label" for="{{ form.new_password1.id_for_label }}">{% trans "New password" %}</label>
                                                        <div class="password-wrapper" style="position:relative;">
                                                                {{ form.new_password1 }}
                                                                <button type="button" class="toggle-eye" aria-label="Toggle password visibility" data-target="{{ form.new_password1.id_for_label }}" aria-pressed="false">
                                            <svg class="eye-svg" viewBox="0 0 24 24" width="22" height="22" aria-hidden="true" focusable="false">
                                                <!-- open eye path -->
                                                <g class="eye-open" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M1.5 12s4-6.5 10.5-6.5S22.5 12 22.5 12s-4 6.5-10.5 6.5S1.5 12 1.5 12z" />
                                                    <circle class="iris" cx="12" cy="12" r="3" fill="currentColor" />
                                                </g>
                                                <!-- closed eye (simple curved line) -->
                                                <g class="eye-closed" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M3 12c3.5-3 7-3 9-3s5.5 0 9 3" />
                                                </g>
                                            </svg>
                                                                </button>
                                                        </div>
                                                        {# helper-note intentionally removed so validator messages are shown as errors only #}
                                                        {% if form.new_password1.errors %}
                                                                {% for err in form.new_password1.errors %}
                                                                        {% if err == "This field is required." %}
                                                                                <div class="field-error" aria-live="polite">{% trans "Please fill in the required field." %}</div>
                                                                        {% else %}
                                                                                <div class="field-error" aria-live="polite">{{ err }}</div>
                                                                        {% endif %}
                                                                {% endfor %}
                                                        {% endif %}
                                                        <div id="{{ form.new_password1.id_for_label }}-client-error" class="field-error" aria-live="polite"></div>
                                                </div>

                                                <div class="form-group">
                                                        <label class="form-label" for="{{ form.new_password2.id_for_label }}">{% trans "Confirm new password" %}</label>
                                                        <div class="password-wrapper" style="position:relative;">
                                                                {{ form.new_password2 }}
                                                                <button type="button" class="toggle-eye" aria-label="Toggle password visibility" data-target="{{ form.new_password2.id_for_label }}" aria-pressed="false">
                                            <svg class="eye-svg" viewBox="0 0 24 24" width="22" height="22" aria-hidden="true" focusable="false">
                                                <!-- open eye path -->
                                                <g class="eye-open" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M1.5 12s4-6.5 10.5-6.5S22.5 12 22.5 12s-4 6.5-10.5 6.5S1.5 12 1.5 12z" />
                                                    <circle class="iris" cx="12" cy="12" r="3" fill="currentColor" />
                                                </g>
                                                <!-- closed eye (simple curved line) -->
                                                <g class="eye-closed" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M3 12c3.5-3 7-3 9-3s5.5 0 9 3" />
                                                </g>
                                            </svg>
                                                                </button>
                                                        </div>
                                                        {% if form.new_password2.errors %}
                                                            {% for err in form.new_password2.errors %}
                                                                {% if err == "This field is required." %}
                                                                    <div class="field-error" aria-live="polite">{% trans "Please fill in the required field." %}</div>
                                                                {% elif err == "The two password fields didn't match." or err == "The two password fields didn’t match." %}
                                                                    <div class="field-error" aria-live="polite">{% trans "Passwords do not match." %}</div>
                                                                {% else %}
                                                                    <div class="field-error" aria-live="polite">{{ err }}</div>
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% endif %}
                                                        <div id="{{ form.new_password2.id_for_label }}-client-error" class="field-error" aria-live="polite"></div>
                                                </div>

                <div class="reset-actions">
                    <a class="btn-secondary" href="http://127.0.0.1:8000/tickets/my-tickets/">{% trans "Cancel" %}</a>
                    <button type="submit" class="btn-primary" style="background-color:#000C7D; border-color:#000C7D; color:#ffffff;">{% trans "Save Password" %}</button>
                </div>
            </form>

            <!-- Success overlay (hidden by default). Shown when URL ?changed=1 -->
            <div id="pw-success-overlay" aria-hidden="true" style="display:none; position:fixed; inset:0; z-index:1200; align-items:center; justify-content:center;">
                <div id="pw-success-backdrop" style="background: rgba(0,0,0,0.4); position:absolute; inset:0;"></div>
                <div style="position:relative; z-index:1201; display:flex; align-items:center; justify-content:center;">
                    <div id="pw-success-card" role="status" aria-live="polite" style="width:420px; max-width:94vw; background:#fff; border-radius:12px; padding:28px; box-shadow:0 10px 40px rgba(0,0,0,0.2); text-align:center; transition: transform 250ms ease, opacity 250ms ease;">
                        <!-- animated check circle -->
                        <svg width="84" height="84" viewBox="0 0 120 120" style="display:block;margin:0 auto 12px auto;">
                            <circle cx="60" cy="60" r="48" stroke="#0f9d58" stroke-width="6" fill="none" stroke-dasharray="302" stroke-dashoffset="302">
                                <animate id="pw-circle-anim" attributeName="stroke-dashoffset" from="302" to="0" dur="0.45s" fill="freeze" />
                            </circle>
                            <path id="pw-check" d="M40 62 L54 76 L82 46" stroke="#0f9d58" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0">
                                <animate attributeName="opacity" from="0" to="1" begin="0.4s" dur="0.15s" fill="freeze" />
                            </path>
                        </svg>
                        <h2 style="margin:0 0 8px 0; font-size:20px;">{% trans "Success" %}</h2>
                        <p id="pw-success-text" style="margin:0; color:#444;">{% trans "Password updated." %}</p>
                    </div>
                </div>
            </div>

            <script>
            (function(){
                function showPwSuccess() {
                    var overlay = document.getElementById('pw-success-overlay');
                    var card = document.getElementById('pw-success-card');
                    if(!overlay || !card) return;
                    overlay.style.display = 'flex';
                    overlay.setAttribute('aria-hidden','false');
                    // animate in
                    card.style.transform = 'translateY(-6px)';
                    card.style.opacity = '1';
                    // after 2400ms hide it
                    setTimeout(function(){
                        card.style.transform = 'translateY(0)';
                        card.style.opacity = '0';
                        overlay.setAttribute('aria-hidden','true');
                        // small delay to allow transition
                        setTimeout(function(){ overlay.style.display = 'none'; }, 260);
                    }, 2400);
                }

                function removeQueryParam(param) {
                    try {
                        var url = new URL(window.location.href);
                        url.searchParams.delete(param);
                        window.history.replaceState({}, document.title, url.pathname + url.search + url.hash);
                    } catch (e) {
                        // ignore
                    }
                }

                document.addEventListener('DOMContentLoaded', function(){
                    try {
                        var params = new URLSearchParams(window.location.search);
                        if (params.get('changed') === '1') {
                            // show overlay and then remove the query param so it won't reappear on refresh
                            showPwSuccess();
                            removeQueryParam('changed');
                        }
                    } catch (e) {
                        // old browsers: try naive check
                        if (window.location.search && window.location.search.indexOf('changed=1') !== -1) {
                            showPwSuccess();
                            // attempt naive URL clean
                            var cleaned = window.location.href.replace(/[?&]changed=1(&|$)/, function(m, p1){ return p1 === '&' ? '?' : ''; }).replace(/\?$/,'');
                            window.history.replaceState({}, document.title, cleaned);
                        }
                    }
                });
            })();
            </script>

        </div>
    </div>

{% endblock helpdesk_body %}

    {% block helpdesk_js %}
    <script>
        (function(){
            // Ensure inputs have form-control class (do not add placeholders for new-password fields)
            ['{{ form.new_password1.id_for_label }}','{{ form.new_password2.id_for_label }}'].forEach(function(id){
                try{
                    var el = document.getElementById(id);
                    if(el){
                        if(!el.classList.contains('form-control')) el.classList.add('form-control');
                        // intentionally do not set placeholder for new password fields per request
                    }
                }catch(e){}
            });

            // Ensure the old password input has no placeholder and uses form-control styling
            try{
                var oldEl = document.getElementById('{{ form.old_password.id_for_label }}');
                if(oldEl){
                    if(!oldEl.classList.contains('form-control')) oldEl.classList.add('form-control');
                    if(oldEl.getAttribute('placeholder')) oldEl.removeAttribute('placeholder');
                }
            }catch(e){}

            // Toggle-eye behavior (show/hide password)
            document.querySelectorAll('.toggle-eye').forEach(function(btn){
                btn.addEventListener('click', function(){
                    var targetId = btn.getAttribute('data-target');
                    var input = document.getElementById(targetId);
                    if(!input) return;
                    var isPressed = btn.getAttribute('aria-pressed') === 'true';
                    if(isPressed){
                        input.type = 'password';
                        btn.setAttribute('aria-pressed','false');
                    } else {
                        input.type = 'text';
                        btn.setAttribute('aria-pressed','true');
                    }
                });
            });

            // Progressive client-side validation for new passwords (adapted from register.html)
            (function(){
                var form = document.querySelector('.reset-card form');
                var oldId = '{{ form.old_password.id_for_label }}';
                var id1 = '{{ form.new_password1.id_for_label }}';
                var id2 = '{{ form.new_password2.id_for_label }}';
                var oldEl = document.getElementById(oldId);
                var pwd1 = document.getElementById(id1);
                var pwd2 = document.getElementById(id2);
                var errOld = document.getElementById(oldId + '-client-error');
                var err1 = document.getElementById(id1 + '-client-error');
                var err2 = document.getElementById(id2 + '-client-error');
                var submitBtn = document.querySelector('.reset-actions button[type=submit]');

                var touched = {};
                touched[oldId] = false; touched[id1] = false; touched[id2] = false;
                var submitted = false;

                function showError(el, box, msg){
                    if(!box) return;
                    box.textContent = msg;
                    box.style.visibility = 'visible';
                    if(el) el.classList.add('is-invalid');
                }
                function clearError(el, box){
                    if(!box) return;
                    box.textContent = '';
                    box.style.visibility = 'hidden';
                    if(el) el.classList.remove('is-invalid');
                }

                function setNewDisabled(state){
                    try { if(pwd1) pwd1.disabled = state; } catch(e){}
                    try { if(pwd1) { if(state) pwd1.classList.add('disabled'); else pwd1.classList.remove('disabled'); } } catch(e){}
                }
                function setConfirmDisabled(state){
                    try { if(pwd2) pwd2.disabled = state; } catch(e){}
                    try { if(pwd2) { if(state) pwd2.classList.add('disabled'); else pwd2.classList.remove('disabled'); } } catch(e){}
                }

                function validate(){
                    var vold = oldEl ? oldEl.value || '' : '';
                    var v1 = pwd1 ? pwd1.value || '' : '';
                    var v2 = pwd2 ? pwd2.value || '' : '';
                    var ok = true;

                    // old password: only show required when touched or after submit
                    if(!vold){
                        if(touched[oldId] || submitted){
                            showError(oldEl, errOld, 'Please fill in the required field.');
                        } else {
                            clearError(oldEl, errOld);
                        }
                        ok = false;
                        // disable new and confirm password fields until the current password is entered
                        setNewDisabled(true);
                        setConfirmDisabled(true);
                    } else {
                        clearError(oldEl, errOld);
                        // enable new password fields once current password has a value
                        setNewDisabled(false);
                        // enable confirm only if new password has content
                        setConfirmDisabled(!v1);
                    }

                    // new password 1: complexity and required
                    if(!v1){
                        if(touched[id1] || submitted){
                            showError(pwd1, err1, 'Please fill in the required field.');
                        } else {
                            clearError(pwd1, err1);
                        }
                        ok = false;
                        // ensure confirm stays disabled until new password entered
                        setConfirmDisabled(true);
                    } else {
                        var parts = [];
                        if(v1.length < 8) parts.push('Password must be at least 8 characters');
                        var missing = [];
                        if(!/[A-Z]/.test(v1)) missing.push('uppercase');
                        if(!/[a-z]/.test(v1)) missing.push('lowercase');
                        if(!/[0-9]/.test(v1)) missing.push('number');
                        if(!/[^A-Za-z0-9\s.\'\-]/.test(v1)) missing.push('special character');
                        if(parts.length === 0 && missing.length === 0){
                            clearError(pwd1, err1);
                        } else {
                            ok = false;
                            var missingMsg = '';
                            if(missing.length) missingMsg = missing.length === 1 ? missing[0] : (missing.slice(0, -1).join(', ') + ' and ' + missing[missing.length -1]);
                            var msg = '';
                            if(parts.length){
                                msg = parts[0];
                                if(missingMsg) msg = msg + ' and must contain ' + missingMsg;
                            } else {
                                msg = 'Password must contain ' + missingMsg;
                            }
                            showError(pwd1, err1, msg);
                        }
                    }

                    // new password 2: confirm required only when touched or after submit
                    if(!v2){
                        if(touched[id2] || submitted){
                            showError(pwd2, err2, 'Please fill in the required field.');
                        } else {
                            clearError(pwd2, err2);
                        }
                        ok = false;
                    } else {
                        clearError(pwd2, err2);
                    }

                    if(v1 && v2 && v1 !== v2){
                        showError(pwd2, err2, 'Password did not match.');
                        ok = false;
                    }

                    if(submitBtn){
                        submitBtn.disabled = !ok;
                        submitBtn.setAttribute('aria-disabled', (!ok).toString());
                    }
                    return ok;
                }

                function markTouched(id){ touched[id] = true; validate(); }

                [oldEl, pwd1, pwd2].forEach(function(el){
                    if(!el) return;
                    el.addEventListener('blur', function(){ markTouched(el.id); });
                    el.addEventListener('input', function(){ validate(); });
                });

                if(form){
                    form.addEventListener('submit', function(e){
                        submitted = true;
                        touched[oldId] = touched[id1] = touched[id2] = true;
                        var ok = validate();
                        if(!ok){
                            // let the disabled state and shown errors prevent accidental submits
                        }
                    });
                }

                // initial run
                validate();
            })();
        })();
    </script>
    {% endblock %}
