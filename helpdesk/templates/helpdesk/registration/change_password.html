{% extends "helpdesk/base.html" %}{% load i18n %}

{# Use the full site navigation header on this page #}
{% block header %}{% include 'helpdesk/navigation-header.html' %}{% endblock %}

{# Remove breadcrumb for this page (we're using the full navigation header) #}
{% block helpdesk_breadcrumb %}{% endblock %}

{% block helpdesk_head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;600&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<style>
    /* hide the breadcrumb wrapper for this page */
    ol.breadcrumb { display: none !important; }

    /* Reset-card layout styles (copied from password_reset.html for parity) */
    :root { --input-padding-x: 0.75rem; --input-padding-y: 0.75rem; }
    .reset-wrapper { padding: 40px 20px; display:flex; align-items:center; justify-content:center; }
    .reset-card { width: 540px; max-width:94%; padding: 28px; border-radius: 12px; background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.06); border: 1px solid #e0e0e0; }
    .reset-card h1 { margin: 0 0 6px 0; font-size: 20px; font-family: 'Montserrat', sans-serif; }
    .reset-card p { margin: 0 0 16px 0; color: #444; font-family: 'Roboto', sans-serif; font-size:13px; }

    .form-control { width: 100%; padding: 12px 14px; border-radius: 8px; border: 1px solid #ccc; font-size:13px; line-height:1.4; }
    .form-label { display:block; margin-bottom:8px; font-size:13px; color:#333; font-family: 'Roboto', sans-serif; }

    .reset-actions { display:flex; flex-direction:row; gap:12px; margin-top: 14px; align-items:center; justify-content:center; width:100%; }
    .btn-primary {
        min-width: 160px;
        padding: 8px 12px;
        border-radius: 12px;
        background-color: #000C7D;
        color: #ffffff;
        border: 1px solid #000C7D;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
    }
    .btn-primary:hover { background-color: #08104f; border-color: #08104f; }

    .btn-secondary {
        min-width: 140px;
        padding: 8px 12px;
        border-radius: 12px;
        background: #ffffff;
        border: 1px solid #9c9c9c;
        color: #333;
        text-align: center;
        display: inline-block;
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
    }

    .helper-note { font-size: 13px; color: #666; margin-top: 10px; font-family: 'Roboto', sans-serif; }
    .field-error { color: #c62828; font-size: 12px; margin-top: 6px; display: inline-flex; align-items: center; gap: 6px; }
    .field-error::before { content: "\26A0"; font-size: 13px; line-height: 1; color: #c62828; }
    input.is-invalid, textarea.is-invalid { border-color: #c62828 !important; box-shadow: none !important; }

    /* Typographic rules for this page */
    body, .reset-card, .form-group, .form-text { font-family: 'Roboto', sans-serif; font-size: 13px; }

    /* Buttons fallback font */
    .btn { font-family: 'Poppins', sans-serif; }

    @media (max-width: 480px) {
        .reset-actions { flex-direction: column; }
        .btn-primary, .btn-secondary { width: 90% !important; display: block; }
    }
        /* Floating label wrapper and toggle-eye styling (professional) */
            .form-label-group { position: relative; }
            /* Ensure input text/placeholder doesn't collide with the eye icon */
            .form-label-group > input {
                padding-right: 44px; /* room for the toggle icon */
                padding-left: 14px;
                height: 44px;
                box-sizing: border-box;
            }
            .form-label-group > label {
                position: absolute; left: 14px; pointer-events: none;
                top: 50%; transform: translateY(-50%);
                transition: transform 120ms ease, font-size 120ms ease, top 120ms ease;
                color: #6b7280; font-size: 13px;
            }
            .form-label-group > input::placeholder { color: transparent; }
            .form-label-group > input:focus + label,
            .form-label-group > input:not(:placeholder-shown) + label {
                transform: translateY(-135%);
                font-size: 12px;
                color: #374151;
            }
            .toggle-eye {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
            background: transparent;
            border: none;
            padding: 6px;
            color: #4b5563;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        .toggle-eye:focus { outline: none; box-shadow: 0 0 0 4px rgba(11,87,208,0.12); }
        .toggle-eye svg { display: block; width: 18px; height: 18px; }
        .eye-open { opacity: 0; transition: opacity 120ms ease; }
        .eye-closed { opacity: 1; transition: opacity 120ms ease; }
        .toggle-eye[aria-pressed="true"] .eye-open { opacity: 1; }
        .toggle-eye[aria-pressed="true"] .eye-closed { opacity: 0; }
</style>
{% endblock %}

{% block helpdesk_title %}{% trans "Change password" %}{% endblock %}

{% block helpdesk_body %}

    <div class="reset-wrapper">
        <div class="reset-card">
            <h1>{% trans "Change your password" %}</h1>
            <p>{% trans "Enter your current password and choose a new password. We'll update your account immediately." %}</p>

            <form method="post" novalidate>
                {% csrf_token %}

                {# non-field errors #}
                {% if form.non_field_errors %}
                    {% for err in form.non_field_errors %}
                        <div class="field-error" aria-live="polite">{{ err }}</div>
                    {% endfor %}
                {% endif %}

                        <div class="form-group">
                            <label class="form-label" for="{{ form.old_password.id_for_label }}">{% trans "enter your old password:" %}</label>
                            <div class="password-wrapper" style="position:relative;">
                                {{ form.old_password }}
                                <button type="button" class="toggle-eye" aria-label="Toggle password visibility" data-target="{{ form.old_password.id_for_label }}" aria-pressed="false">
                                    <svg class="eye-svg" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                                        <g class="eye-open" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" />
                                            <circle cx="12" cy="12" r="3" fill="currentColor" />
                                        </g>
                                        <g class="eye-closed" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M3 3l18 18" />
                                        </g>
                                    </svg>
                                </button>
                            </div>
                            {% if form.old_password.errors %}
                                {% for err in form.old_password.errors %}
                                    <div class="field-error" aria-live="polite">{{ err }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <div class="form-label-group">
                                {{ form.new_password1 }}
                                <label for="{{ form.new_password1.id_for_label }}">{% trans "New password" %}</label>
                                            <button type="button" class="toggle-eye" aria-label="Toggle password visibility" data-target="{{ form.new_password1.id_for_label }}" aria-pressed="false">
                                                <svg class="eye-svg" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                                                    <g class="eye-open" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" />
                                                        <circle cx="12" cy="12" r="3" fill="currentColor" />
                                                    </g>
                                                    <g class="eye-closed" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M3 3l18 18" />
                                                    </g>
                                                </svg>
                                            </button>
                            </div>
                            {% if form.new_password1.help_text %}<div class="helper-note">{{ form.new_password1.help_text|safe }}</div>{% endif %}
                            {% if form.new_password1.errors %}
                                {% for err in form.new_password1.errors %}
                                    <div class="field-error" aria-live="polite">{{ err }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <div class="form-label-group">
                                {{ form.new_password2 }}
                                <label for="{{ form.new_password2.id_for_label }}">{% trans "Confirm new password" %}</label>
                                            <button type="button" class="toggle-eye" aria-label="Toggle password visibility" data-target="{{ form.new_password2.id_for_label }}" aria-pressed="false">
                                                <svg class="eye-svg" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                                                    <g class="eye-open" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" />
                                                        <circle cx="12" cy="12" r="3" fill="currentColor" />
                                                    </g>
                                                    <g class="eye-closed" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M3 3l18 18" />
                                                    </g>
                                                </svg>
                                            </button>
                            </div>
                            {% if form.new_password2.errors %}
                                {% for err in form.new_password2.errors %}
                                    <div class="field-error" aria-live="polite">{{ err }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>

                <div class="reset-actions">
                    <a href="{% url 'helpdesk:user_settings' %}" class="btn-secondary">{% trans "Back to settings" %}</a>
                    <button type="submit" class="btn-primary">{% trans "Change my password" %}</button>
                </div>
            </form>

        </div>
    </div>

{% endblock helpdesk_body %}

    {% block helpdesk_js %}
    <script>
        (function(){
            // Ensure inputs have placeholders and form-control class
            // Note: we intentionally skip adding a placeholder to the old_password field
            ['{{ form.new_password1.id_for_label }}','{{ form.new_password2.id_for_label }}'].forEach(function(id){
                try{
                    var el = document.getElementById(id);
                    if(el){
                        if(!el.classList.contains('form-control')) el.classList.add('form-control');
                        if(!el.getAttribute('placeholder')) el.setAttribute('placeholder',' ');
                    }
                }catch(e){}
            });

            // Ensure the old password input has no placeholder and uses form-control styling
            try{
                var oldEl = document.getElementById('{{ form.old_password.id_for_label }}');
                if(oldEl){
                    if(!oldEl.classList.contains('form-control')) oldEl.classList.add('form-control');
                    if(oldEl.getAttribute('placeholder')) oldEl.removeAttribute('placeholder');
                }
            }catch(e){}

            // Toggle-eye behavior (show/hide password)
            document.querySelectorAll('.toggle-eye').forEach(function(btn){
                btn.addEventListener('click', function(){
                    var targetId = btn.getAttribute('data-target');
                    var input = document.getElementById(targetId);
                    if(!input) return;
                    var isPressed = btn.getAttribute('aria-pressed') === 'true';
                    if(isPressed){
                        input.type = 'password';
                        btn.setAttribute('aria-pressed','false');
                    } else {
                        input.type = 'text';
                        btn.setAttribute('aria-pressed','true');
                    }
                });
            });
        })();
    </script>
    {% endblock %}
